

<!-- TOC -->

- [1. 服务降级](#1-服务降级)
    - [1.1. 服务降级](#11-服务降级)
        - [1.1.1. 服务降级简介](#111-服务降级简介)
        - [1.1.2. 服务降级设计](#112-服务降级设计)
            - [1.1.2.1. 分布式开关](#1121-分布式开关)
            - [1.1.2.2. 自动降级](#1122-自动降级)
            - [1.1.2.3. 配置中心](#1123-配置中心)
        - [1.1.3. 降级方式](#113-降级方式)
        - [1.1.4. 降级预案](#114-降级预案)
    - [1.2. 服务熔断和服务降级比较](#12-服务熔断和服务降级比较)

<!-- /TOC -->

![image](https://gitee.com/wt1814/pic-host/raw/master/images/microService/problems/problem-36.png)  

# 1. 服务降级
## 1.1. 服务降级  
### 1.1.1. 服务降级简介  
&emsp; 什么是服务降级？当服务器压力剧增的情况下，根据实际业务情况及流量，对一些服务和页面有策略的不处理或换种简单的方式处理，从而释放服务器资源以保证核心交易正常运作或高效运作。  
&emsp; **使用场景：** <font color = "red">当整个微服务架构整体的负载超出了预设的上限阈值或即将到来的流量预计将会超过预设的阈值时，为了保证重要或基本的服务能正常运行，可以将一些 不重要 或 不紧急 的服务或任务进行服务的 延迟使用 或 暂停使用。</font>  

### 1.1.2. 服务降级设计    
&emsp; <font color = "red">降级按照是否自动化可分为：自动开关降级和人工开关降级。</font>  

#### 1.1.2.1. 分布式开关  
&emsp; 可以设置一个分布式开关，用于实现服务的人工降级，然后集中式管理开关配置信息即可。具体方案如下：  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/microService/problems/problem-34.png)  

#### 1.1.2.2. 自动降级  
&emsp; <font color = "lime">自动降级分类：</font>  

* 超时降级：主要配置好超时时间和超时重试次数和机制，并使用异步机制探测回复情况。  
* 失败次数降级：主要是一些不稳定的api，当失败调用次数达到一定阀值自动降级，同样要使用异步机制探测回复情况。  
* 故障降级：比如要调用的远程服务挂掉了（网络故障、DNS故障、http服务返回错误的状态码、rpc服务抛出异常），则可以直接降级。降级后的处理方案有：默认值（比如库存服务挂了，返回默认现货）、兜底数据（比如广告挂了，返回提前准备好的一些静态页面）、缓存（之前暂存的一些缓存数据）。  
* 限流降级：秒杀场景中，可能会因为访问量太大而导致系统崩溃，此时开发者会使用限流来进行限制访问量，当达到限流阀值，后续请求会被降级；降级后的处理方案可以是：排队页面（将用户导流到排队页面等一会重试）、无货（直接告知用户没货了）、错误页（如活动太火爆了，稍后重试）。  

#### 1.1.2.3. 配置中心  
&emsp; 微服务降级的配置信息是集中式的管理，然后通过可视化界面进行友好型的操作。配置中心和应用之间需要网络通信，因此可能会因网络闪断或网络重启等因素，导致配置推送信息丢失、重启或网络恢复后不能再接受、变更不及时等等情况，因此服务降级的配置中心需要实现以下几点特性，从而尽可能的保证配置变更即使达到：    
![image](https://gitee.com/wt1814/pic-host/raw/master/images/microService/problems/problem-35.png)  

* 启动主动拉取配置 —— 用于初始化配置（减少第一次定时拉取周期）  
* 发布订阅配置 —— 用于实现配置及时变更（可以解决90%左右的配置变更）  
* 定时拉取配置 —— 用于解决发布订阅失效或消失丢失的情况（可以解决9%左右的发布订阅失效的消息变更）  
* 离线文件缓存配置 —— 用于临时解决重启后连接不上配置中心的问题  
* 可编辑式配置文档 —— 用于直接编辑文档的方式来实现配置的定义  
* 提供Telnet命令变更配置 —— 用于解决配置中心失效而不能变更配置的常见  

### 1.1.3. 降级方式  
&emsp; <font color = "red">降级处理可以采用多种方式：</font>  

* 延迟服务：比如发表了评论，重要服务，比如在文章中显示正常，但是延迟给用户增加积分，只是放到一个缓存中，等服务平稳之后再执行。  
* 在粒度范围内关闭服务（片段降级或服务功能降级）：比如关闭相关文章的推荐，直接关闭推荐区。  
* 页面异步请求降级：比如商品详情页上有推荐信息/配送至等异步加载的请求，如果这些信息响应慢或者后端服务有问题，可以进行降级。  
* 页面跳转（页面降级）：比如可以有相关文章推荐，但是更多的页面则直接跳转到某一个地址。  
* 写降级：比如秒杀抢购，可以只进行Cache的更新，然后异步同步扣减库存到DB，保证最终一致性即可，此时可以将DB降级为Cache。  
* 读降级：比如多级缓存模式，如果后端服务有问题，可以降级为只读缓存，这种方式适用于对读一致性要求不高的场景。  

### 1.1.4. 降级预案  
&emsp; <font color = "red">在进行降级之前要对系统进行梳理，梳理出可以降级的服务。</font>  
&emsp; 当微服务架构发生不同程度的情况时，可以根据服务的对比而进行选择式舍弃（即丢车保帅的原则），从而进一步保障核心的服务的正常运作。  
&emsp; 如果等线上服务即将发生故障时，才去逐个选择哪些服务该降级、哪些服务不能降级，然而线上有成百上千个服务，则肯定是来不及降级就会被拖垮。同时，在大促或秒杀等活动前才去梳理，也是会有不少的工作量，因此建议在开发期就需要架构师或核心开发人员来提前梳理好，是否能降级的初始评估值，即是否能降级的默认值。  
<!-- 为了便于批量操作微服务架构中服务的降级，可以从全局的角度来建立服务重要程度的评估模型，如果有条件的话，建议可以使用 层次分析法（The analytic hierarchy process，简称AHP） 的数学建模模型（或其它模型）来进行定性和定量的评估，而层次分析法的基本思路是人对一个复杂的决策问题的思维和判断过程大体上是一样的。  -->
&emsp; 可以参考日志级别设置预案：  

* 一般：比如有些服务偶尔因为网络抖动或者服务正在上线而超时，可以自动降级；  
* 警告：有些服务在一段时间内成功率有波动（如在95~100%之间），可以自动降级或人工降级，并发送告警；  
* 错误：比如可用率低于90%，或者数据库连接池被打爆了，或者访问量突然猛增到系统能承受的最大阀值，此时可以根据情况自动降级或者人工降级；  
* 严重错误：比如因为特殊原因数据错误了，此时需要紧急人工降级。  

## 1.2. 服务熔断和服务降级比较  
* 服务熔断和服务降级，两者其实从有些角度看是有一定的类似性的：  
    * 目的很一致，都是从可用性可靠性着想，为防止系统的整体缓慢甚至崩溃，采用的技术手段；
    * 最终表现类似，对于两者来说，最终让用户体验到的是某些功能暂时不可达或不可用；
    * 粒度一般都是服务级别，当然，业界也有不少更细粒度的做法，比如做到数据持久层（允许查询，不允许增删改）；
    * 自治性要求很高，熔断模式一般都是服务基于策略的自动触发，降级虽说可人工干预，但在微服务架构下，完全靠人显然不可能，开关预置、配置中心都是必要手段；

* 而两者的区别也是明显的：
    * 触发原因不太一样。<font color = "lime">服务熔断一般是某个服务（下游服务）故障引起；而服务降级一般是从整体负荷考虑。</font>
    * 管理目标的层次不太一样。熔断其实是一个框架级的处理，每个微服务都需要（无层级之分），而降级一般需要对业务有层级之分（比如降级一般是从最外围服务开始）。
    * 实现方式不太一样。

