
<!-- TOC -->

- [1. 分布式理论](#1-分布式理论)
    - [1.1. CAP理论](#11-cap理论)
        - [1.1.1. 数据一致性模型](#111-数据一致性模型)
    - [1.2. BASE理论](#12-base理论)
    - [1.3. 酸碱平衡](#13-酸碱平衡)

<!-- /TOC -->

# 1. 分布式理论  


## 1.1. CAP理论  
&emsp; CAP理论，指的是在一个分布式系统中，一致性（Consistency）、可用性（Availability）、分区容错性（Partition tolerance）。  

* 一致性：在分布式系统中的所有数据备份，在同一时刻是否同样的值。
* 可用性：在集群中一部分节点故障后，集群整体是否还能响应客户端的读写请求。
* 分区容错性：以实际效果而言，分区相当于对通信的时限要求。系统如果不能在时限内达成数据一致性，就意味着发生了分区的情况，必须就当前操作在C和A之间做出选择。

&emsp; CAP 原则中这三个要素最多只能同时实现两点，不可能三者兼顾。  

* ~~CA without P：如果不要求P（不允许分区），则C（强一致性）和A（可用性）是可以保证的。但其实分区不是想不想的问题，而是始终会存在，因此CA的系统更多的是允许分区后各子系统依然保持CA。注意：CA模型就是单机环境。~~  
* CP without A：如果不要求A（可用），相当于每个请求都需要在Server之间强一致，而P（分区）会导致同步时间无限延长，如此CP也是可以保证的。很多传统的数据库分布式事务都属于这种模式。  
* AP wihtout C：要高可用并允许分区，则需放弃一致性。一旦分区发生，节点之间可能会失去联系，为了高可用，每个节点只能用本地数据提供服务，而这样会导致全局数据的不一致性。现在众多的NoSQL都属于此类。   

&emsp; P分区容错性是一个最基本的要求，再根据业务 特点在C（一致性）和A（可用性）之间寻求平衡。  

### 1.1.1. 数据一致性模型  
<!-- 

https://blog.csdn.net/paincupid/article/details/80610441
-->

&emsp; 数据的一致性模型可以分成以下 3 类：  

* 强一致性：数据更新成功后，任意时刻所有副本中的数据都是一致的，一般采用同步的方式实现。    
* 单调一致性（monotonic consistency）。任何时刻，任何用户一旦读到某个数据在某次更新后的值，那么就不会再读到比这个值更旧的值。也就是说，可获取的数据顺序必是单调递增的。
* 会话一致性（session consistency）。任何用户在某次会话中，一旦读到某个数据在某次更新后的值，那么在本次会话中就不会再读到比这值更旧的值会话一致性是在单调一致性的基础上进一步放松约束，只保证单个用户单个会话内的单调性，在不同用户或同一用户不同会话间则没有保障。示例case：php的session概念。
* 弱一致性：数据更新成功后，系统不承诺立即可以读到最新写入的值，也不承诺具体多久之后可以读到。    
* 最终一致性：弱一致性的一种形式，数据更新成功后，系统不承诺立即可以返回最新写入的值，但是保证最终会返回上一次更新操作的值。  

&emsp; 分布式系统数据的强一致性、弱一致性和最终一致性可以通过Quorum NRW算法分析。  




## 1.2. BASE理论  
&emsp; BASE是Basically Available（基本可用）、Soft state（软状态）和Eventually consistent（最终一致性）三个短语的缩写。BASE理论是对CAP中一致性和可用性权衡的结果，其来源于对大规模互联网系统分布式实践的总结，是基于CAP定理逐步演化而来的。BASE和ACID是相反的，它完全不同于ACID的强一致性模型，而是通过牺牲强一致性来获得可用性，并允许数据在一段时间内是不一致的，但最终达到一致状态。  

* 基本可用（Basically Available）：指分布式系统在出现故障时，允许损失部分的可用性来保证核心可用。
* 软状态（Soft State）：指允许分布式系统存在中间状态，该中间状态不会影响到系统的整体可用性。
* 最终一致性（Eventual Consistency）：指分布式系统中的所有副本数据经过一定时间后，最终能够达到一致的状态。

## 1.3. 酸碱平衡  
&emsp; 化学理论中 ACID 是酸、Base 恰好是碱。分布式理论中，ACID能够保证事务的强一致性，即数据是实时一致的。这在本地事务中是没有问题的，在分布式事务中，强一致性会极大影响分布式系统的性能。分布式系统的不同业务场景对一致性的要求不同。如交易场景下，就要求强一致性，此时就需要遵循ACID理论，而在注册成功后发送短信验证码等场景下，并不需要实时一致，因此遵循BASE理论即可。因此在具体的分布式系统架构设计过程中，ACID特性和BASE理论往往又会结合在一起。  