---
title: 分布式事务-TCC
date: 2020-05-11 00:00:00
tags:
    - 分布式
---

<!-- TOC -->

- [1. TCC模式-强一致性](#1-tcc模式-强一致性)
    - [1.1. 实现流程](#11-实现流程)
    - [1.2. 特点](#12-特点)

<!-- /TOC -->

# 1. TCC模式-强一致性 

![image](https://gitee.com/wt1814/pic-host/raw/master/images/microService/problems/problem-9.png)  
&emsp; TCC是Try、Commit、Cancel的缩写。TCC是两阶段型、补偿型的事务。TCC采用的补偿机制，其逻辑模式类似于XA两阶段提交。其核心思想是：针对每个操作，都要注册一个与其对应的确认和补偿（撤销）操作。TCC模型是把锁的粒度完全交给业务处理。业务实现TCC服务之后，该TCC服务将作为分布式事务的其中一个资源，参与到整个分布式事务中；事务管理器分两阶段协调的TCC服务，第一阶段调用所有TCC服务的Try方法，在第二阶段执行所有TCC服务的Confirm或者Cancel方法。  

## 1.1. 实现流程  
* 条件：  

        需要实现确认和补偿逻辑
        需要支持幂等

1. Try阶段主要是对业务系统做检测及资源锁定或者预留。这个阶段主要完成：  
    1. 完成所有业务检查( 一致性 ) 。  
    2. 预留必须业务资源( 准隔离性 ) 。  
    3. Try尝试执行业务。
2. Confirm(确认)阶段主要是对业务系统做确认提交，不做业务检查。Try阶段执行成功并开始执行Confirm阶段时，默认 Confirm阶段是不会出错的。即：只要Try成功，Confirm一定成功。  
3. Cancel(取消)阶段主要是在业务执行错误，需要回滚的状态下，执行的业务取消，预留资源释放。  

&emsp; 示例：TCC模式下，A账户往B账户汇款100元为例子。汇款服务和收款服务分别需要实现，Try-Confirm-Cancel接口，并在业务初始化阶段将其注入到TCC事务管理器中。  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/microService/problems/problem-9.png)  

## 1.2. 特点  
* 优点：  
    * 性能提升：具体业务来实现控制资源锁的粒度变小，不会锁定整个资源。  
    * **<font color = "lime">数据最终一致性：基于Confirm和Cancel的幂等性，保证事务最终完成确认或者取消，保证数据的一致性。</font>**  
    * 可靠性：解决了XA协议的协调者单点故障问题，由主业务方发起并控制整个业务活动，业务活动管理器也变成多点，引入集群。  
* 缺点：  
    * TCC的Try、Confirm和Cancel操作功能要按具体业务来实现。  