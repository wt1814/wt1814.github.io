

<!-- TOC -->

- [1. Redis过期键删除策略](#1-redis过期键删除策略)
    - [1.1. Key生存期](#11-key生存期)
    - [1.2. 常见的删除策略](#12-常见的删除策略)
        - [1.2.1. 定时删除策略(主动淘汰)](#121-定时删除策略主动淘汰)
        - [1.2.2. 惰性删除策略(被动淘汰)](#122-惰性删除策略被动淘汰)
        - [1.2.3. 定期删除策略(主动淘汰)](#123-定期删除策略主动淘汰)
    - [1.3. Redis使用的过期键删除策略](#13-redis使用的过期键删除策略)

<!-- /TOC -->

&emsp; **<font color = "red">总结：</font>**  
1. 过期键常见的删除策略有3种：定时删除(主动)、惰性删除(被动)、定期删除(主动)。<font color = "red">Redis服务器使用的是惰性删除策略和定期删除策略。</font>  
    * 定时删除策略，在设置键的过期时间的同时，创建一个定时器，让定时器在键的过期时间来临时，立即执行对键的删除操作。  
    * <font color = "clime">惰性删除策略，只有当访问一个key时，才会判断该key是否已过期，过期则清除。</font>  
    * <font color = "red"> **定期删除策略，每隔一段时间执行一次删除过期键操作**</font>，并通过<font color = "clime">限制删除操作执行的时长和频率来减少删除操作对CPU时间的影响</font>，同时，通过定期删除过期键，也有效地减少了因为过期键而带来的内存浪费。  

# 1. Redis过期键删除策略
## 1.1. Key生存期  
&emsp; 在Redis当中，有生存期的key被称为volatile。在创建缓存时，要为给定的key设置生存期，当key过期的时候(生存期为0)，它可能会被删除。  
1. **影响生存时间的一些操作：**  
&emsp; 生存时间可以通过使用DEL命令来删除整个key从而进行移除，或者被SET和GETSET命令覆盖原来的数据。也就是说，修改key对应value和使用另外相同key和value来覆盖以后，当前数据的生存时间不同。  
&emsp; 比如说，对一个key执行INCR命令，对一个列表进行LPUSH命令，或者对一个哈希表执行HSET命令，这类操作都不会修改key 本身的生存时间。另一方面，如果使用RENAME对一个key进行改名，那么改名后的key的生存时间和改名前一样。  
&emsp; RENAME命令的另一种可能是，尝试将一个带生存时间的key改名成另一个带生存时间的another_key，这时旧的another_key（以及它的生存时间）会被删除，然后旧的key会改名为another_key，因此，新的another_key的生存时间也和原本的key一样。使用PERSIST命令可以在不删除key的情况下，移除key的生存时间，让key重新成为一个persistent key。  

2. **如何更新生存时间：**  
&emsp; 可以对一个已经带有生存时间的key执行EXPIRE命令，新指定的生存时间会取代旧的生存时间。过期时间的精度已经被控制在1ms之内，主键失效的时间复杂度是O(1)，EXPIRE和TTL命令搭配使用，TTL可以查看key的当前生存时间。设置成功返回1；当key不存在或者不能为key设置生存时间时，返回0。  

## 1.2. 常见的删除策略  
&emsp; **<font color = "red">常见的删除策略有3种：定时删除、惰性删除、定期删除。</font>**  

### 1.2.1. 定时删除策略(主动淘汰)  
&emsp; <font color = "red">在设置键的过期时间的同时，创建一个定时器，让定时器在键的过期时间来临时，立即执行对键的删除操作。</font>  

&emsp; 优点：对内存非常友好。  
&emsp; 缺点：对CPU时间非常不友好，会占用大量的CPU资源去处理过期的数据，从而影响缓存的响应时间和吞吐量。  

&emsp; 举个例子，如果有大量的命令请求等待服务器处理，并且服务器当前不缺少内存，如果服务器将大量的CPU时间用来删除过期键，那么服务器的响应时间和吞吐量就会受到影响。  
&emsp; 也就是说，如果服务器创建大量的定时器，服务器处理命令请求的性能就会降低，因此Redis目前并没有使用定时删除策略。  

### 1.2.2. 惰性删除策略(被动淘汰)  
&emsp; <font color = "clime">只有当访问一个key时，才会判断该key是否已过期，过期则清除。</font>  

&emsp; 优点：对CPU时间非常友好，可以最大化地节省 CPU 资源。  
&emsp; 缺点：<font color = "red">对内存非常不友好，极端情况可能出现大量的过期key没有再次被访问，从而不会被清除，占用大量内存。</font>  

&emsp; 举个例子，如果数据库有很多的过期键，而这些过期键又恰好一直没有被访问到，那这些过期键就会一直占用着宝贵的内存资源，造成资源浪费。  

### 1.2.3. 定期删除策略(主动淘汰)  
&emsp; 定期删除策略是定时删除策略和惰性删除策略的一种整合折中方案。  
&emsp; <font color = "red"> **定期删除策略每隔一段时间执行一次删除过期键操作**</font>，并通过<font color = "clime">限制删除操作执行的时长和频率来减少删除操作对CPU时间的影响</font>，同时，通过定期删除过期键，也有效地减少了因为过期键而带来的内存浪费。  

## 1.3. Redis使用的过期键删除策略  
&emsp; <font color = "red">Redis服务器使用的是惰性删除策略和定期删除策略。</font>  
