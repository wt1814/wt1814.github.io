
<!-- TOC -->

- [1. ~~消息积压(消费消息延迟)~~](#1-消息积压消费消息延迟)
    - [1.1. ~~大量消息在 mq 里积压了几个小时了还没解决~~](#11-大量消息在-mq-里积压了几个小时了还没解决)
    - [1.2. mq 中的消息过期失效了](#12-mq-中的消息过期失效了)
    - [1.3. mq 都快写满了](#13-mq-都快写满了)
    - [1.4. ***消息堆积](#14-消息堆积)

<!-- /TOC -->

# 1. ~~消息积压(消费消息延迟)~~ 
&emsp; **如何解决消息队列的延时以及过期失效问题？消息队列满了以后该怎么处理？有几百万消息持续积压几小时，说说怎么解决？**

&emsp; 你看这问法，其实本质针对的场景，都是说，可能你的消费端出了问题，不消费了；或者消费的速度极其慢。接着就坑爹了，可能你的消息队列集群的磁盘都快写满了，都没人消费，这个时候怎么办？或者是这整个就积压了几个小时，你这个时候怎么办？或者是你积压的时间太长了，导致比如 RabbitMQ 设置了消息过期时间后就没了怎么办？  

&emsp; 所以就这事儿，其实线上挺常见的，一般不出，一出就是大 case。一般常见于，举个例子，消费端每次消费之后要写 mysql，结果 mysql 挂了，消费端 hang 那儿了，不动了；或者是消费端出了个什么岔子，导致消费速度极其慢。  

## 1.1. ~~大量消息在 mq 里积压了几个小时了还没解决~~   
&emsp; 几千万条数据在 MQ 里积压了七八个小时，从下午 4 点多，积压到了晚上 11 点多。这个是我们真实遇到过的一个场景，确实是线上故障了，这个时候要不然就是修复 consumer 的问题，让它恢复消费速度，然后傻傻的等待几个小时消费完毕。这个肯定不能在面试的时候说吧。  

&emsp; 一个消费者一秒是1000条，一秒 3 个消费者是3000条，一分钟就是18万条。所以如果你积压了几百万到上千万的数据，即使消费者恢复了，也需要大概 1 小时的时间才能恢复过来。  

&emsp; **<font color = "clime">一般这个时候，只能临时紧急扩容了，具体操作步骤和思路如下：</font>**  
- 先修复 consumer 的问题，确保其恢复消费速度，然后将现有 consumer 都停掉。  
- 新建一个 topic，partition 是原来的 10 倍，临时建立好原先 10 倍的 queue 数量。  
- 然后写一个临时的分发数据的 consumer 程序，这个程序部署上去消费积压的数据，**消费之后不做耗时的处理**，直接均匀轮询写入临时建立好的10倍数量的 queue。  
- 接着临时征用 10 倍的机器来部署 consumer，每一批 consumer 消费一个临时 queue 的数据。这种做法相当于是临时将 queue 资源和consumer资源扩大 10 倍，以正常的 10 倍速度来消费数据。  
- 等快速消费完积压数据之后，**得恢复原先部署的架构**，**重新**用原先的 consumer 机器来消费消息。  

## 1.2. mq 中的消息过期失效了  
&emsp; 假设你用的是 RabbitMQ，RabbtiMQ 是可以设置过期时间的，也就是 TTL。如果消息在 queue 中积压超过一定的时间就会被 RabbitMQ 给清理掉，这个数据就没了。那这就是第二个坑了。这就不是说数据会大量积压在 mq 里，而是**大量的数据会直接搞丢**。  

&emsp; 这个情况下，就不是说要增加 consumer 消费积压的消息，因为实际上没啥积压，而是丢了大量的消息。我们可以采取一个方案，就是**批量重导**，这个我们之前线上也有类似的场景干过。就是大量积压的时候，我们当时就直接丢弃数据了，然后等过了高峰期以后，比如大家一起喝咖啡熬夜到晚上12点以后，用户都睡觉了。这个时候我们就开始写程序，将丢失的那批数据，写个临时程序，一点一点的查出来，然后重新灌入 mq 里面去，把白天丢的数据给他补回来。也只能是这样了。  

&emsp; 假设 1 万个订单积压在 mq 里面，没有处理，其中 1000 个订单都丢了，你只能手动写程序把那 1000 个订单给查出来，手动发到 mq 里去再补一次。  

## 1.3. mq 都快写满了  
&emsp; 如果消息积压在 mq 里，你很长时间都没有处理掉，此时导致 mq 都快写满了，咋办？这个还有别的办法吗？没有，谁让你第一个方案执行的太慢了，你临时写程序，接入数据来消费，**消费一个丢弃一个，都不要了**，快速消费掉所有的消息。然后走第二个方案，到了晚上再补数据吧。  


--------------

## 1.4. ***消息堆积
<!-- 
https://mp.weixin.qq.com/s/5C898scm8zgSJCXNdRQRsQ
-->
&emsp; 一般这种比较着急的问题，最好的办法就是临时扩容，用更快的速度来消费数据  

1. 临时建立一个新的Topic，然后调整queue的数量为原来的10倍或者20倍，根据堆积情况来决定。  
2. 然后写一个临时分发消息的consumer程序，这个程序部署上去消费积压的消息，消费的就是刚刚新建的Topic，消费之后不做耗时的处理，只需要直接均匀的轮询将这些消息轮询的写入到临时创建的queue里面即可。  
3. 然后增加相应倍数的机器来部署真正的consumer消费，注意这里的Topic，然后让这些consumer去真正的消费这些临时的queue里面的消息。  

&emsp; 不知道大家明白没有，很简单的道理，给大家举个形象的例子。  
&emsp; 一个topic堵住了，新建一个topic去进行分流，临时将queue资源和consumer资源扩大10倍，将消息平均分配到这些新增的queue资源和consumer资源上，以正常10倍的速度来消费消息，等到这些堆积的消息消费完了，便可以恢复到原来的部署架构。  
&emsp; 这种只是用于临时解决一些异常情况导致的消息堆积的处理，如果消息经常出现堵塞的情况，那该考虑一下彻底增强系统的部署架构了。  

