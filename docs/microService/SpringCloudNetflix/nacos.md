
<!-- TOC -->

- [1. nacos](#1-nacos)
    - [1.1. 介绍](#11-介绍)
    - [1.2. 使用教程](#12-使用教程)
    - [1.3. 宕机](#13-宕机)
        - [1.3.1. 注册中心集群全部宕机后正确的处理方式](#131-注册中心集群全部宕机后正确的处理方式)
            - [1.3.1.1. 新启动的服务下的异常](#1311-新启动的服务下的异常)
            - [1.3.1.2. 运行中的服务的异常](#1312-运行中的服务的异常)
            - [1.3.1.3. 运行中且重启过的服务](#1313-运行中且重启过的服务)
        - [1.3.2. 注册中心恢复中服务发现的异常](#132-注册中心恢复中服务发现的异常)
        - [1.3.3. Nacos本地缓存配置](#133-nacos本地缓存配置)

<!-- /TOC -->

# 1. nacos  
<!-- 

https://github.com/alibaba/nacos
*** https://nacos.io/zh-cn/docs/what-is-nacos.html


修改nacos启动时的占用内存
https://blog.csdn.net/weixin_48016395/article/details/124239230

-->

## 1.1. 介绍  

应用内/外：属于外部应用，侵入性小  
ACP原则：通知遵循CP原则（一致性+分离容忍） 和AP原则（可用性+分离容忍）  
版本迭代：目前仍然进行版本迭代  
集成支持：支持Dubbo 、SpringCloud、K8S集成  
访问协议：HTTP/动态DNS/UDP  
雪崩保护：支持雪崩保护  
界面：中文界面，符合国人习惯  
上手：极易，中文文档，案例，社区活跃  

## 1.2. 使用教程 

## 1.3. 宕机 


### 1.3.1. 注册中心集群全部宕机后正确的处理方式
<!-- 
注册中心集群全部宕机后正确的处理方式
https://blog.csdn.net/qq_46514118/article/details/121471593
-->
&emsp; 分3种场景来阐述注册中心宕机下服务的异常情况：    

* 新启动的服务下的异常  
* 运行中的服务的异常  
* 运行中且重启过的服务  

#### 1.3.1.1. 新启动的服务下的异常
* 服务注册：在注册中心宕机的情况下，针对服务扩容或者新启动的服务，可以通过关闭 FailFast 让应用启动，后续通过心跳进行自动注册，来减轻对服务的影响。     
* 服务发现：由于注册中心连接不上，且新启动的服务没有任何调用方的服务节点的数据源可以读取数据，因此服务发现不可用。    


#### 1.3.1.2. 运行中的服务的异常
* 服务注册
&emsp; 对于运行中的服务，服务已经注册成功，但宕机期间所有的心跳请求都会失败。  

* 服务发现  
&emsp; 注册中心宕机期间，服务发现的请求会失败。  


&emsp; 可以通过建立 cache 的方式来做降级处理，建立内存 cache+文件 cache 的方式。在发现注册中心不可用时使用内存 cache 中的数据，内存 cache 无数据则访问文件 cache。通过缓存的降级逻辑，当前运行中的服务节点间的调用不受影响，但对于新启动的节点以及宕机或者下线的节点存在无法感知的情况。  


#### 1.3.1.3. 运行中且重启过的服务
&emsp; 运行中且重启过的服务，这里指的是注册中心宕机期间，正常的服务被重启。

* 服务注册
&emsp; 宕机期间所有的 HeartBeat 请求以及服务注册的请求都会失败。   
&emsp; 服务重启时可以通过关闭 fail fast 进行服务的启动。这样这个节点能正常处理上游的流量。  

* 服务发现
&emsp; 注册中心宕机期间，服务发现的请求会失败。

&emsp; 通过内存 cache+文件 cache 的方式来进行降级处理。服务发现过程中，发现注册中心不可用，则尝试使用内存 cache 的数据，但内存 cache 中的数据为空，则尝试使用本地文件数据进行恢复。


### 1.3.2. 注册中心恢复中服务发现的异常
&emsp; 通过上述的一些降级方法，能够有效的降低注册中心异常对业务的影响。那么这样就够了吗？我们再来看一个注册中心恢复时的异常 case：  

1. 注册中心异常。  
2. 服务调用方调用注册中心异常，则降级使用cache中的数据。  
3. 注册中心恢复，此时大量的节点可能还未发起定时心跳的请求，因此所有的服务节点状态都变成了不健康的状态（Consul Health Check 配置 TTL check 的场景）。  
4. 服务调用方再次从注册中心拉取新的数据，但是所有节点都是不健康的节点。  
5. 服务调用失败。  

&emsp; 针对这种场景，应该如何做呢？我们可以通过设置一个冷静期，在 Consul Client 发起拉取服务节点成功时，从以前使用 Cache 的降级数据到使用真实的服务节点数据前，等待两个心跳周期，等待期间都使用 Cache 数据，等被调方能正常完成心跳，更新其节点的健康状态后在使用真实的数据。  


### 1.3.3. Nacos本地缓存配置
<!-- 
https://zhuanlan.zhihu.com/p/659882213
-->

&emsp; 修改内存中本地缓存保存到文件中。  

