

<!-- TOC -->

- [1. 接口幂等](#1-接口幂等)
    - [1.1. 数据问题及产生原因](#11-数据问题及产生原因)
    - [1.2. 接口幂等](#12-接口幂等)
    - [1.3. 解决方案](#13-解决方案)
        - [1.3.1. 前端](#131-前端)
        - [1.3.2. 数据库和锁](#132-数据库和锁)
        - [1.3.3. 接口编码](#133-接口编码)
        - [1.3.4. 对外提供接口的api如何保证幂等？](#134-对外提供接口的api如何保证幂等)
    - [1.4. 小结：解决方案选择](#14-小结解决方案选择)

<!-- /TOC -->

&emsp; **<font color = "red">总结：</font>**  
&emsp; 接口幂等xxx常用解决方案：
1. 分布式锁
2. DB锁
    1. select+insert，insert前先select，该方案可能不适用于并发场景，在并发场景中，要配合其他方案一起使用，否则同样会产生重复数据。  
    2. 状态机  
    3. 乐观锁（新增version字段）  

&emsp; **<font color = "blue">小结：</font>**  
&emsp; 一般场景直接使用redis分布式锁解决。可是redis分布式锁可能因编码、部署等，出现一些问题。    
&emsp; 对数据要求高的场景，使用分布式锁 + db锁，db锁一般采用状态机幂等。  
&emsp; 对于将商品数量放在redis中，扣减库存采用lua脚本，支付时反查订单系统，防止超卖问题。    


# 1. 接口幂等  

<!-- 
聊聊幂等设计 
https://mp.weixin.qq.com/s/P3GVyHxrSLN4FV2xwnP71g

分布式幂等问题解决方案三部曲 
https://mp.weixin.qq.com/s/bzroRTHYlVgc4vYv_6gpIQ

高并发下如何保证接口的幂等性？ 
https://mp.weixin.qq.com/s/2dpjLAxILJE9md1XKOPUKA

SpringBoot 接口幂等性的实现方案 
https://mp.weixin.qq.com/s/uYrjzA4QeZSD_S82w2dNIQ
你的项目是如何处理重复请求/并发请求的？
https://mp.weixin.qq.com/s/8I8fRoYuTED6S7EcbHllhQ
接口的幂等性怎么设计接口的幂等性怎么设计
https://mp.weixin.qq.com/s/6kcfTke9TciYOhcrUqq4rA
 8 种幂等性解决重复提交的方案 
 https://mp.weixin.qq.com/s/2nxU5smcf2j8okQG5RJeEQ
 幂等设计 
https://juejin.cn/post/7049140742182141959?share_token=6ca87558-82c7-4249-b75a-91fd8c0ba8b1

-->

<!-- 
基于状态机的乐观锁 ——解决幂等性问题
https://www.jianshu.com/p/c6e9ddbea022
-->


## 1.1. 数据问题及产生原因  
&emsp; 数据库中产生重复数据或数据不一致(假定程序业务代码没问题)，绝大部分就是发生了重复的请求，<font color = "red">重复请求是指同一个请求因为某些原因被多次提交。导致这个情况会有几种场景：</font>  

* 微服务场景，在传统应用架构中调用接口，要么成功，要么失败。但是在微服务架构下，会有第三个情况【未知】，也就是超时。如果超时了，微服务框架会进行重试。
* 用户交互的时候多次点击。如：快速点击按钮多次。
* <font color = "red">MQ消息中间件，消息重复消费。</font>  
* 第三方平台的接口(如：支付成功回调接口)，因为异常也会导致多次异步回调。  
* 其他中间件/应用服务根据自身的特性，也有可能进行重试。  

## 1.2. 接口幂等  
&emsp; 幂等(idempotent、idempotence)是一个数学与计算机学概念，常见于抽象代数中。在编程中一个幂等操作的特点是其任意多次执行所产生的影响均与一次执行的影响相同。幂等函数，或幂等方法，是指可以使用相同参数重复执行，并能获得相同结果的函数。这些函数不会影响系统状态，也不用担心重复执行会对系统造成改变。  
&emsp; **<font color = "red">HTTP/1.1中对幂等性的定义是：一次和多次请求某一个资源本身应该具有同样的结果(网络超时等问题除外)。</font>** 也就是说，其任意多次执行对资源本身所产生的影响均与一次执行对影响相同。    

&emsp; <font color="red">编程中常见幂等：</font>  

* select查询天然幂等  
* delete删除也是幂等，删除同一个多次效果一样  
* update直接更新某个值的，幂等  
* update更新累加操作的，非幂等  
* insert非幂等操作，每次新增一条  

## 1.3. 解决方案  
<!-- 
SpringBoot + Redis + 注解 + 拦截器来实现接口幂等性校验 
https://mp.weixin.qq.com/s/L5lOUB_cbi67eyCHmCHhbQ

 写一个通用的幂等组件，艿艿觉得很有必要 
 https://mp.weixin.qq.com/s/y6Ybk4TTlaTxL2rrjBdZlA

-->

&emsp; 以下提供方案非唯一，例如redis+token整合。  

### 1.3.1. 前端  
1. 前端js提交禁止按钮可以用一些js组件  
2. 使用Post/Redirect/Get模式   
&emsp; 在提交后执行页面重定向，这就是所谓的Post-Redirect-Get (PRG)模式。简言之，当用户提交了表单后，去执行一个客户端的重定向，转到提交成功信息页面。这能避免用户按F5导致的重复提交，而其也不会出现浏览器表单重复提交的警告，也能消除按浏览器前进和后退按导致的同样问题。  
3. 在session中存放一个特殊标志  
&emsp; 在服务器端，生成一个唯一的标识符，将它存入session，同时将它写入表单的隐藏字段中，然后将表单页面发给浏览器，用户录入信息后点击提交，在服务器端，获取表单中隐藏字段的值，与session中的唯一标识符比较，相等说明是首次提交，就处理本次请求，然后将session中的唯一标识符移除；不相等说明是重复提交，就不再处理。  

### 1.3.2. 数据库和锁  
4. 唯一主键机制  
&emsp; 利用数据库的主键唯一约束的特性，解决了在insert场景时幂等问题。但主键的要求不是自增的主键，这样就需要业务生成全局唯一的主键。如果是分库分表场景下，路由规则要保证相同请求下，落地在同一个数据库和同一表中，要不然数据库主键约束就不起效果了，因为是不同的数据库和表主键不相关。因为对主键有一定的要求，这个方案就跟业务有点耦合了，无法用自增主键了。  
5. 数据库乐观锁  
6. 数据库悲观锁  
7. 分布式锁  
8. select + insert  
9. 状态机幂等  

<!-- 
基于状态机的乐观锁
https://www.jianshu.com/p/c6e9ddbea022?utm_campaign=maleskine&utm_content=note&utm_medium=seo_notes&utm_source=recommendation
-->

### 1.3.3. 接口编码  
10. Token机制  

### 1.3.4. 对外提供接口的api如何保证幂等？  
&emsp; 对外提供接口为了支持幂等调用，接口可以有两个字段必须传，一个是来源source，一个是来源方序列号seq，这个两个字段在提供方系统里面做联合唯一索引，这样当第三方调用时，先在本方系统里面查询一下，是否已经处理过，返回相应处理结果；没有处理过，进行相应处理，返回结果。注意，为了幂等友好，一定要先查询一下，是否处理过该笔业务，不查询直接插入业务系统，会报错，但实际已经处理了。    


## 1.4. 小结：解决方案选择  
&emsp; 一般场景直接使用redis分布式锁解决。可是redis分布式锁可能因编码、部署等，出现一些问题。    
&emsp; 对数据要求高的场景，使用分布式锁 + db锁，db锁一般采用状态机幂等。  
&emsp; 对于将商品数量放在redis中，扣减库存采用lua脚本，支付时反查订单系统，防止超卖问题。   
 