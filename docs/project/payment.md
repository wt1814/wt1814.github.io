

<!-- TOC -->

- [1. 支付项目](#1-支付项目)
    - [1.1. 支付业务](#11-支付业务)
        - [1.1.1. 支付流程](#111-支付流程)
            - [1.1.1.1. 预支付](#1111-预支付)
            - [1.1.1.2. 支付回调/支付查询](#1112-支付回调支付查询)
    - [1.2. 项目中要注意的问题](#12-项目中要注意的问题)
        - [1.2.1. 安全性](#121-安全性)
        - [1.2.2. 幂等性](#122-幂等性)
        - [1.2.3. 一致性](#123-一致性)
            - [1.2.3.1. 外部系统](#1231-外部系统)
            - [1.2.3.2. 内部系统](#1232-内部系统)
        - [1.2.4. 告警处理](#124-告警处理)

<!-- /TOC -->


# 1. 支付项目  
## 1.1. 支付业务  

### 1.1.1. 支付流程  

#### 1.1.1.1. 预支付
![image](https://gitee.com/wt1814/pic-host/raw/master/images/project/pay-1.png)  

#### 1.1.1.2. 支付回调/支付查询
![image](https://gitee.com/wt1814/pic-host/raw/master/images/project/pay-2.png)  




## 1.2. 项目中要注意的问题  
### 1.2.1. 安全性
1. 基于参数验证签名形式防止数据被篡改
2. 采用预支付的形式隐藏参数的真实性
3. 一处回调中判断金额与下单金额是否一致，如果不一致的情况下订单为异常订单状态

<!-- 
很简单，我们提交的表单有可能被黑客截获并篡改，然后发给银联。
这种情况通过签名解决，也就是RSA算法，银联有私钥，发给我们公钥，公钥签名，只有私钥才能验签，如果黑客对提交的表单数据进行了篡改，是通不过验签的。
但是万一黑客就是很牛逼，篡改了金额，本来1000块的东西，提交给银联，他给篡改成1分钱，银联也没验出来，怎么办？
为了防止这种情况，我们必须要在银联回调我们后，我们设置自己的数据库支付状态为成功之前，先对银联实际支付金额进行判断，如果和我们提交的不一致，则不能设置为支付成功，要设置成支付异常，然后报警。
但是万一黑客就是牛逼到跟上帝一样，银行回调的数据他又给改了，改回1000了咋办，我们也没法判断。
这时日志又派上用场了，我前面说过，所有支付流程必须记日志，所有操作步骤都是可查的，那么在每月一次的和银联的对账中，这种人是逃不了的，最终会被查出来，还是那句话，概率太小，所以也不用担心工作量的问题。
-->


### 1.2.2. 幂等性  
* 前端
    1. 防抖
* 后端：[接口幂等](/docs/web/interface/idempotent.md)  

### 1.2.3. 一致性
#### 1.2.3.1. 外部系统  
&emsp; 外部系统如：支付宝、微信等。使用[本地事务表法](/docs/microService/thinking/news.md)。    


#### 1.2.3.2. 内部系统  
&emsp; 外部系统如：财务、订单、库存等。可以使用[基于mq的事务消息、最大努力通知](/docs/microService/thinking/news.md)。  


### 1.2.4. 告警处理  

