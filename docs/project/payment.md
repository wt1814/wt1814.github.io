

<!-- TOC -->

- [1. 支付项目](#1-支付项目)
    - [1.1. 支付业务](#11-支付业务)
        - [1.1.1. 支付流程](#111-支付流程)
            - [1.1.1.1. 获取支付方式](#1111-获取支付方式)
            - [1.1.1.2. 预支付](#1112-预支付)
            - [1.1.1.3. 支付回调/支付查询](#1113-支付回调支付查询)
        - [1.1.2. 对账](#112-对账)
            - [1.1.2.1. 前言](#1121-前言)
            - [1.1.2.2. 系统整体设计](#1122-系统整体设计)
            - [1.1.2.3. 渠道数据处理模块](#1123-渠道数据处理模块)
            - [1.1.2.4. 数据处理模块](#1124-数据处理模块)
            - [1.1.2.5. 核对模块](#1125-核对模块)
            - [1.1.2.6. 差异数据处理模块](#1126-差异数据处理模块)
    - [1.2. 项目中要注意的问题](#12-项目中要注意的问题)
        - [1.2.1. 安全性](#121-安全性)
        - [1.2.2. 幂等性](#122-幂等性)
        - [1.2.3. 一致性](#123-一致性)
            - [1.2.3.1. 外部系统](#1231-外部系统)
            - [1.2.3.2. 内部系统](#1232-内部系统)
        - [1.2.4. 异常处理](#124-异常处理)
        - [1.2.5. 告警处理](#125-告警处理)

<!-- /TOC -->

&emsp; **<font color = "red">总结：</font>**  
1. 支付流程：获取支付方式 ---> 预支付 ---> 支付回调/支付查询 
    1. 预支付中，先生成支付单(初始状态) ---> 调用三方 ---> 调用成功，修改支付单状态。   
2. 对账
    1. 将对账文件入库，对账明细表。  
    2. 核对3种情况：本端多账、对端多账、金额不一致。  
    * 金额不一致：相当少见，这种情况需要人工判断。  
    * 本端多帐：这种情况可能由于交易的时候发生日切问题，导致双方记账日期不一致，从而发生不平账。  
    &emsp; 对于这类差异数据，我们可以选择将这笔数据挂账，等待 T+1 工作日对账。T+1 日对账的时候，对账单会相应多出数据，这样在核对过程就会产生对端多账的差异数据。  
    * 对端多账：  
    &emsp; 情况一：测试环境与生产环境共用一份第三方渠道参数，忽略此部分数据。  
    &emsp; 情况二：本端交易订单存在，但是状态不是成功状态。这种情况下，需要调用第三方渠道提供的查询接口，查询订单最终状态。 若查询成功，更新订单状态，然后将差异数据状态更改为处理成功。  
3. 支付项目中要注意的问题
&emsp; 安全性、幂等姓、数据一致性，对异常对处理。  
&emsp; 异常处理：如果是网络异常处理，发起重试。  
&emsp; **<font color = "blue">重点一：重试过程中可能发生回调，可以在重试流程中，请求第三方前，检查一下单子单状态。</font>**     
&emsp; **<font color = "blue">重点二：支付重试失败，将支付单作废。同时要做一个补偿机制，对第三方发起撤销流程。</font>**   


# 1. 支付项目  
<!-- 
码云上不错的几个支付相关的项目
https://mp.weixin.qq.com/s?__biz=MzA4MTk3MjI0Mw==&mid=2247487121&idx=1&sn=f9a2a75d14fa3b1b3401fce6d613f90e&chksm=9f8d93eda8fa1afbc5971dc436eed0288fbae3bfc041acbe19846c2bab60a378f888690fbbdd&mpshare=1&scene=1&srcid=&sharer_sharetime=1573400384876&sharer_shareid=b256218ead787d58e0b58614a973d00d&key=dee829c9aae7a0c01d07b1991447c4f5d0986fdb3dc2f46f292484d4afb536ebce532b9a04fb67c0cd21daa83f6c1ae10736c69f629c30c7fa6383b96fa03624662cd73bd896e4e104b1dd8033be5c82&ascene=1&uin=MTE1MTYxNzY2MQ%3D%3D&devicetype=Windows+10&version=62070152&lang=zh_CN&pass_ticket=jJEy3kCpzSU46vQnPYwujJ%2FMZDu5tpN7sY32I3V5fxoKvSV4rqdrYUcoZ5Odz%2FWZ

-->

## 1.1. 支付业务  

### 1.1.1. 支付流程  

#### 1.1.1.1. 获取支付方式
![image](https://gitee.com/wt1814/pic-host/raw/master/images/project/pay-3.png)  

#### 1.1.1.2. 预支付
&emsp; 先生成支付单(初始状态) ---> 调用三方 ---> 调用成功，修改支付单状态。    
![image](https://gitee.com/wt1814/pic-host/raw/master/images/project/pay-1.png)  

#### 1.1.1.3. 支付回调/支付查询
![image](https://gitee.com/wt1814/pic-host/raw/master/images/project/pay-2.png)  


### 1.1.2. 对账
<!-- 
https://blog.csdn.net/a568418299/article/details/88820324
-->

#### 1.1.2.1. 前言
&emsp; 对账系统作为支付系统中的基石系统,处于整个支付环节中的最后一层，主要用来保证我方支付数据与第三方支付渠道或银行的数据一致性。  
&emsp; 在没有对账系统之前，财务在第二日手工核对前一日的应收与实收。倘若不一致，这就需要一一核对数据，找出不一致的数据。对账系统出现之后，就可减少以这种繁琐手工操作，财务只需要每天关注系统的对账记录，释放了生产力。  
&emsp; 本文主要结合实际的项目经验，聊聊对账系统的设计方案。   

#### 1.1.2.2. 系统整体设计
&emsp; 对账系统设计主要分为以下四个模块：  

* 渠道数据处理模块
* 数据处理模块
* 核对模块
* 差异数据处理模块


#### 1.1.2.3. 渠道数据处理模块
&emsp; 这个模块主要负责渠道对账文件的下载，解析，以及 **<font color = "blue">数据落库(对账明细表)。</font>**    
&emsp; 目前市面上第三方支付渠道对账文件下载方式主要分为以下几类：  

* 第三方渠道定时推送到 SFTP/FTP。这种模式比较简单，我们定时从 SFTP/FTP 取对账文件。  
* 调用第三方渠道对账文件下载接口。这种模式需要对接渠道下载对账文件接口，定时调用下载。支付宝与微信为该模式。  
* 手动在支付渠道网站下载对账文件。这种模式最不友好，需要我们花费人力下载文件。  

#### 1.1.2.4. 数据处理模块
&emsp; 讲完对账文件处理模块，我们来看数据处理模块。  
&emsp; 这个模块主要用来提取我方前一日所有支付成功的流水数据以及上一模块入库的前一日对账单的流水数据。为了减少数据库的压力，提取的数据只需要包括必要字段即可，无需将整行数据信息都提取出来。一般来说只要需要提取交易时间，金额，交易订单号，渠道返回流水号。   
&emsp; 这一层主要就是数据库的查询行为。最好使用备库进行数据查询。因为这里我们需要提取前一日全量的支付成功的数据，数据量大的情况下，可能会拖慢主库，影响在线的支付交易。  

#### 1.1.2.5. 核对模块
&emsp; 这一个模块我们使用上一模块提取出来的数据，核对订单号与金额是否完全一致。  
&emsp; 这个过程可能产生三类差异数据。

&emsp; 第一种情况为本端数据存在，对端数据不存在，我们称为本端多账。  
&emsp; 第二种情况为对端数据存在，本端数据不存在，我们称为对端多账。  
&emsp; 第三种情况为金额不一致。  

&emsp; 三者如图所示。  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/project/pay-4.png)  

#### 1.1.2.6. 差异数据处理模块  
&emsp; 这个模块主要用来处理上个模块产生的差异数据。  

&emsp; 上面三类差异数据中，金额不一致相当少见，这种情况需要人工判断。  

--------
&emsp; 我们先讨论本端多账的情况。  

&emsp; **<font color = "red">本端多账是对账系统最常见的一种情况。这种情况可能由于交易的时候发生日切问题，导致双方记账日期不一致，从而发生不平账。</font>**  

&emsp; 我们先解释日切的概念。  

&emsp; 日切，通俗的来说就是更换系统记账的时间，系统从当前工作日切换到下一工作日。这个过程中，若我方的交易订单刚好发生在 T 日 23 :59 :59，那么我方的记账时间为 T 日。第三方渠道接收到订单的时间为 T+1 日 00 :00 :01，这样第三方渠道该笔的交易的对账日期为 T+1 日。  

&emsp; 第三方渠道 T 日对账文件将缺少这笔，但是我方 T 日数据却存在这笔，这就导致了核对过程中产生一笔本端多账差异数据。  

&emsp; **<font color = "red">对于这类差异数据，我们可以选择将这笔数据挂账，等待 T+1 工作日对账。T+1 日对账的时候，对账单会相应多出数据，这样在核对过程就会产生对端多账的差异数据。</font>**  

&emsp; **<font color = "red">然后在 T+1 日差异处理模块将前几日差异数据都提取出来，逐笔核对本端多账数据与对端多账数据。若核对一致，将两笔差异状态都更新成处理完成。最后若无剩余差异数据，当天账单平账。</font>**  

--------
&emsp; **<font color = "red">对端多账的产生情况可能可能有两种情况。</font>**  

&emsp; **<font color = "clime">第一种情况测试环境与生产环境共用一份第三方渠道参数，这就导致测试环境交易订单也会出现在对账单中。</font>** 若是这种情况，我们确认测试环境存在这批数据之后，我们忽略这批差异数据即可。  

&emsp; **<font color = "clime">第二种情况，本端交易订单存在，但是状态不是成功状态。这种情况下，需要调用第三方渠道提供的查询接口，查询订单最终状态。</font>** 若查询成功，更新订单状态，然后将差异数据状态更改为处理成功。  
&emsp; 若第三方渠道无法查询到订单的状态。这种若与渠道确认订单最终支付成功，我们需要将支付订单改为支付成功，并修改差异账的状态。  
&emsp; 最后我们再次重新对账，由于对端多账的数据会有对应的本端数据，将不会产生差异数据，这次对账完成且平账。  


## 1.2. 项目中要注意的问题  
### 1.2.1. 安全性
1. 基于参数验证签名形式防止数据被篡改
2. 采用预支付的形式隐藏参数的真实性
3. 一处回调中判断金额与下单金额是否一致，如果不一致的情况下订单为异常订单状态

<!-- 
很简单，我们提交的表单有可能被黑客截获并篡改，然后发给银联。
这种情况通过签名解决，也就是RSA算法，银联有私钥，发给我们公钥，公钥签名，只有私钥才能验签，如果黑客对提交的表单数据进行了篡改，是通不过验签的。
但是万一黑客就是很牛逼，篡改了金额，本来1000块的东西，提交给银联，他给篡改成1分钱，银联也没验出来，怎么办？
为了防止这种情况，我们必须要在银联回调我们后，我们设置自己的数据库支付状态为成功之前，先对银联实际支付金额进行判断，如果和我们提交的不一致，则不能设置为支付成功，要设置成支付异常，然后报警。
但是万一黑客就是牛逼到跟上帝一样，银行回调的数据他又给改了，改回1000了咋办，我们也没法判断。
这时日志又派上用场了，我前面说过，所有支付流程必须记日志，所有操作步骤都是可查的，那么在每月一次的和银联的对账中，这种人是逃不了的，最终会被查出来，还是那句话，概率太小，所以也不用担心工作量的问题。
-->


### 1.2.2. 幂等性  
* 前端
    1. 防抖
* 后端：[接口幂等](/docs/web/interface/idempotent.md)  

### 1.2.3. 一致性
#### 1.2.3.1. 外部系统  
&emsp; 外部系统如：支付宝、微信等。使用[本地事务表法](/docs/microService/thinking/news.md)。    


#### 1.2.3.2. 内部系统  
&emsp; 外部系统如：财务、订单、库存等。可以使用[基于mq的事务消息、最大努力通知](/docs/microService/thinking/news.md)。  


### 1.2.4. 异常处理  
&emsp; **<font color = "red">网络异常处理：发起重试。</font>**    
&emsp; 网络异常，可能是网络堵塞。在发起重试时，第三方已经处理，可能处理完毕，并发起回调。  
&emsp; **<font color = "blue">重点一：重试过程中可能发生回调，可以在重试流程中，请求第三方前，检查一下单子单状态。</font>**     

&emsp; ~~支付重试失败，通知订单系统，将订单锁定，禁止支付，等待支付系统查询结果；支付重试失败，支付系统另启线程，休眠1分钟查询支付结果，若支付失败，支付单作废，订单解锁。~~ 

&emsp; **<font color = "blue">重点二：支付重试失败，将支付单作废。同时要做一个补偿机制，对第三方发起撤销流程。</font>**   

### 1.2.5. 告警处理  



