

<!-- TOC -->

- [1. 高可用](#1-高可用)
    - [1.1. 主从复制拓扑结构](#11-主从复制拓扑结构)
    - [1.2. 高可用实现](#12-高可用实现)
        - [1.2.1. MMM架构](#121-mmm架构)
        - [1.2.2. MHA架构](#122-mha架构)

<!-- /TOC -->

# 1. 高可用

<!-- 
 跟大家聊聊mysql主从复制原理 
https://mp.weixin.qq.com/s/HJYkDheKbCdANj91zRDx2g
-->

## 1.1. 主从复制拓扑结构 
![image](https://gitee.com/wt1814/pic-host/raw/master/images/SQL/sql-11.png)  

* 一主一从：  
&emsp; 主备架构。只有主库提供读写服务；备库冗余作故障转移，即主库挂了，keepalive（一种工具）会自动切换到备库。  
* 一主多从：  
&emsp; 一台Slave承受不住读请求压力时，可以添加多台，进行负载均衡，分散读压力。还可以对多台Slave进行分工，服务于不同的系统，例如一部分Slave负责网站前台的读请求，另一部分Slave负责后台统计系统的请求。因为不同系统的查询需求不同，对Slave分工后，可以创建不同的索引，使其更好的服务于目标系统。  
&emsp; 主库单点，从库高可用。一旦主库挂了，写服务也就无法提供。  
&emsp; 存在问题：存在数据一致性问题。请看，一致性解决方案。  
* 双主复制：  
&emsp; 一主多从，Master存在下线的可能，例如故障或者维护，需要把Slave切换为Master。在原来的Master恢复可用后，由于其数据已经不是最新的了，不能再做主，需要作为Slave添加进来。那么就需要对其重新搭建复制环境，需要耗费一定的工作量。  
&emsp; 双主架构，两个主库同时提供服务，负载均衡。高可用，一个主库挂了，不影响另一台主库提供服务。这个过程对业务层是透明的，无需修改代码或配置。  
&emsp; 存在问题：第一，数据一致性问题，一致性解决方案可解决问题。第二，主键冲突问题，ID统一地由分布式ID生成服务来生成可解决问题。  

* 从库级联复制  
&emsp; 当直接从属于Master的Slave过多时，连到Master的Slave IO线程就比较多，对Master的压力是很大的。  
&emsp; 级联结构就是通过减少直接从属于Master的Slave数量，减轻Master的压力，分散复制请求，从而提高整体的复制效率。  
* 双主+主从架构  
&emsp; 存在问题：数据一致性问题、主键冲突问题。数据同步又多了一层，数据延迟更严重。  
* 双主+级联  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/SQL/sql-12.png)  

## 1.2. 高可用实现  
<!-- 
https://blog.csdn.net/qq_39720208/article/details/102758662

https://mp.weixin.qq.com/s/RZ7b8IKC7N3E87DaZhWaVA
-->

### 1.2.1. MMM架构  

&emsp; Multi_Master Replication Manager，就是mysql**多主复制管理器的简称，它是由一套perl语言开发的用于管理mysql**主主同步架构的工具集，主要作用是监控和管理mysql主主复制拓扑，并在当前的主服务器失效时，进行主和主备服务器之间的主从切换和故障转移等工作。  


### 1.2.2. MHA架构  
&emsp; <font color = "red">Mha(master high Avaliability )，是由perl脚本开发的，用于管理mysql主从复制或者实现mysql高可用的一套相对比较成熟的工具套装。</font>从名称可以看出，MHA主要关注的是mysql集群的主DB，其主要功能是在mysql中主从复制架构下完成故障切换和在众多的从服务器中自动选举出新的从服务器，并将其他的从服务器和新选出的主数据库进行同步切换，在mysql的切换过程中，MHA可以做到完成高效的主从切换。基本可以保证在30s内完成所有的切换操作。并且在切换的过程中可以最大程度的保证数据的一致性。以避免丢失的事务，达到真正意义上的高可用。  
