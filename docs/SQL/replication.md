
<!-- TOC -->

- [1. 主从复制](#1-主从复制)
    - [1.1. 主从复制简介](#11-主从复制简介)
    - [1.2. MySql主从复制原理](#12-mysql主从复制原理)
        - [1.2.1. 复制流程](#121-复制流程)
        - [1.2.2. 复制方式](#122-复制方式)
            - [1.2.2.1. 多线程复制](#1221-多线程复制)
        - [1.2.3. 复制类型](#123-复制类型)
            - [1.2.3.1. 基于语句的复制](#1231-基于语句的复制)
            - [1.2.3.2. 基于行的复制](#1232-基于行的复制)
            - [1.2.3.3. 混合模式复制](#1233-混合模式复制)
    - [1.3. MySql主从复制的高可用实现](#13-mysql主从复制的高可用实现)
        - [1.3.1. 主从复制拓扑结构](#131-主从复制拓扑结构)
        - [1.3.2. 高可用实现方案](#132-高可用实现方案)
            - [1.3.2.1. MMM架构](#1321-mmm架构)
            - [1.3.2.2. MHA架构](#1322-mha架构)
    - [1.4. MySql主从复制的问题](#14-mysql主从复制的问题)
    - [1.5. 读写分离](#15-读写分离)

<!-- /TOC -->

![image](https://gitee.com/wt1814/pic-host/raw/master/images/SQL/sql-64.png)  
&emsp; **<font color = "red">总结：</font>**  
1. 对于每一个主从复制的连接，都有三个线程。拥有多个从库的主库为每一个连接到主库的从库创建一个binlog输出线程，每一个从库都有它自己的I/O线程和SQL线程。  
2. 混合模式复制根据事件的类型实时的改变binlog的格式。当设置为混合模式时，默认为基于语句的格式，但在特定的情况下它会自动转变为基于行的模式。  

# 1. 主从复制 
&emsp; **<font color = "red">部分参考《高性能MySql》</font>**
<!-- 
面试官：Mysql 中主库跑太快，从库追不上怎么整？ 
https://mp.weixin.qq.com/s/3OBZEYAbP4Yocr1EHoBhuw

大厂如何使用binlog解决多机房同步mysql数据(一)？ 
https://mp.weixin.qq.com/s/CXJHvTofKix6rR-ZZgeT_w
大厂如何基于binlog解决多机房同步mysql数据(二)？ 
https://mp.weixin.qq.com/s/d6cjgj8rxqKTw9AkKkpG9A
基于binlog的canal组件有哪些使用场景(三)？ 
https://mp.weixin.qq.com/s/X7-V7EQcnE0cK-NCfdsS1w
-->
## 1.1. 主从复制简介  
&emsp; 什么是主从复制?  
&emsp; 主从复制，是用来建立一个和主数据库完全一样的数据库环境，称为从数据库；主数据库一般是准实时的业务数据库。

&emsp; 主从复制的作用：  
1. 做数据的热备，作为后备数据库，主数据库服务器故障后，可切换到从数据库继续工作，避免数据丢失。  
2. 架构的扩展。业务量越来越大，I/O访问频率过高，单机无法满足，此时做多库的存储，降低磁盘I/O访问的频率，提高单个机器的I/O性能。  
3. 读写分离，使数据库能支撑更大的并发。在报表中尤其重要。由于部分报表sql语句非常的慢，导致锁表，影响前台服务。如果前台使用master，报表使用slave，那么报表sql将不会造成前台锁，保证了前台速度。  

## 1.2. MySql主从复制原理  
<!-- 

-->
### 1.2.1. 复制流程  

&emsp; 主从复制如图：  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/SQL/sql-129.png)  
&emsp; 对于每一个主从复制的连接，都有三个线程。拥有多个从库的主库为每一个连接到主库的从库创建一个binlog输出线程，每一个从库都有它自己的I/O线程和SQL线程。  

* 主库binlog输出线程：每当有从库连接到主库的时候，主库都会创建一个线程然后发送binlog内容到从库。  
* 从库I/O线程：当START SLAVE语句在从库开始执行之后，从库创建一个I/O线程，该线程连接到主库并请求主库发送binlog里面的更新记录到从库上。从库I/O线程读取主库的binlog输出线程发送的更新并拷贝这些更新到本地文件，其中包括relay log文件。  
* 从库的SQL线程：从库创建一个SQL线程，这个线程读取从库I/O线程写到relay log的更新事件并执行。  

----
&emsp; 原理图2，帮助理解!   
![image](https://gitee.com/wt1814/pic-host/raw/master/images/SQL/sql-130.png)  
&emsp; 步骤一：主库db的更新事件(update、insert、delete)被写到binlog。  
&emsp; 步骤二：从库发起连接，连接到主库。  
&emsp; 步骤三：此时主库创建一个binlog dump thread线程，把binlog的内容发送到从库。  
&emsp; 步骤四：从库启动之后，创建一个I/O线程，读取主库传过来的binlog内容并写入到relay log。  
&emsp; 步骤五：还会创建一个SQL线程，从relay log里面读取内容，从Exec_Master_Log_Pos位置开始执行读取到的更新事件，将更新内容写入到slave的db。  

### 1.2.2. 复制方式
&emsp; 同步方式可以划分为：异步、半同步和同步。  

* 同步复制：指当主库执行完一个事务，所有的从库都执行了该事务才返回给客户端。因为需要等待所有从库执行完该事务才能返回，所以全同步复制的性能必然会收到严重的影响。需要有超时时间。  
* 异步复制：<font color = "red">MySQL默认的复制即是异步的，</font>主库在执行完客户端提交的事务后会立即将结果返给给客户端，并不关心从库是否已经接收并处理，<font color = "lime">这样就会有一个问题，主如果crash掉了，此时主上已经提交的事务可能并没有传到从上，如果此时，强行将从提升为主，可能导致新主上的数据不完整。</font>  
* 半同步复制：介于异步复制和全同步复制之间，主库在执行完客户端提交的事务后不是立刻返回给客户端，而是等待至少一个从库接收到并写到relay log中才返回给客户端。相对于异步复制，半同步复制提高了数据的安全性，同时它也造成了一定程度的延迟，这个延迟最少是一个TCP/IP往返的时间。所以，半同步复制最好在低延时的网络中使用。  

#### 1.2.2.1. 多线程复制  
&emsp; 在MySQL5.7中，带来了全新的多线程复制技术。  
<!-- 
mysql5.7之后使用MTS并行复制技术，永久解决复制延时问题
https://mp.weixin.qq.com/s/dZNxgwmE2XvnYqZwweOQnw
https://blog.csdn.net/andong154564667/article/details/82117727
-->

### 1.2.3. 复制类型  
<!-- 

-->
&emsp; 复制类型有三种：基于行的复制、基于语句的复制、混合模式复制。  

#### 1.2.3.1. 基于语句的复制  
&emsp; 基于SQL语句的复制(statement-based replication, SBR)，每一条会修改数据的sql语句会记录到binlog中。  
&emsp; **优点：** 不需要记录每一条SQL语句与每行的数据变化(不记录select操作)，这样子binlog的日志也会比较少，减少了磁盘IO，提高性能。  
&emsp; **缺点：** <font color = "red">并非所有修改数据的语句都可以使用基于语句的复制进行复制。使用基于语句的复制时，任何非确定性行为都难以复制。</font>此类数据修改语言(DML)语句的示例包括以下内容：  
        
    依赖于UDF或不确定的存储程序的语句，因为这样的UDF或存储程序返回的值取决于提供给它的参数以外的因素。  
    不带ORDER BY的LIMIT子句的DELETE和UPDATE语句是不确定的。 
 
#### 1.2.3.2. 基于行的复制  
&emsp; 不记录每一条SQL语句的上下文信息，仅需记录哪条数据被修改了，修改成了什么样子了。  
&emsp; **优点：** 没有基于行的复制模式无法处理的场景。  
&emsp; **缺点：** 会产生大量的日志。  

#### 1.2.3.3. 混合模式复制  
&emsp; 混合模式复制(mixed-based replication, MBR)：MySQL5.1及其以后的版本推荐使用混合模式的复制，它是<font color = "lime">根据事件的类型实时的改变binlog的格式。当设置为混合模式时，默认为基于语句的格式，但在特定的情况下它会自动转变为基于行的模式。</font>  
&emsp; <font color = "red">当出现如下情况时，混合模式需要切换到基于行的复制：</font>  

* 该语句调用了：UUID函数；用户自定义函数(UDFs)；CURRENT_USER或USER函数；LOAD_FILE函数。
* 同一个语句更改了两张或更多包含AUTO_INCREMENT列的表。
* 语句中使用了服务器变量。
* 存储引擎不允许使用基于语句复制，如：MySQL Cluster引擎。

## 1.3. MySql主从复制的高可用实现  
### 1.3.1. 主从复制拓扑结构 
![image](https://gitee.com/wt1814/pic-host/raw/master/images/SQL/sql-11.png)  

* 一主一从：  
&emsp; 主备架构。只有主库提供读写服务；备库冗余作故障转移，即主库挂了，keepalive(一种工具)会自动切换到备库。  
* 一主多从：  
&emsp; 一台Slave承受不住读请求压力时，可以添加多台，进行负载均衡，分散读压力。还可以对多台Slave进行分工，服务于不同的系统，例如一部分Slave负责网站前台的读请求，另一部分Slave负责后台统计系统的请求。因为不同系统的查询需求不同，对Slave分工后，可以创建不同的索引，使其更好的服务于目标系统。  
&emsp; 主库单点，从库高可用。一旦主库挂了，写服务也就无法提供。  
&emsp; 存在问题：存在数据一致性问题。请看，一致性解决方案。  
* 双主复制：  
&emsp; 一主多从，Master存在下线的可能，例如故障或者维护，需要把Slave切换为Master。在原来的Master恢复可用后，由于其数据已经不是最新的了，不能再做主，需要作为Slave添加进来。那么就需要对其重新搭建复制环境，需要耗费一定的工作量。  
&emsp; 双主架构，两个主库同时提供服务，负载均衡。高可用，一个主库挂了，不影响另一台主库提供服务。这个过程对业务层是透明的，无需修改代码或配置。  
&emsp; 存在问题：第一，数据一致性问题，一致性解决方案可解决问题。第二，主键冲突问题，ID统一地由分布式ID生成服务来生成可解决问题。  

* 从库级联复制  
&emsp; 当直接从属于Master的Slave过多时，连到Master的Slave IO线程就比较多，对Master的压力是很大的。  
&emsp; 级联结构就是通过减少直接从属于Master的Slave数量，减轻Master的压力，分散复制请求，从而提高整体的复制效率。  
* 双主+主从架构  
&emsp; 存在问题：数据一致性问题、主键冲突问题。数据同步又多了一层，数据延迟更严重。  
* 双主+级联  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/SQL/sql-12.png)  

### 1.3.2. 高可用实现方案  
<!-- 
https://blog.csdn.net/yzj5208/article/details/81288436
https://blog.csdn.net/qq_39720208/article/details/102758662
https://mp.weixin.qq.com/s/RZ7b8IKC7N3E87DaZhWaVA

-->
#### 1.3.2.1. MMM架构  
&emsp; Multi_Master Replication Manager，就是mysql**多主复制管理器的简称，它是由一套perl语言开发的用于管理mysql**主主同步架构的工具集，主要作用是监控和管理mysql主主复制拓扑，并在当前的主服务器失效时，进行主和主备服务器之间的主从切换和故障转移等工作。  

#### 1.3.2.2. MHA架构  
&emsp; <font color = "red">Mha(master high Avaliability )，是由perl脚本开发的，用于管理mysql主从复制或者实现mysql高可用的一套相对比较成熟的工具套装。</font>从名称可以看出，MHA主要关注的是mysql集群的主DB，其主要功能是在mysql中主从复制架构下完成故障切换和在众多的从服务器中自动选举出新的从服务器，并将其他的从服务器和新选出的主数据库进行同步切换，在mysql的切换过程中，MHA可以做到完成高效的主从切换。基本可以保证在30s内完成所有的切换操作。并且在切换的过程中可以最大程度的保证数据的一致性。以避免丢失的事务，达到真正意义上的高可用。  

## 1.4. MySql主从复制的问题
&emsp; [主从复制的问题](/docs/SQL/replicationProblem.md)  

## 1.5. 读写分离  
&emsp; 读写分离在数据库主从复制技术基础上实现(主从复制针对写入数据，读写分离主要针对读取数据)。  
&emsp; **读写分离带来的问题：**  

* 数据不一致问题(主从数据同步延迟问题)：当主库的TPS并发较高时，由于主库上面是多线程写入的，而从库的SQL线程是单线程的，导致从库SQL可能会跟不上主库的处理速度。因此有可能出现在master节点中已经插入了数据，但是从slave节点却读取不到的问题。 **<font color = "red">对于一些强一致性的业务场景，要求插入后必须能读取到，对于这种情况，需要提供一种方式，让读请求也可以走主库。</font>**  
&emsp; 延迟的解决：    
    1. 网络方面：将从库分布在相同局域网内或网络延迟较小的环境中。  
    2. 硬件方面：从库配置更好的硬件，提升随机写的性能。  
    3. 配置方面：从库配置sync_binlog=0，innodb_flush_log_at_trx_commit=2，logs-slave-updates=0，增大innodb_buffer_pool_size，让更多操作在Mysql内存中完成，减少磁盘操作。或者升级Mysql5.7版本使用并行复制。  
    4. 架构方面：比如在事务当中尽量对主库读写，其他非事务中的读在从库。消除一部分延迟带来的数据库不一致。增加缓存降低一些从库的负载。  
* 事务问题：读写分离属于分布式事务的范畴。但是对于读写分离，目前主流的做法是，事务中的所有sql统一都走主库，由于只涉及到一个库，本地事务就可以搞定。  
* 感知集群信息变更：如果访问的数据库集群信息变更了，例如主从切换了，写流量就要到新的主库上；又例如增加了从库数量，流量需要可以打到新的从库上；又或者某个从库延迟或者失败率比较高，应该将这个从库进行隔离，读流量尽量打到正常的从库上。  
* 运维：例如集群搭建、主从切换、从库扩容、缩容等。例如master配置了多个slave节点，如果其中某个slave节点挂了，那么之后的读请求，应用将其转发到正常工作的slave节点上。另外，如果新增了slave节点，应用也应该感知到，可以将读请求转发到新的slave节点上。  