
<!-- TOC -->

- [1. 大数据量操作](#1-大数据量操作)
    - [1.1. 在线修改大表结构](#11-在线修改大表结构)
    - [1.2. ~~大表添加索引~~](#12-大表添加索引)
    - [1.3. ~~插入千万条数据~~](#13-插入千万条数据)
    - [1.4. ~~快速删除大量(百万级)数据~~](#14-快速删除大量百万级数据)
    - [亿级订单系统](#亿级订单系统)

<!-- /TOC -->

# 1. 大数据量操作  
## 1.1. 在线修改大表结构  
<!-- 
在线修改大表结构pt-online-schema-change
https://segmentfault.com/a/1190000014924677

大表添加索引
https://mp.weixin.qq.com/s/kYC0FBq3bwqbz4nm2N59Nw

「面试官：」 如果一张表数据量级是千万级别以上的，那么，给这张表添加索引，你需要怎么做呢？

「解析：」 我们需要知道一点，给表添加索引的时候，是会对表加锁的。如果不谨慎操作，有可能出现生产事故的。可以参考以下方法：

    1.先创建一张跟原表A数据结构相同的新表B。
    2.在新表B添加需要加上的新索引。
    3.把原表A数据导到新表B
    4.rename新表B为原表的表名A，原表A换别的表名；
-->

&emsp; 在线修改MySQL大表的表结构：  
1. 方案1、直接ALTER TABLE  
&emsp; 这个方案只能说这仅仅是一种方案，在某些非实时在线或数据量较小时有较好的表现。  
2. 方案２、模拟数据库修改表结构的操作，在非数据库层实现整个过程。  
&emsp; 实现业务中对于数据的读写分离  
&emsp; 创建一个已经按需求修改好结构的新表  
&emsp; 修改业务逻辑，将读操作指向旧表，将写操作指向新表。如果读旧表没有，再读新表，并将旧的数据写入到新表，当然这一步写入操作可以不用，可以在后台做一个定时任务将旧数据同步到新表。  
&emsp; 这种方案有一个较大的缺点，需要业务逻辑层配合实现数据的迁移，对于业务逻辑有修改，并且如果有多台机器的话，需要一台一台的修改，较费时间，但是对于MySQL的两种主要存储引擎都适用。  
3. 方案３、 **<font color = "clime">facebook online schema change</font>**  
&emsp; **facebook的OSC在整体流程上与方案2没有较大的区别，只是它在这里引入了触发器，从而不需要修改业务逻辑，在数据库层就实现了新数据的两个表的同步问题。** 其大概步骤如下：  
    1. 按需求创建新表  
    2. 针对原始表创建触发器  
    3. 对于原始表的更新操作都会被触发器更新到新表中  
    4. 把原始表中的数据复制到新表中  
    5. 将新表替换旧表  
    6. fb的osc方案从数据库层解决了方案2的问题，但是它仅支持InnoDB存储引擎。  
4. 方案４、换一个思路，保留字段。  
&emsp; 假设一切可以从头再来，可以加多一些冗余字段，各个类型都加一些，备用。  
5. 方案5、 **<font color = "clime">增加扩展表。</font>**  
&emsp; 不在原有的表的基础上修改了，以增加扩展表的方式，将新字段的数据写入到扩展表中，修改业务逻辑，这些字段从新表中读取。  


## 1.2. ~~大表添加索引~~  
&emsp; 给表添加索引的时候，是会对表加锁的。如果不谨慎操作，有可能出现生产事故的。可以参考以下方法：  

1. 先创建一张跟原表A数据结构相同的新表B。
2. 在新表B添加需要加上的新索引。
3. 把原表A数据导到新表B
4. rename新表B为原表的表名A，原表A换别的表名；


## 1.3. ~~插入千万条数据~~  

<!--
如何快速安全的插入千万条数据？ 
https://mp.weixin.qq.com/s/s-vgBk6vGP6DH4tP5mG2mQ

1. 尽量使用多个值表的 INSERT 语句，这种方式将大大缩减客户端与数据库之间的连接、关闭等消耗。(同一客户的情况下)，即：  

    INSERT INTO tablename values(1,2),(1,3),(1,4)  
2. 如果在不同客户端插入很多行，可使用INSERT DELAYED语句得到更高的速度，DELLAYED含义是让INSERT语句马上执行，其实数据都被放在内存的队列中。并没有真正写入磁盘。LOW_PRIORITY刚好相反。  
3. 将索引文件和数据文件分在不同的磁盘上存放(InnoDB引擎是在同一个表空间的)。  
4. 如果批量插入，则可以增加bluk_insert_buffer_size变量值提供速度(只对MyISAM有用)  
5. 当从一个文本文件装载一个表时，使用LOAD DATA INFILE，通常比INSERT语句快20倍。  

-->

1. 分批次插入。    
2. **<font color = "clime">需要记录每次插入数据的位置，</font>** 并且需要保证和批次插入的数据在同一个事务中，这样恢复之后可以从记录的位置开始继续插入。  


## 1.4. ~~快速删除大量(百万级)数据~~  

<!-- 
https://jingyan.baidu.com/article/48b37f8d2e0cad1a65648879.html
-->

&emsp; 采取分批删除的方法。  

## 亿级订单系统
<!-- 

亿级订单表数据存储
https://blog.csdn.net/ThreeAspects/article/details/103414095

https://blog.csdn.net/jokemqc/article/details/82834748
https://mp.weixin.qq.com/s/Sfs8HtkL1C_pckkzLG--2g


亿级订单数据分库分表设计方案（满足多维度查询：订单号、用户、商家、渠道）
https://www.jianshu.com/p/11d10910247b
10亿级订单系统分库分表设计思路
https://blog.csdn.net/jokemqc/article/details/82834748
亿级大表分库分表实战总结
https://segmentfault.com/a/1190000038577217
-->
<!-- 
https://www.jianshu.com/p/11d10910247b
--> 


