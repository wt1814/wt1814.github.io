

<!-- TOC -->

- [1. 分库/分片、分表](#1-分库分片分表)
    - [1.1. ~~数据切分方式~~](#11-数据切分方式)
    - [1.2. 分库分表方案(路由算法)](#12-分库分表方案路由算法)

<!-- /TOC -->

&emsp; **<font color = "clime">总结：</font>**  
1. 数据切分方式：  
    * 垂直分库，一般根据业务维度拆分，分布式项目中单项目单库。  
    * **<font color = "clime">`水平分库主要根据用户属性（如地市）拆分物理数据库。`一种常见的方式是将全省划分为多个大区。可以复合分片字段拆分，即按照用户属性（如地市）拆分后，再按照时间拆分。</font>**  
    * 垂直分表，基于列字段进行的。一般是表中的字段较多，将不常用的，数据较大，长度较长（比如text类型字段）的拆分到“扩展表”。  
    * ~~水平分表：针对数据量比较大的单张表。~~ **<font color = "red">MySql水平分表必须使用MyISAM引擎。</font>**  
2. 水平分库无论怎么分，只要能通过拆分字段和分片策略，找到具体的库就可以。  

# 1. 分库/分片、分表  
<!-- 
 分库分表：如何做到永不迁移数据和避免热点？ 
 https://mp.weixin.qq.com/s/qRCnD73nH_XuW0T_TWq8lg
-->

&emsp; **<font color = "clime">分库分表是为了支撑高并发、数据量大两个问题的。</font>**  

## 1.1. ~~数据切分方式~~
<!-- 

https://mp.weixin.qq.com/s/3ZCwKVLthoBZX4tkgfcuzA
-->
&emsp; ~~数据拆分后的优点~~   
&emsp; 数据切分分为两种方式，垂直(纵向)切分和水平(横向)切分。先垂直后水平。  

&emsp; **分库：**  
&emsp; 常见的分库方式有水平性和垂直性。一般来说，就是按照用户属性（地市或者ID的hash）进行分库，或者按照业务功能块进行分库。  
* 垂直分库：  
&emsp; 根据业务维度和数据的访问量等，进行数据的分离，剥离为多个数据库。 
* 水平分库：  
&emsp; 主要根据用户属性（如地市）拆分物理数据库。一种常见的方式是将全省划分为多个大区。可以复合分片字段拆分，即按照用户属性（如地市）拆分后，再按照时间拆分。    

&emsp; **分表：**  
* 垂直分表  
&emsp; 也就是“大表拆小表”，基于列字段进行的。一般是表中的字段较多，将不常用的，数据较大，长度较长（比如text类型字段）的拆分到“扩展表”。 一般是针对那种几百列的大表，也避免查询时，数据量太大造成的“跨页”问题。  
* 水平分表  
&emsp; 针对数据量巨大的单张表(比如订单表)，按照某种规则(RANGE，HASH取模等)，切分到多张表里面去。但是这些表还是在同一个库中，所以库级别的数据库操作还是有IO瓶颈。不建议采用。  
&emsp; **<font color = "red">MySql水平分表必须使用MyISAM引擎。</font>** 



&emsp; ⚠️注意：分库分表与分区是两个不同的解决方案，不冲突。  

<!-- 
 1.1.1. 垂直(纵向)切分  
* 垂直分表  
&emsp; 也就是“大表拆小表”，基于列字段进行的。一般是表中的字段较多，将不常用的，数据较大，长度较长(比如text类型字段)的拆分到“扩展表“。 一般是针对那种几百列的大表，也避免查询时，数据量太大造成的“跨页”问题。  
* 垂直分库  
&emsp; 垂直分库针对的是一个系统中的不同业务进行拆分，比如用户User一个库，商品Producet一个库，订单Order一个库。 切分后，要放在多个服务器上，而不是一个服务器上。为什么？ 想象一下，一个购物网站对外提供服务，会有用户，商品，订单等的CRUD。没拆分之前，全部都是落到单一的库上的，这会让数据库的单库处理能力成为瓶颈。按垂直分库后，如果还是放在一个数据库服务器上， 随着用户量增大，这会让单个数据库的处理能力成为瓶颈，还有单个服务器的磁盘空间，内存，tps等非常吃紧。 所以要拆分到多个服务器上，这样上面的问题都解决了，以后也不会面对单机资源问题。  
&emsp; 数据库业务层面的拆分，和服务的“治理”，“降级”机制类似，也能对不同业务的数据分别的进行管理，维护，监控，扩展等。数据库往往最容易成为应用系统的瓶颈，而数据库本身属于“有状态”的，相对于Web和应用服务器来讲，是比较难实现“横向扩展”的。 数据库的连接资源比较宝贵且单机处理能力也有限，在高并发场景下，垂直分库一定程度上能够突破IO、连接数及单机硬件资源的瓶颈。  
&emsp; 垂直分库就是根据业务耦合性，将关联度低的不同表存储在不同的数据库。做法与大系统拆分为多个小系统类似，按业务分类进行独立划分。与"微服务治理"的做法相似，每个微服务使用单独的一个数据库。  

 1.1.2. 水平(横向)切分  
* 水平分表  
&emsp; 针对数据量巨大的单张表(比如订单表)，按照某种规则(RANGE，HASH取模等)，切分到多张表里面去。但是这些表还是在同一个库中，所以库级别的数据库操作还是有IO瓶颈。不建议采用。  
&emsp; **<font color = "red">MySql水平分表必须使用MyISAM引擎。</font>**  
* 水平分库分表  
&emsp; 将单张表的数据切分到多个服务器上去，每个服务器具有相应的库与表，只是表中数据集合不同。水平分库分表能够有效的缓解单机和单库的性能瓶颈和压力，突破IO、连接数、硬件资源等的瓶颈。  
-->


## 1.2. 分库分表方案(路由算法)  
&emsp; **<font color = "red">分库分表步骤：根据容量(当前容量和增长量)评估分库或分表个数 -> 选key(均匀)-> 分表规则(hash或range等)-> 执行(一般双写)-> 扩容问题(尽量减少数据的移动)。</font>**   

&emsp; **<font color = "clime">常见的分片策略有随机分片和连续分片这两种，</font>** 如下图所示：  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/SQL/sql-13.png)  
&emsp; 当需要使用分片字段进行范围查找时，连续分片可以快速定位分片进行高效查询，大多数情况下可以有效避免跨分片查询的问题。后期如果想对整个分片集群扩容时，只需要添加节点即可，无需对其他分片的数据进行迁移。但是，连续分片也有可能存在数据热点的问题，就像图中按时间字段分片的例子，有些节点可能会被频繁查询压力较大，热数据节点就成为了整个集群的瓶颈。而有些节点可能存的是历史数据，很少需要被查询到。  
&emsp; 随机分片其实并不是随机的，也遵循一定规则。通常，会采用Hash取模的方式进行分片拆分，所以有些时候也被称为离散分片。随机分片的数据相对比较均匀，不容易出现热点和并发访问的瓶颈。但是，后期分片集群扩容起来需要迁移旧的数据。使用一致性Hash算法能够很大程度的避免这个问题，所以很多中间件的分片集群都会采用一致性Hash算法。离散分片也很容易面临跨分片查询的复杂问题。  
