
<!-- TOC -->

- [1. 分库分表带来的问题](#1-分库分表带来的问题)
    - [1.1. ★★★让系统从未分库分表动态切换到分库分表上](#11-★★★让系统从未分库分表动态切换到分库分表上)
    - [1.2. 分库数量](#12-分库数量)
    - [1.3. ID问题](#13-id问题)
    - [1.4. 基本的数据库增删改功能](#14-基本的数据库增删改功能)
    - [1.5. 查询功能](#15-查询功能)
    - [1.6. 跨分片事务](#16-跨分片事务)
    - [1.7. ~~数据迁移，容量规划，扩容等问题~~](#17-数据迁移容量规划扩容等问题)

<!-- /TOC -->

&emsp; **<font color = "red">总结：</font>**  

* 让系统从未分库分表动态切换到分库分表上：双写迁移。  
* **[分库分表查询](/docs/SQL/subSelect.md)**  


# 1. 分库分表带来的问题

## 1.1. ★★★让系统从未分库分表动态切换到分库分表上
&emsp; [如何设计才可以让系统从未分库分表动态切换到分库分表上？](/docs/projectImplement/implementation.md)  

* 停机迁移  
* 双写迁移  


## 1.2. 分库数量  
&emsp; 分库数量首先和单库能处理的记录数有关，一般来说，Mysql单库超过5000万条记录，Oracle单库超过1亿条记录，DB压力就很大（当然处理能力和字段数量/访问模式/记录长度有进一步关系）。  
&emsp; 在满足上述前提下，如果分库数量少，达不到分散存储和减轻DB性能压力的目的；如果分库的数量多，好处是每个库记录少，单库访问性能好，但对于跨多个库的访问，应用程序需要访问多个库，如果是并发模式，要消耗宝贵的线程资源；如果是串行模式，执行时间会急剧增加。  
&emsp; 最后分库数量还直接影响硬件的投入，一般每个分库跑在单独物理机上，多一个库意味多一台设备。所以具体分多少个库，要综合评估，一般初次分库建议分4-8个库。  

## 1.3. ID问题  
&emsp; 查看[分布式ID](/docs/microService/thinking/DistributedID.md)章节。  

## 1.4. 基本的数据库增删改功能  
&emsp; 批量插入：  

```sql
insert into user(id,name) values (1,"tianshouzhi"),(2,"huhuamin"), (3,"wanghanao"),(4,"luyang");
```
&emsp; **批量插入的sql是无法执行的，因为已经对库和表进行了拆分，这种sql语法只能操作mysql的单个库和单个表。** 所以必须将sql改成4条如下所示，然后分别到每个库上去执行。  

```sql
insert into user0(id,name) values  (4,"luyang");
insert into user1(id,name) values (1,"tianshouzhi");
insert into user2(id,name) values (2,"huhuamin");
insert into user3(id,name) values (3,"wanghanao");
```
&emsp; 具体流程可以用下图进行描述：  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/SQL/sql-14.png)  
1. sql解析：首先对sql进行解析，得到需要插入的四条记录的id字段的值分别为1,2,3,4。  
2. sql路由：sql路由包括库路由和表路由。库路由用于确定这条记录应该插入哪个库，表路由用于确定这条记录应该插入哪个表。  
3. sql改写：因为一条记录只能插入到一个库中，而上述批量插入的语法将会在 每个库中都插入四条记录，明显是不合适的，因此需要对sql进行改写，每个库只插入一条记录。  
4. sql执行：一条sql经过改写后变成了多条sql，为了提升效率应该并发的到不同的库上去执行，而不是按照顺序逐一执行。  
5. 结果集合并：每个sql执行之后，都会有一个执行结果，需要对分库分表的结果集进行合并，从而得到一个完整的结果。  

## 1.5. 查询功能
&emsp; 查看[分库分表查询](/docs/SQL/subSelect.md)  


## 1.6. 跨分片事务  
&emsp; 分库分表、跨分片事务，即分布式事务。参考[分布式事务](/docs/microService/thinking/DistributedTransaction.md)章节。  

## 1.7. ~~数据迁移，容量规划，扩容等问题~~  
&emsp; 很少有项目会在初期就开始考虑分片设计的，一般都是在业务高速发展面临性能和存储的瓶颈时才会提前准备。因此，不可避免的就需要考虑历史数据迁移的问题。一般做法就是通过程序先读出历史数据，然后按照指定的分片规则再将数据写入到各个分片节点中。  
&emsp; 此外，需要根据当前的数据量和QPS等进行容量规划，综合成本因素，推算出大概需要多少分片(一般建议单个分片上的单表数据量不要超过1000W)。  
&emsp; 如果是采用随机分片，则需要考虑后期的扩容问题，相对会比较麻烦。如果是采用的范围分片，只需要添加节点就可以自动扩容。  
