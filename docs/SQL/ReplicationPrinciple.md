

<!-- TOC -->

- [1. 主从复制](#1-主从复制)
    - [1.1. 主从复制简介](#11-主从复制简介)
    - [1.2. MySql主从复制原理](#12-mysql主从复制原理)
        - [1.2.1. 复制流程](#121-复制流程)
        - [1.2.2. 复制方式](#122-复制方式)
            - [1.2.2.1. 多线程复制](#1221-多线程复制)
        - [1.2.3. 复制类型](#123-复制类型)
            - [1.2.3.1. 基于语句的复制](#1231-基于语句的复制)
            - [1.2.3.2. 基于行的复制](#1232-基于行的复制)
            - [1.2.3.3. 混合模式复制](#1233-混合模式复制)

<!-- /TOC -->

&emsp; **<font color = "red">总结：</font>**  
1. 对于每一个主从复制的连接，都有三个线程。  
    * 拥有多个从库的主库为每一个连接到主库的从库创建一个binlog输出线程。  
    * 每一个从库都有它自己的I/O线程和SQL线程。  
        * I/O线程与主库进行连接，请求主库的binlog。接收到binlog后，会存储到relay log中（中继日志）。  
        * SQL线程会解析中继日志，并在从库上进行应用。  
2. 同步方式可以划分为：异步、半同步和同步。`在MySQL5.7中，带来了全新的多线程复制技术。`  
3. 复制类型有三种：基于行的复制、基于语句的复制、混合模式复制。  
    * 并非所有修改数据的语句都可以使用基于语句的复制进行复制。使用基于语句的复制时，任何非确定性行为都难以复制。  
    * 基于行的复制会产生大量的日志。  
    * MySQL5.1及其以后的版本推荐使用混合模式的复制，它是<font color = "clime">根据事件的类型实时的改变binlog的格式。当设置为混合模式时，默认为基于语句的格式，但在特定的情况下它会自动转变为基于行的模式。</font>  


# 1. 主从复制 
&emsp; **<font color = "red">部分参考《高性能MySql》</font>**
<!-- 
面试官：Mysql 中主库跑太快，从库追不上怎么整？ 
https://mp.weixin.qq.com/s/3OBZEYAbP4Yocr1EHoBhuw

大厂如何使用binlog解决多机房同步mysql数据(一)？ 
https://mp.weixin.qq.com/s/CXJHvTofKix6rR-ZZgeT_w
大厂如何基于binlog解决多机房同步mysql数据(二)？ 
https://mp.weixin.qq.com/s/d6cjgj8rxqKTw9AkKkpG9A
基于binlog的canal组件有哪些使用场景(三)？ 
https://mp.weixin.qq.com/s/X7-V7EQcnE0cK-NCfdsS1w

https://mp.weixin.qq.com/s/RtgLZW9ifNoB9wfAlflGKQ
-->
## 1.1. 主从复制简介  
&emsp; 什么是主从复制?  
&emsp; 主从复制，是用来建立一个和主数据库完全一样的数据库环境，称为从数据库；主数据库一般是准实时的业务数据库。

&emsp; 主从复制的作用：  
1. 做数据的热备，作为后备数据库，主数据库服务器故障后，可切换到从数据库继续工作，避免数据丢失。  
2. 架构的扩展。业务量越来越大，I/O访问频率过高，单机无法满足，此时做多库的存储，降低磁盘I/O访问的频率，提高单个机器的I/O性能。  
3. 读写分离，使数据库能支撑更大的并发。在报表中尤其重要。由于部分报表sql语句非常的慢，导致锁表，影响前台服务。如果前台使用master，报表使用slave，那么报表sql将不会造成前台锁，保证了前台速度。  

## 1.2. MySql主从复制原理  
<!-- 

-->
### 1.2.1. 复制流程  

&emsp; 主从复制如图：  
![image](http://www.wt1814.com/static/view/images/SQL/sql-129.png)  
&emsp; ~~对于每一个主从复制的连接，都有三个线程。拥有多个从库的主库为每一个连接到主库的从库创建一个binlog输出线程，每一个从库都有它自己的I/O线程和SQL线程。~~  

* 主库binlog输出线程：每当有从库连接到主库的时候，主库都会创建一个线程，然后发送binlog内容到从库。  
* 从库I/O线程：当START SLAVE语句在从库开始执行之后，从库创建一个I/O线程，该线程连接到主库并请求主库发送binlog里面的更新记录到从库上。从库I/O线程读取主库的binlog输出线程发送的更新并拷贝这些更新到本地文件，其中包括relay log文件。  
* 从库的SQL线程：从库创建一个SQL线程，这个线程读取从库I/O线程写到relay log的更新事件并执行。  

----
&emsp; 原理图2，帮助理解!   
![image](http://www.wt1814.com/static/view/images/SQL/sql-130.png)  
&emsp; 步骤一：主库db的更新事件(update、insert、delete)被写到binlog。  
&emsp; 步骤二：从库发起连接，连接到主库。  
&emsp; 步骤三：此时主库创建一个binlog dump thread线程，把binlog的内容发送到从库。  
&emsp; 步骤四：从库启动之后，创建一个I/O线程，读取主库传过来的binlog内容并写入到relay log。  
&emsp; 步骤五：还会创建一个SQL线程，从relay log里面读取内容，从Exec_Master_Log_Pos位置开始执行读取到的更新事件，将更新内容写入到slave的db。  

### 1.2.2. 复制方式
&emsp; 同步方式可以划分为：异步、半同步和同步。  

* 同步复制：指当主库执行完一个事务，所有的从库都执行了该事务才返回给客户端。因为需要等待所有从库执行完该事务才能返回，所以全同步复制的性能必然会收到严重的影响。需要有超时时间。  
* 异步复制：<font color = "red">MySQL默认的复制即是异步的，</font>主库在执行完客户端提交的事务后会立即将结果返给给客户端，并不关心从库是否已经接收并处理，<font color = "clime">这样就会有一个问题，主如果crash掉了，此时主上已经提交的事务可能并没有传到从上，如果此时，强行将从提升为主，可能导致新主库上的数据不完整。</font>  
* 半同步复制：介于异步复制和全同步复制之间，主库在执行完客户端提交的事务后不是立刻返回给客户端，而是等待至少一个从库接收到并写到relay log中才返回给客户端。相对于异步复制，半同步复制提高了数据的安全性，同时它也造成了一定程度的延迟，这个延迟最少是一个TCP/IP往返的时间。所以，半同步复制最好在低延时的网络中使用。  

#### 1.2.2.1. 多线程复制  
&emsp; 在MySQL5.7中，带来了全新的多线程复制技术。  
<!-- 
mysql5.7之后使用MTS并行复制技术，永久解决复制延时问题
https://mp.weixin.qq.com/s/dZNxgwmE2XvnYqZwweOQnw
https://blog.csdn.net/andong154564667/article/details/82117727
-->

### 1.2.3. 复制类型  
<!-- 

-->
&emsp; 复制类型有三种：基于行的复制、基于语句的复制、混合模式复制。  

#### 1.2.3.1. 基于语句的复制  
&emsp; 基于SQL语句的复制(statement-based replication, SBR)，每一条会修改数据的sql语句会记录到binlog中。  
&emsp; **优点：** 不需要记录每一条SQL语句与每行的数据变化(不记录select操作)，这样子binlog的日志也会比较少，减少了磁盘IO，提高性能。  
&emsp; **缺点：** <font color = "red">并非所有修改数据的语句都可以使用基于语句的复制进行复制。使用基于语句的复制时，任何非确定性行为都难以复制。</font>此类数据修改语言(DML)语句的示例包括以下内容：  
        
    依赖于UDF或不确定的存储程序的语句，因为这样的UDF或存储程序返回的值取决于提供给它的参数以外的因素。  
    不带ORDER BY的LIMIT子句的DELETE和UPDATE语句是不确定的。 
 
#### 1.2.3.2. 基于行的复制  
&emsp; 不记录每一条SQL语句的上下文信息，仅需记录哪条数据被修改了，修改成了什么样子了。  
&emsp; **优点：** 没有基于行的复制模式无法处理的场景。  
&emsp; **缺点：** 会产生大量的日志。  

#### 1.2.3.3. 混合模式复制  
&emsp; 混合模式复制(mixed-based replication, MBR)：MySQL5.1及其以后的版本推荐使用混合模式的复制，它是<font color = "clime">根据事件的类型实时的改变binlog的格式。当设置为混合模式时，默认为基于语句的格式，但在特定的情况下它会自动转变为基于行的模式。</font>  
&emsp; <font color = "red">当出现如下情况时，混合模式需要切换到基于行的复制：</font>  

* 该语句调用了：UUID函数；用户自定义函数(UDFs)；CURRENT_USER或USER函数；LOAD_FILE函数。
* 同一个语句更改了两张或更多包含AUTO_INCREMENT列的表。
* 语句中使用了服务器变量。
* 存储引擎不允许使用基于语句复制，如：MySQL Cluster引擎。



