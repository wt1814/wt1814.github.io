
<!-- TOC -->

- [1. 主从复制](#1-主从复制)
    - [1.1. MySql主从复制原理](#11-mysql主从复制原理)
        - [1.1.1. 复制流程](#111-复制流程)
        - [1.1.2. 同步方式](#112-同步方式)
        - [1.1.3. 复制方式](#113-复制方式)
            - [1.1.3.1. 基于语句的复制](#1131-基于语句的复制)
            - [1.1.3.2. 基于行的复制](#1132-基于行的复制)
            - [1.1.3.3. 混合模式复制](#1133-混合模式复制)
    - [1.2. MySql主从复制的高可用](#12-mysql主从复制的高可用)
    - [1.3. MySql主从复制的问题](#13-mysql主从复制的问题)
    - [1.4. 读写分离](#14-读写分离)

<!-- /TOC -->

![image](https://gitee.com/wt1814/pic-host/raw/master/images/SQL/sql-64.png)  

&emsp; **<font color = "red">部分参考《高性能MySql》</font>**

# 1. 主从复制  
## 1.1. MySql主从复制原理  
<!-- https://mp.weixin.qq.com/s?__biz=MzU4NzYwNDAwMg==&mid=2247486953&idx=3&sn=8ce915a119d7a1d2bf32d82a1ece24ba&chksm=fde8c4a4ca9f4db2e9c40e65efcaefb9318dedb36411865b269b7b8026a80d250f45652f49a1&mpshare=1&scene=1&srcid=&sharer_sharetime=1587486135950&sharer_shareid=b256218ead787d58e0b58614a973d00d&key=79150dbf571fbc4896e24bfaa10bc51f375d54f7b7955b16d5d149611cc4488bc9bb38846d3564a0c365d73f8ebb056576cdee8f51847f3cd52bf867f4313410b386328262394bab8dd1a1d65bf80df6&ascene=1&uin=MTE1MTYxNzY2MQ%3D%3D&devicetype=Windows+10&version=62080079&lang=zh_CN&exportkey=ASnTeJ9F3S7ijOQUsEABecA%3D&pass_ticket=t7WrYQgRWkv7fomJ9tKSvYV9vbBBrtBhylesb1eYH1AGZ3bs%2FIfhN20euL1DBMbi -->
### 1.1.1. 复制流程  
&emsp; replication的工作流程分为以下3个步骤：  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/SQL/sql-27.png)  
1. 主服务器（master）把数据更改记录到二进制日志（binlog）中。  
2. 从服务器（slave）把主服务器的二进制日志复制到自己的中继日志（relay log）中。  
3. 从服务器重做日志中的日志，把更改应用到自己的数据库上，以达到数据的最终一致性。  

### 1.1.2. 同步方式
&emsp; 同步方式可以划分为：异步、半同步和同步。  

* 同步复制：指当主库执行完一个事务，所有的从库都执行了该事务才返回给客户端。因为需要等待所有从库执行完该事务才能返回，所以全同步复制的性能必然会收到严重的影响。需要有超时时间。  
* 异步复制：<font color = "red">MySQL默认的复制即是异步的，</font>主库在执行完客户端提交的事务后会立即将结果返给给客户端，并不关心从库是否已经接收并处理，<font color = "lime">这样就会有一个问题，主如果crash掉了，此时主上已经提交的事务可能并没有传到从上，如果此时，强行将从提升为主，可能导致新主上的数据不完整。</font>  
* 半同步复制：介于异步复制和全同步复制之间，主库在执行完客户端提交的事务后不是立刻返回给客户端，而是等待至少一个从库接收到并写到relay log中才返回给客户端。相对于异步复制，半同步复制提高了数据的安全性，同时它也造成了一定程度的延迟，这个延迟最少是一个TCP/IP往返的时间。所以，半同步复制最好在低延时的网络中使用。  

### 1.1.3. 复制方式  
<!-- https://www.jianshu.com/p/047185a672f6 -->
&emsp; 复制方式有三种：基于行的复制、基于语句的复制、混合模式复制。  

#### 1.1.3.1. 基于语句的复制  
&emsp; 基于SQL语句的复制(statement-based replication, SBR)，每一条会修改数据的sql语句会记录到binlog中。  
&emsp; **优点：** 不需要记录每一条SQL语句与每行的数据变化（不记录select操作），这样子binlog的日志也会比较少，减少了磁盘IO，提高性能。  
&emsp; **缺点：** <font color = "red">并非所有修改数据的语句都可以使用基于语句的复制进行复制。使用基于语句的复制时，任何非确定性行为都难以复制。</font>此类数据修改语言（DML）语句的示例包括以下内容：  
        
    依赖于UDF或不确定的存储程序的语句，因为这样的UDF或存储程序返回的值取决于提供给它的参数以外的因素。  
    不带ORDER BY的LIMIT子句的DELETE和UPDATE语句是不确定的。 
 
#### 1.1.3.2. 基于行的复制  
&emsp; 不记录每一条SQL语句的上下文信息，仅需记录哪条数据被修改了，修改成了什么样子了。  
&emsp; **优点：** 没有基于行的复制模式无法处理的场景。  
&emsp; **缺点：** 会产生大量的日志。  

#### 1.1.3.3. 混合模式复制  
&emsp; 混合模式复制(mixed-based replication, MBR)：MySQL5.1及其以后的版本推荐使用混合模式的复制，它是<font color = "lime">根据事件的类型实时的改变binlog的格式。当设置为混合模式时，默认为基于语句的格式，但在特定的情况下它会自动转变为基于行的模式。</font>  
&emsp; <font color = "red">当出现如下情况时，混合模式需要切换到基于行的复制：</font>  

* 该语句调用了：UUID函数；用户自定义函数(UDFs);CURRENT_USER或USER函数；LOAD_FILE函数。
* 同一个语句更改了两张或更多包含AUTO_INCREMENT列的表。
* 语句中使用了服务器变量。
* 存储引擎不允许使用基于语句复制，如：MySQL Cluster引擎。

## 1.2. MySql主从复制的高可用  
&emsp; [主从复制的高可用](/docs/SQL/replicationAvailability.md)   

## 1.3. MySql主从复制的问题
&emsp; [主从复制的问题](/docs/SQL/replicationProblem.md)  

## 1.4. 读写分离  
&emsp; [读写分离](/docs/SQL/SeparationReade.md)  


