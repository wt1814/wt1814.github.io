


# 主从复制延迟
<!--
mysql查看主从延迟
https://blog.csdn.net/weixin_39522170/article/details/113158264
解决思路
https://www.cnblogs.com/wangtao_20/p/6711144.html
-->

&emsp; 产生延迟的两种方式：  

* 突然产生延迟，然后再跟上；  
* 稳定的延迟增大  

&emsp; 前者通常是由于一条执行时间过长的 SQL 导致，而后者即使在没有慢语句也会出现。  
&emsp; 对于前者，可以通过备库上的慢查询日志来进行优化。在备库上开启 log_slow_slave_statement 选项，可以在慢查询日志中记录复制线程执行的语句。  


&emsp; ~~而对于后者，没有针对性的解决方案，只能通过各种方式提高备库的复制效率。而想去对备库做优化时，会发现，除了购买更快的磁盘和 CPU，并没有太多的调优空间。只能通过 MySQL 选项禁止某些额外的工作以减少备库的复制。可以通过下面几种方式：~~    
1. 使用 InnoDB 引擎时，设置 innodb_flush_log_at_trx_commit 值为 2，来使备库不要频繁的刷新磁盘，以提高事务提交效率。  
2. 禁止二进制日志记录。把 innodb_locks_unsafe_for_binlog 设置为 1，并把MyISAM的delay_key_write设置为ALL。要注意的是，这些设置是以安全换取速度，在将备库提升为主库时，记得把这些选项设置回安全的值。  
3. 拆分效率较低的复制 SQL，分离复杂语句中的 SELECT 和 UPDATE 语句，降低复制消耗，提高效率。

#### 1.2.1.1. 并行复制  
&emsp; 可以使用并行复制(并行是指从库多个SQL线程并行执行relay log)，解决从库复制延迟的问题。  
&emsp; MySQL 5.7中引入基于组提交的并行复制，其核心思想：一个组提交的事务都是可以并行回放，因为这些事务都已进入到事务的prepare阶段，则说明事务之间没有任何冲突(否则就不可能提交)。  
&emsp; 判断事务是否处于一个组是通过last_committed变量，last_committed表示事务提交的时候，上次事务提交的编号，如果事务具有相同的last_committed，则表示这些事务都在一组内，可以进行并行的回放。  


