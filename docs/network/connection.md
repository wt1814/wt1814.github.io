
<!-- TOC -->

- [1. 长短连接](#1-长短连接)
    - [1.1. 长短连接介绍](#11-长短连接介绍)
    - [1.2. TCP长短连接](#12-tcp长短连接)
        - [1.2.1. 长连接](#121-长连接)
        - [1.2.2. 短链接](#122-短链接)
        - [1.2.3. 长连接和短连接的优点、缺点、适用场景](#123-长连接和短连接的优点缺点适用场景)
            - [1.2.3.1. 长连接](#1231-长连接)
            - [1.2.3.2. 短连接](#1232-短连接)
    - [1.3. HTTP长短连接](#13-http长短连接)

<!-- /TOC -->


&emsp; **<font color = "red">总结：</font>**  
1. TCP长连接  
	1. **<font color = "red">长连接，指在一个连接上可以连续发送多个数据包，在连接保持期间，如果没有数据包发送，需要双方发链路检测包。</font>**   
	&emsp; `长连接没有条件能够判断读写什么时候结束，所以必须要加报文头的长度。`读函数先是读取报文头的长度，再根据这个长度去读相应长度的报文。  
	2. 流程：TCP连接→数据包传输→保持连接(心跳)→数据传输→保持连接(心跳)→……→关闭连接（一个TCP连接通道有多个读写通信）。  
	![image](https://gitee.com/wt1814/pic-host/raw/master/images/network/TCP-4.png)   
	3. 优点：  
	&emsp; 可以省去较多的TCP建立和关闭的操作，减少浪费，节约时间。 
	4. 缺点：
	    * 服务器端有很多TCP连接时，会降低服务器的性能。
	    * 需要管理所有的TCP连接，检测是否是无用的连接（长时间没有读写事件），并进行关闭等操作。  
	&emsp; 解决方案：  
	&emsp; 如关闭一些长时间没有读写事件发生的连接，这样可以避免一些恶意连接导致server端服务受损；如果条件再允许就可以以客户端机器为颗粒度，限制每个客户
2. TCP短链接 
	1. 短连接是指通信双方有数据交互时，就建立一个TCP连接，数据发送完成后，则断开此TCP连接（管理起来比较简单，存在的连接都是有用的连接，不需要额外的控制手段）。  
	2. 流程：连接→数据传输→关闭连接→连接→数据传输→关闭连接。  
	![image](https://gitee.com/wt1814/pic-host/raw/master/images/network/TCP-5.png)   
	3. 优点：  
	&emsp; 对于服务器来说管理较为简单，存在的连接都是有用的连接，不需要额外的控制手段。  
	4. 缺点：  
	&emsp; 但如果客户请求频繁，将在TCP的建立和关闭操作上浪费较多时间和带宽。  
3. TCP长短连接使用场景：  
    1. 长连接多用于操作频繁，点对点的通讯，而且连接数不能太多情况。每个TCP连接都需要三次握手，这需要时间，如果每个操作都是短连接，再操作的话那么处理速度会降低很多，所以每个操作完后都不断开，下次处理时直接发送数据包就OK了，不用建立TCP连接。例如：数据库的连接用长连接，如果用短连接频繁的通信会造成socket错误，而且频繁的socket 创建也是对资源的浪费。  
    2. 像WEB网站的http服务一般都用短链接，因为长连接对于服务端来说会耗费一定的资源，像WEB网站这么频繁的成千上万甚至上亿客户端的连接用短连接会更省一些资源，如果用长连接，而且同时有成千上万的用户，如果每个用户都占用一个连接的话，那可想而知吧。所以并发量大，但每个用户无需频繁操作情况下需用短连好。  
4. HTTP长短连接  
&emsp; HTTP的长连接和短连接本质上是TCP长连接和短连接。  


# 1. 长短连接
<!-- 

https://developer.aliyun.com/article/37987
-->


## 1.1. 长短连接介绍
&emsp; **<font color = "red">长连接，指在一个连接上可以连续发送多个数据包，在连接保持期间，如果没有数据包发送，需要双方发链路检测包。</font>**  
&emsp; 长连接多用于操作频繁，点对点的通讯，而且连接数不能太多情况。每个TCP连接都需要三次握手，这需要时间，如果每个操作都是短连接，再操作的话那么处理速度会降低很多，所以每个操作完后都不断开，下次处理时直接发送数据包就OK了，不用建立TCP连接。例如：数据库的连接用长连接，如果用短连接频繁的通信会造成socket错误，而且频繁的socket 创建也是对资源的浪费。  

&emsp; **<font color = "red">短连接是指通讯双方有数据交互时，就建立一个连接，数据发送完成后，则断开此连接，即每次连接只完成一项业务的发送。</font>**    
&emsp; 像WEB网站的http服务一般都用短链接，因为长连接对于服务端来说会耗费一定的资源，像WEB网站这么频繁的成千上万甚至上亿客户端的连接用短连接会更省一些资源，如果用长连接，而且同时有成千上万的用户，如果每个用户都占用一个连接的话，那可想而知吧。所以并发量大，但每个用户无需频繁操作情况下需用短连好。  


## 1.2. TCP长短连接
<!-- 
https://blog.csdn.net/zhizhengguan/article/details/107866641
https://blog.csdn.net/seanxwq/article/details/115703360

-->

&emsp; 当网络通信时采用TCP协议时，在真正的读写操作之前，server与client之间必须建立一个连接，当读写操作完成后，双方不再需要这个连接时它们可以释放这个连接，连接的建立是需要三次握手的，而释放则需要4次挥手，所以说每个连接的建立都是需要资源消耗和时间消耗的。  

&emsp; `TCP本身并没有长短连接的区别，长短与否，完全取决于怎么使用它。`  

* 短连接：每次通信时，创建 Socket；一次通信结束，调用 socket.close()。这就是一般意义上的短连接，短连接的好处是管理起来比较简单，存在的连接都是可用的连接，不需要额外的控制手段。  
* 长连接：每次通信完毕后，不会关闭连接，这样就可以做到连接的复用。长连接的好处便是省去了创建连接的耗时。  


### 1.2.1. 长连接  
&emsp; 所谓长连接，指在一个TCP连接上可以连续发送多个数据包，在TCP连接保持期间，如果没有数据包发送，需要双方发检测包以维持此连接，一般需要自己做在线维持（不发生RST包和四次挥手）。  
&emsp; `长连接没有条件能够判断读写什么时候结束，所以必须要加报文头的长度。`读函数先是读取报文头的长度，再根据这个长度去读相应长度的报文。  

&emsp; 流程：TCP连接→数据包传输→保持连接(心跳)→数据传输→保持连接(心跳)→……→关闭连接（一个TCP连接通道有多个读写通信）。  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/network/TCP-4.png)   


&emsp; TCP保活功能：保活功能主要为服务器应用提供，服务器应用希望知道客户主机是否崩溃，从而可以代表客户使用资源。如果客户已经消失，使得服务器上保留一个半开放的连接，而服务器又在等待来自客户端的数据，则服务器将永远等待客户端的数据，保活功能就是试图在服务器端检测到这种半开放的连接。  
&emsp; 如果一个给定的连接在两小时内没有任何的动作，则服务器就向客户发一个探测报文段，客户主机必须处于以下4个状态之一：  

* 客户主机依然正常运行，并从服务器可达。客户的TCP响应正常，而服务器也知道对方是正常的，服务器在两小时后将保活定时器复位。  
* 客户主机已经崩溃，并且关闭或者正在重新启动。在任何一种情况下，客户的TCP都没有响应。服务端将不能收到对探测的响应，并在75秒后超时。服务器总共发送10个这样的探测 ，每个间隔75秒。如果服务器没有收到一个响应，它就认为客户主机已经关闭并终止连接。  
* 客户主机崩溃并已经重新启动。服务器将收到一个对其保活探测的响应，这个响应是一个复位，使得服务器终止这个连接。  
* 客户机正常运行，但是服务器不可达，这种情况与2类似，TCP能发现的就是没有收到探查的响应。  

### 1.2.2. 短链接
&emsp; 短连接是指通信双方有数据交互时，就建立一个TCP连接，数据发送完成后，则断开此TCP连接（管理起来比较简单，存在的连接都是有用的连接，不需要额外的控制手段）。  

&emsp; 流程：连接→数据传输→关闭连接→连接→数据传输→关闭连接。  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/network/TCP-5.png)   


### 1.2.3. 长连接和短连接的优点、缺点、适用场景
#### 1.2.3.1. 长连接
1. 优点：  
&emsp; 可以省去较多的TCP建立和关闭的操作，减少浪费，节约时间。   
2. 缺点：
    * 服务器端有很多TCP连接时，会降低服务器的性能。
    * 需要管理所有的TCP连接，检测是否是无用的连接（长时间没有读写事件），并进行关闭等操作。  
&emsp; 解决方案：  
&emsp; 如关闭一些长时间没有读写事件发生的连接，这样可以避免一些恶意连接导致server端服务受损；如果条件再允许就可以以客户端机器为颗粒度，限制每个客户端的最大长连接数，这样可以完全避免某个蛋疼的客户端连累后端服务。  

3. 适用场景：  
&emsp; 长连接多用于操作频繁（读写），点对点的通讯，而且连接数不能太多情况。  
&emsp; 例如：数据库的连接用长连接， 如果用短连接频繁的通信会造成socket错误，而且频繁的socket 创建也是对资源的浪费。  

#### 1.2.3.2. 短连接
1. 优点：  
&emsp; 对于服务器来说管理较为简单，存在的连接都是有用的连接，不需要额外的控制手段。  
2. 缺点：  
&emsp; 但如果客户请求频繁，将在TCP的建立和关闭操作上浪费较多时间和带宽。  
3. 适用场景：  
&emsp; 短连接用于并发量大，且每个用户无需频繁向服务器发数据包。 而像WEB网站的http服务一般都用短链接。因为长连接对于服务端来说会耗费一定的资源像，WEB网站这么频繁的成千上万甚至上亿客户端的连接用短连接会更省一些资源。  

## 1.3. HTTP长短连接
<!-- 
没看  http长连接
https://www.cnblogs.com/cswuyg/p/3653263.html
-->
&emsp; HTTP的长连接和短连接本质上是TCP长连接和短连接。    
&emsp; 在HTTP/1.0中默认使用短连接。也就是说，客户端和服务器每进行一次HTTP操作，就建立一次连接，任务结束就中断连接。当客户端浏览器访问的某个HTML或其他类型的Web页中包含有其他的Web资源（如JavaScript文件、图像文件、CSS文件等），每遇到这样一个Web资源，浏览器就会重新建立一个HTTP会话。  
&emsp; 而从HTTP/1.1起，默认使用长连接，用以保持连接特性。使用长连接的HTTP协议，会在响应头加入这行代码：  

```text
Connection:keep-alive
```

&emsp; 在使用长连接的情况下，当一个网页打开完成后，客户端和服务器之间用于传输HTTP数据的TCP连接不会关闭，客户端再次访问这个服务器时，会继续使用这一条已经建立的连接。Keep-Alive不会永久保持连接，它有一个保持时间，可以在不同的服务器软件（如Apache）中设定这个时间。实现长连接需要客户端和服务端都支持长连接。  

&emsp; 长连接的过期时间  
&emsp; 客户端的长连接不可能无限期的拿着，会有一个超时时间，服务器有时候会告诉客户端超时时间，譬如：  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/network/TCP-6.png)   
&emsp; 上图中的Keep-Alive: timeout=20，表示这个TCP通道可以保持20秒。另外还可能有max=XXX，表示这个长连接最多接收XXX次请求就断开。对于客户端来说，如果服务器没有告诉客户端超时时间也没关系，服务端可能主动发起四次握手断开TCP连接，客户端能够知道该TCP连接已经无效；另外TCP还有心跳包来检测当前连接是否还活着，方法很多，避免浪费资源。  


