

<!-- TOC -->

- [1. HTTPS](#1-https)
    - [1.1. SSL/TLS](#11-ssltls)
        - [1.1.1. SSL的体系结构](#111-ssl的体系结构)
        - [1.1.2. SSL证书](#112-ssl证书)
            - [1.1.2.1. 为什么需要 CA 认证机构颁发证书？](#1121-为什么需要-ca-认证机构颁发证书)
            - [1.1.2.2. SSL证书类型](#1122-ssl证书类型)
            - [1.1.2.3. SSL证书存放位置](#1123-ssl证书存放位置)
    - [1.2. HTTPS工作原理](#12-https工作原理)
        - [1.2.1. ★★★工作流程](#121-★★★工作流程)
        - [1.2.2. 一些问题](#122-一些问题)
            - [1.2.2.1. 为什么数据传输是用对称加密？](#1221-为什么数据传输是用对称加密)
            - [1.2.2.2. ★★★本地随机数被窃取怎么办？](#1222-★★★本地随机数被窃取怎么办)
            - [1.2.2.3. 用了 HTTPS 会被抓包吗？](#1223-用了-https-会被抓包吗)
    - [1.3. HTTP和HTTPS的区别：](#13-http和https的区别)

<!-- /TOC -->

&emsp; **<font color = "red">总结：</font>**  
1. **<font color = "clime">HTTPS的整体过程分为证书验证、协商密钥、数据传输阶段。</font>**  
    1. 证书验证阶段，一次交互，客户端发送请求，获取到服务端的证书，并进行校验。若不合法，进行警告。  
    2. 协商密钥阶段，采取非对称加密。客户端用公钥对随机数进行加密和传输；服务端用私钥解密随机数，获取到随机数，完成连接。 **<font color = "clime">~~注：非对称加密的目的就是让服务端得到这个随机值，以后客户端和服务端的通信就可以通过这个随机值来进行加密解密。~~</font>**  
    3. 完成连接后，采用对称加密进行数据传输。  
2. 本地随机数会被窃取嘛？  
&emsp; HTTPS并不包含对随机数的安全保证，HTTPS保证的只是传输过程安全，<font color = "red">而随机数存储于本地，本地的安全属于另一安全范畴。</font>  


# 1. HTTPS  
&emsp; HTTPS(Secure Hypertext Transfer Protocol)安全超文本传输协议，是一个安全通信通道，它基于HTTP开发用于在客户计算机和服务器之间交换信息。它使用安全套接字层(SSL)进行信息交换，简单来说它是HTTP的安全版，是使用TLS/SSL加密的HTTP协议。HTTP协议采用明文传输信息，存在信息窃听、信息篡改和信息劫持的风险，而协议TLS/SSL具有身份验证、信息加密和完整性校验的功能，可以避免此类问题发生。  

<!-- 
主要有三个原因：
    保护隐私(Privacy)：所有信息都是加密传播，第三方无法窃听数据。如果使用HTTP明文传输数据的话，很可能被第三方劫持数据，那么所输入的密码或者其他个人资料都被暴露在他人面前，后果可想而知。
    数据完整性(Integraty)：一旦第三方篡改了数据，接收方会知道数据经过了篡改，这样便保证了数据在传输过程中不被篡改 —— 数据的完整性。
    身份认证(Identification)：第三方不可能冒充身份参与通信，因为服务器配备了由证书颁发机构(Certificate Authority，简称CA)颁发的安全证书，可以证实服务器的身份信息，防止第三方冒充身份。(也有少数情况下，通信需要客户端提供证书，例如银行系统，需要用户在登录的时候，插入银行提供给用户的USB，就是需要客户端提供证书，用来验证客户的身份信息。)
-->

---

## 1.1. SSL/TLS  
&emsp; SSL(Secure Sockets Layer安全套接层)，及其继任者传输层安全(Transport Layer Security，TLS)是为网络通信提供安全及数据完整性的一种安全协议。TLS/SSL在传输层与应用层之间对网络连接进行加密。  
&emsp; **<font color = "red">TLS/SSL是介于TCP和HTTP之间的一层安全协议，</font>** 不影响原有的TCP协议和HTTP协议，所以使用HTTPS基本上不需要对HTTP页面进行太多的改造。  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/network/https-1.png)  
&emsp; **<font color = "clime">SSL协议提供的服务主要有：</font>**  
1. 认证用户和服务器，确保数据发送到正确的客户机和服务器。  
2. 加密数据以防止数据中途被窃取。  
3. 维护数据的完整性，确保数据在传输过程中不被改变。  

### 1.1.1. SSL的体系结构  
&emsp; SSL的体系结构中包含两个协议子层，其中底层是SSL记录协议层(SSL Record Protocol Layer)；高层是SSL握手协议层(SSL HandShake Protocol Layer)。SSL的协议栈如图所示，其中阴影部分即SSL协议。  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/network/https-2.png)  
&emsp; SSL记录协议层的作用是为高层协议提供基本的安全服务。SSL记录协议针对HTTP协议进行了特别的设计，使得超文本的传输协议HTTP能够在SSL运行。纪录封装各种高层协议，具体实施压缩解压缩、加密解密、计算和校验MAC等与安全有关的操作。  
&emsp; SSL握手协议层包括SSL握手协议(SSL HandShake Protocol)、SSL密码参数修改协议(SSL Change Cipher Spec Protocol)、应用数据协议(Application Data Protocol)和SSL告警协议(SSL Alert Protocol)。握手层的这些协议用于SSL管理信息的交换，允许应用协议传送数据之间相互验证，协商加密算法和生成密钥等。SSL握手协议的作用是协调客户和服务器的状态，使双方能够达到状态的同步。  

### 1.1.2. SSL证书  
#### 1.1.2.1. 为什么需要 CA 认证机构颁发证书？  
<!-- 
https://mp.weixin.qq.com/s/SNNxTHBrjGbbQbYkCfuzSQ
https://mp.weixin.qq.com/s/Chwz0b8IBlkB6hoxI-_wyQ
-->
&emsp; **<font color = "red">为了防止中间人攻击。</font>** “中间人攻击”的具体过程如下：  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/network/https-4.png)  
&emsp; 过程原理如下：  

* 本地请求被劫持(如 DNS 劫持等)，所有请求均发送到中间人的服务器。
* 中间人服务器返回中间人自己的证书。
* 客户端创建随机数，通过中间人证书的公钥对随机数加密后传送给中间人，然后凭随机数构造对称加密对传输内容进行加密传输。
* 中间人因为拥有客户端的随机数，可以通过对称加密算法进行内容解密。
* 中间人以客户端的请求内容再向正规网站发起请求。
* 因为中间人与服务器的通信过程是合法的，正规网站通过建立的安全通道返回加密后的数据。
* 中间人凭借与正规网站建立的对称加密算法对内容进行解密。
* 中间人通过与客户端建立的对称加密算法对正规内容返回的数据进行加密传输。
* 客户端通过与中间人建立的对称加密算法对返回结果数据进行解密。  

&emsp; 由于缺少对证书的验证，所以客户端虽然发起的是 HTTPS 请求，但客户端完全不知道自己的网络已被拦截，传输内容被中间人全部窃取。  

#### 1.1.2.2. SSL证书类型  
&emsp; SSL证书根据可信强度，大概可以分为：域名型证书(DV SSL)、企业型证书(OV SSL)、增强型证书(EV SSL)三种。现在所说的免费SSL证书都是最低级别的DV SSL证书。  

#### 1.1.2.3. SSL证书存放位置  
&emsp; HTTPS需要使用一套CA数字证书，证书内会附带一个公钥Pub，而与之对应的私钥Private保留在服务端不公开。  
&emsp; 服务端通常会将SSL证书存储在Nginx、Apache这些反向代理服务器中，进行https加密。  
&emsp; 客户端会将SSL证书直接内置在各大操作系统(或者浏览器)的出厂设置里。  

------------------------------------------
## 1.2. HTTPS工作原理  

### 1.2.1. ★★★工作流程  
&emsp; **<font color = "red">HTTPS的整体过程分为证书验证、协商密钥、数据传输阶段。</font><font color = "clime">协商密钥使用非对称加密；数据传输使用对称加密。</font>** 具体的交互过程如下：  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/network/https-3.png)  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/network/https-5.png)  

&emsp; &emsp; **<font color = "red">证书验证阶段：</font>**  
1. 客户端发起HTTPS请求：浏览器将支持的加密算法信息发送给服务器；  
2. 服务端返回HTTPS证书：服务器选择一套浏览器支持的加密算法，以证书的形式回发浏览器；  
&emsp; &emsp; 注：采用HTTPS协议的服务器必须要有一套数字证书，可以自己制作，也可以向组织申请。区别就是自己颁发的证书需要客户端验证通过，才可以继续访问，而使用受信任的公司申请的证书则不会弹出提示页面。这套证书其实就是一对公钥和私钥。传送证书时，只传送证书的公钥。  
3. 客户端解析证书：客户端对证书的有效期、合法性、域名是否与请求的域名一致、证书的公钥等进行校验。首先会验证公钥是否有效，比如颁发机构，过期时间等等，如果发现异常，则会弹出一个警告框，提示证书存在问题。  
&emsp; **<font color = "red">协商密钥阶段：</font>**  
4. 如果证书没有问题，客户端生成一个随机值(对称密钥)。然后用证书的公共密钥对该随机值(对称密钥)进行加密。  
5. 客户端传送加密信息，这部分传送的是用证书加密后的随机值， **<font color = "clime">目的就是让服务端得到这个随机值，以后客户端和服务端的通信就可以通过这个随机值来进行加密解密。</font>**  
&emsp; 注：权威机构的证书的公钥等信息直接内置在各大操作系统(或者浏览器)的出厂设置里；非权威机构的证书需要手动安装。  
6. 服务端解密信息、传输加密后的信息：服务器使用私钥解密信息，验证哈希，加密响应消息回发浏览器；  
7. 客户端解密信息：浏览器解密响应消息，并对消息进行验真，之后进行加密交互数据；  



### 1.2.2. 一些问题  
#### 1.2.2.1. 为什么数据传输是用对称加密？  
&emsp; 首先，<font color = "red">非对称加密的加解密效率是非常低的，</font>而HTTP的应用场景中通常端与端之间存在大量的交互，非对称加密的效率是无法接受的。  
&emsp; 另外，<font color = "red">在HTTPS的场景中只有服务端保存了私钥，一对公私钥只能实现单向的加解密，</font>所以HTTPS中内容传输加密采取的是对称加密，而不是非对称加密。  

#### 1.2.2.2. ★★★本地随机数被窃取怎么办？  
&emsp; 证书验证是采用非对称加密实现，但是传输过程是采用对称加密，而其中对称加密算法中重要的随机数是由本地生成并且存储于本地的，HTTPS如何保证随机数不会被窃取？  
&emsp; 其实 HTTPS 并不包含对随机数的安全保证，HTTPS 保证的只是传输过程安全，<font color = "red">而随机数存储于本地，本地的安全属于另一安全范畴，应对的措施有安装杀毒软件、反木马、浏览器升级修复漏洞等。</font>  

#### 1.2.2.3. 用了 HTTPS 会被抓包吗？
&emsp; HTTPS 的数据是加密的，常规下抓包工具代理请求后抓到的包内容是加密状态，无法直接查看。  
&emsp; 但是，浏览器只会提示安全风险，如果用户授权仍然可以继续访问网站，完成请求。因此，只要客户端是自己的终端，授权的情况下，便可以组建中间人网络，而抓包工具便是作为中间人的代理。通常HTTPS抓包工具的使用方法是会生成一个证书，用户需要手动把证书安装到客户端中，然后终端发起的所有请求通过该证书完成与抓包工具的交互，然后抓包工具再转发请求到服务器，最后把服务器返回的结果在控制台输出后再返回给终端，从而完成整个请求的闭环。  
&emsp; 既然HTTPS不能防抓包，那 HTTPS 有什么意义？HTTPS 可以防止用户在不知情的情况下通信链路被监听，对于主动授信的抓包操作是不提供防护的，因为这个场景用户是已经对风险知情。要防止被抓包，需要采用应用级的安全防护，例如采用私有的对称加密，同时做好移动端的防反编译加固，防止本地算法被破解。  

------------------------------------------
## 1.3. HTTP和HTTPS的区别：  
1. http是超文本传输协议，信息是明文传输；https则是具有安全性的ssl加密传输协议。  
2. https协议需要CA证书。  
3. http和https使用的是完全不同的连接方式，用的端口也不一样，前者是80，后者是443。  
