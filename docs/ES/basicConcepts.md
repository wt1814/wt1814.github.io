
<!-- TOC -->

- [1. ES基本概念](#1-es基本概念)
    - [1.1. ~~ES数据架构~~](#11-es数据架构)
        - [1.1.1. 索引(Index)](#111-索引index)
        - [1.1.2. ~~类型(Type)~~](#112-类型type)
        - [1.1.3. 映射(mapping)](#113-映射mapping)
        - [1.1.4. 文档(document)](#114-文档document)
    - [1.2. 倒排索引](#12-倒排索引)
        - [1.2.1. 示例](#121-示例)
        - [1.2.2. 核心组成](#122-核心组成)
        - [1.2.3. 倒排索引是怎么工作的？](#123-倒排索引是怎么工作的)
            - [1.2.3.1. 创建倒排索引](#1231-创建倒排索引)
            - [1.2.3.2. 倒排索引搜索](#1232-倒排索引搜索)
    - [1.3. 分析(建索引与检索)](#13-分析建索引与检索)
        - [1.3.1. ~~索引与查询~~](#131-索引与查询)
        - [1.3.2. ik中文分词器](#132-ik中文分词器)

<!-- /TOC -->

&emsp; **<font color = "red">总结：</font>**  
1. ES是一个`分布式`的`搜索`框架。  
1. **<font color = "blue">ES数据结构</font>**  
&emsp; 索引Index（数据库） ---> 映射Mapping（表结构） ---> 文档Fields（一行数据）  
&emsp; **<font color = "clime">★★★注：文档的元数据（有哪些字段）是由映射Mapping决定的。</font>**    
&emsp; **~~ES中索引的元数据包含Mapping信息和Setting信息。Mapping定义文档字段的类型；Setting定义不同的数据分布。~~**  
&emsp; **~~每个索引都有一个映射类型，它决定了文档的索引方式。~~**  
2. 倒排索引的结构  
&emsp; 那么倒排序索引的结构是怎样的呢？简单来讲就是<font color="clime">“以内容的关键词”建立索引，映射关系为“内容的关键词->文档ID”。`这样只需要在“关键词”中进行检索，效率肯定更快。`</font>  
&emsp; **<font color = "red">倒排序索引包含两个部分：单词词典和倒排列表。</font>** 单词词典：记录所有文档单词；记录单词到倒排列表的关联关系。倒排列表：记录单词与对应文档结合，由倒排索引项组成。  
3. 分析（建索引与检索）  
&emsp; 文本分析由分析器来执行，而分析器由分词器、过滤器和字符映射器组成。  
&emsp; **<font color = "clime">有一点需要牢记，Elasticsearch有些查询会被分析，而有些则不会。例如，前缀查询不会被分析，而匹配查询会被分析。</font>**     

# 1. ES基本概念  
<!--
核心概念介绍
https://mp.weixin.qq.com/s?__biz=MzI1NDY0MTkzNQ==&mid=2247490655&idx=3&sn=c988118763c13d263dfabe745e43cebe&scene=21#wechat_redirect
一文讲透Elasticsearch倒排索引与分词 
https://mp.weixin.qq.com/s/81wHAF9b96r08uBCH3TodA
ES倒排索引结构设计太牛逼
https://mp.weixin.qq.com/s/4ssGyiK_J2NXwZe4JqnKHQ

&emsp; 特点和优势：  

* 分布式实时文件存储，可将每一个字段存入索引，使其可以被检索到。  
* 近乎实时分析的分布式搜索引擎。   
* 分布式：索引分拆成多个分片，每个分片可有零个或多个副本。集群中的每个数据节点都可承载一个或多个分片，并且协调和处理各种操作。  
* 负载再平衡和路由在大多数情况下自动完成。   
* 可以扩展到上百台服务器，处理PB级别的结构化或非结构化数据(官网是这么说的)。也可以运行在单台PC上(已测试)。   
* 支持插件机制，分词插件、同步插件、Hadoop插件、可视化插件等。
--> 

&emsp; Elasticsearch（ES）是一个基于Lucene构建的开源、分布式、RESTful接口的全文搜索引擎。Elasticsearch还是一个分布式文档数据库，其中每个字段均可被索引，而且每个字段的数据均可被搜索，ES能够横向扩展至数以百计的服务器存储以及处理PB级的数据。可以在极短的时间内存储、搜索和分析大量的数据。通常作为具有复杂搜索场景情况下的核心发动机。  

## 1.1. ~~ES数据架构~~  
&emsp; **与mysql的对比**  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/ES/es-2.png)  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/ES/es-82.png)  

|关系型数据库|ES|
|---|---|
|数据库|索引|
|表|类型|
|行|文档|
|列|字段|
|表结构|映射(Mapping)|



<!-- 
11.索引(index)  
索引是具有相同结构的文档集合。例如，可以有一个客户信息的索引，包括一个产品目录的索引，一个订单数据的索引。在系统上索引的名字全部小写，通过这个名字可以用来执 行索引、搜索、更新和删除操作等。在单个集群中，可以定义多个你想要的索引。索引结构 参见图1-2。  
12.类型(type)  
在索引中，可以定义一个或多个类型，类型是索引的逻辑分区。在一般情况下，一种类 型被定义为具有一组公共字段的文档。例如，让我们假设你运行一个博客平台，并把所有的 数据存储在一个索引中。在这个索引中，你可以定义一种类型为用户数据，一种类型为博客 数据，另一种类型为评论数据。  
13.文档(document)  
文档是存储在Elasticsearch中的一个JSON格式的字符串。它就像在关系数据库中表的一行。每个存储在索引中的一个文档都有一个类型和一个ID,每个文档都是一个JSON对象，存储了零个或者多个字段，或者键值对。原始的JSON文档被存储在一个叫作_source 的字段中。当搜索文档的时候默认返回的就是这个字段。   
14.映射(mapping)  
映射像关系数据库中的表结构，每一个索引都有一个映射，它定义了索引中的每一个字段类型，以及一个索引范围内的设置。一个映射可以事先被定义，或者在第一次存储文档的 时候自动识别。  
15.字段(field)
文档中包含零个或者多个字段，字段可以是一个简单的值(例如字符串、整数、日期), 也可以是一个数组或对象的嵌套结构。字段类似于关系数据库中表的列。每个字段都对应一 个字段类型，例如整数、字符串、对象等。字段还可以指定如何分析该字段的值。  
16.来源字段(source field )  
默认情况下，原文档将被存储在.source这个字段中，当査询的时候也是返回这个字段。这可以从搜索结果中访问原始的对象，这个对象返回一个精确的JSON字符串，这个对象不显示索引分析后的其他任何数据。  
17.主键(ID)  
ID是一个文件的唯一标识，如果在存库的时候没有提供ID,系统会自动生成一个ID, 文档的index/type/id必须是唯一的。  
-->

### 1.1.1. 索引(Index)  
&emsp; ES将数据存储于一个或多个索引中，索引是具有类似特性的文档的集合。  
&emsp; **<font color = "red">索引的元数据包含Mapping信息和Setting信息。Mapping定义文档字段的类型；Setting定义不同的数据分布。**</font>  

### 1.1.2. ~~类型(Type)~~  
&emsp; 类型是索引内部的逻辑分区(category/partition)，然而其意义完全取决于用户需求。因此，一个索引内部可定义一个或多个类型(type)。一般来说，类型就是为那些拥有相同的域的文档做的预定义。  
&emsp; 注：在Elasticsearch 6.0.0或更高版本中创建的索引只能包含一个映射类型。在5.x中创建的具有多种映射类型的索引将继续像在Elasticsearch 6.x中一样工作。类型在Elasticsearch 7.0.0中的API中弃用，并在8.0.0中完全删除。  

### 1.1.3. 映射(mapping)  
<!-- 
&emsp; 注意：在ES中创建一个mapping映射类似于在数据库中定义表结构，即表里面有哪些字段、字段是什么类型、字段的默认值等；也类似于solr里面的模式schema的定义。 --> 
&emsp; 映射是定义文档及其包含的字段如何存储和索引的过程。例如，使用映射来定义：  

* 哪些字符串字段应该被视为全文字段。
* 哪些字段包含数字、日期或地理位置。
* 文档中所有字段的值是否应该被索引到catch-all _all字段中。
* 日期值的格式。
* 用于控制动态添加字段的映射的自定义规则。

&emsp; **<font color = "red">每个索引都有一个映射类型，它决定了文档的索引方式。</font>**  
&emsp;ES中的数据类型：    
![image](https://gitee.com/wt1814/pic-host/raw/master/images/ES/es-1.png)  

### 1.1.4. 文档(document)  
&emsp; 文档是可搜索数据的最小单位。  
&emsp; 文档都是JSON格式的。  

&emsp; **<font color = "clime">★★★注：文档的元数据（有哪些字段）是由映射Mapping决定的。</font>**    
<!-- 
元数据（_index、_type、_id、_score、_source）
https://blog.csdn.net/qq_42513284/article/details/90678516
-->

  

## 1.2. 倒排索引  
&emsp; <font color = "red">在Elasticsearch中倒排索引也是非常重要的“索引”结构。</font>Elasticsearch将写入索引的所有信息组织成倒排索引的结构。该结构是一种<font color = "clime">将文档单词到文档ID的数据结构，其工作方式与传统的关系数据库不同，可以认为倒排索引是面向词项而不是面向文档的。</font>

### 1.2.1. 示例  
&emsp; 例如，针对专栏文章，平时在各大平台根据关键词检索时，使用到的技术就有“倒排序索引”。  

|ID	|作者	|文章题目	|内容|
|---|---|---|---|
|1	|wt	|系统学习es|	系统学习es，倒排序索引|
|2	|wt	|学习mysql	|学习mysql，正向索引|

&emsp; 假设文章的储存结果如上，对于关系型数据库mysql来说，普通的索引结构就是“id->题目->内容”，在搜索的时候，如果知道id或者题目，那么检索效率是很高效的，因为“id”、“题目”是很方便创建索引的。  

&emsp; **正向索引**  

|索引	|内容|
|---|---|
|1	|系统学习es，倒排序索引|
|系统学习es	|系统学习es，倒排序索引|
|2	|学习mysql，正向索引|
|学习mysql|学习mysql，正向索引|

&emsp; 但是当只有一个检索关键词，比如需求是搜索到与“倒排序索引”相关的文章时，在索引结构是“id->题目->内容”时，就只能对“题目”和“内容”进行全文扫描了，当数量级上去后，效率是没办法接受的！对于这类的搜索，关系型数据库的索引就很难应付了，适合使用全文搜索的倒排索引。  
&emsp; 那么倒排序索引的结构是怎样的呢？简单来讲就是<font color="clime">“以内容的关键词”建立索引，映射关系为“内容的关键词->文档ID”。这样只需要在“关键词”中进行检索，效率肯定更快。</font>  

&emsp; **倒排序索引**  

|Token	|文档id=1	|文档id=2|
|---|---|---|
|系统	|true|	|
|学习	|true	|true|
|es	|true|	|
|mysql	|	|true|
|倒排序	|true|	|
|正向	|	|true|
|索引|	true|	true|

### 1.2.2. 核心组成  
<!-- 

一般来说，倒排索引分为两个部分：

    单词词典(记录所有的文档词项，以及词项到倒排列表的关联关系)
    倒排列表(记录单词与对应的关系，由一系列倒排索引项组成，倒排索引项指：文档 id、词频(TF)(词项在文档中出现的次数，评分时使用)、位置(Position，词项在文档中分词的位置)、偏移(记录词项开始和结束的位置))

当我们去索引一个文档时，就回建立倒排索引，搜索时，直接根据倒排索引搜索。
-->

&emsp; **<font color = "red">倒排序索引包含两个部分：单词词典和倒排列表。</font>**  

* **<font color = "red">单词词典：记录所有文档单词；记录单词到倒排列表的关联关系。</font>**
* **<font color = "red">倒排列表：记录单词与对应文档结合，由倒排索引项组成。</font>**  
&emsp; 倒排索引项：  
  * 文档   
  * 词频 TF - 单词在文档中出现的次数，用于相关性评分。  
  * 位置(Position)- 单词在文档中分词的位置，用于phrase query。  
  * 偏移(Offset)- 记录单词开始结束的位置，实现高亮显示。  

&emsp; 举个简单例子，理解下“倒排索引项”：以 Token“学习”为例：  

  |单词	|doc Id 	|TF	|Position	|Offset|
  |---|---|---|---|---|
  |学习|	1|	1|	1|	<2,4>|
  |学习|	2|	1|	0|	<0,2>|

### 1.2.3. 倒排索引是怎么工作的？  
&emsp; **<font color = "red">倒排索引的工作流程主要包括2个过程：</font>**  
1. 创建倒排索引；  
2. 倒排索引搜索；  

#### 1.2.3.1. 创建倒排索引  
&emsp; 还是使用上面的例子。<font color = "red">先对文档的内容进行分词，形成一个个的token，也就是单词，然后保存这些token与文档的对应关系。</font>结果如下：  
&emsp; **倒排序索引**  

|Token|文档id=1	|文档id=2|
|---|---|---|
|系统	|true|	|
|学习|	true|	true|
|es	|true|	|
|mysql|		|true|
|倒排序	|true|	|
|正向|		|true|
|索引	|true	|true|

#### 1.2.3.2. 倒排索引搜索   

&emsp; 搜索示例1：“学习索引”  
&emsp; <font color = "red">先分词，得到两个Token：“学习”、“索引”；然后去倒排索引中进行匹配。</font>  
&emsp; 这2个Token在2个文档中都匹配，所以2个文档都会返回，而且分数相同。  

&emsp; 搜索示例2：“学习es”  
&emsp; 同样，2个文档都匹配，都会返回。但是文档1的相关性评分会高于文档2，因为文档1匹配了两个Token，而文档2只匹配了一个Token【学习】。  

## 1.3. 分析(建索引与检索)  
<!-- 
ElasticSearch 23 种映射参数详解 
https://mp.weixin.qq.com/s?__biz=MzI1NDY0MTkzNQ==&mid=2247491016&idx=1&sn=843b7e0a94f15d60efee27c4a8efbdc7&scene=21#wechat_redirect


1. 索引词(term)  
在Elasticsearch中索引词(term)是一个能够被索引的精确值。foo、Foo、F00几个单词是不同的索引词索引词(term)是可以通过term查询进行准确的搜索。  
2. 文本(text)  
文本是一段普通的非结构化文字。通常，文本会被分析成一个个的索引词，存储在Elasticsearch的索引库中。为了让文本能够进行搜索，文本字段需要事先进行分析；当对文 本中的关键词进行査询的时候，搜索引擎应该根据搜索条件搜索岀原文本。  
3. 分析(analysis)
分析是将文本转换为索引词的过程，分析的结果依赖于分词器。比如：FOOBAR、 Foo-Bar和foo bar这几个单词有可能会被分析成相同的索引词foo和bar，这些索引词存储 在Elasticsearch的索引库中。当用FoO.bAR进行全文搜索的时候，搜索引擎根据匹配计算也能在索引库中搜索出之前的内容。这就是Elasticsearch的搜索分析。  
-->


&emsp; <font color = "red">文档中的数据是如何转化为倒排索引的，而查询串又是如何转换为可用于搜索的文档单词的？这个转换过程称为分析(Analysis)。</font><font color = "clime">文本分析由分析器来执行，而分析器由分词器、过滤器和字符映射器组成。</font>  

### 1.3.1. ~~索引与查询~~  
&emsp; Elasticsearch是如何控制索引和查询操作的。在索引期，Elasticsearch会使用选择的分析器来处理文档中的内容，并可以对不同的字段使用不同的分析器。  
&emsp; 在检索时，如果使用了某个查询分析器，那么查询串就会被分析。当然，也可以选择不进行查询分析。 **<font color = "clime">有一点需要牢记，Elasticsearch有些查询会被分析，而有些则不会。例如，前缀查询不会被分析，而匹配查询会被分析。</font>**  
&emsp; 索引期与检索期的文本分析要采用同样的分析器，只有查询分析出来的文档与索引中文档能匹配上，才会返回预期的文档集。  

-----

&emsp; Analysis：即文本分析，是把全文本转化为一系列单词(term/token)的过程，也叫分词；在Elasticsearch中可通过内置分词器实现分词，也可以按需定制分词器。Elasticsearch中的内置分词器：  

* Standard Analyzer：默认分词器，按词切分，小写处理  
* Simple Analyzer：按照非字母切分(符号被过滤)，小写处理  
* Stop Analyzer：小写处理，停用词过滤(the, a, is)  
* Whitespace Analyzer：按照空格切分，不转小写  
* Keyword Analyzer：不分词，直接将输入当做输出  
* Patter Analyzer：正则表达式，默认 \W+ (非字符分割)  
* Language：提供了30多种常见语言的分词器  
* Customer Analyzer：自定义分词器  

&emsp; **Analyzer由三部分组成：**  

* Character Filters：原始文本处理，如去除html。  
* Tokenizer：按照规则切分为单词。  
* Token Filters：对切分单词加工、小写、删除stopwords，增加同义词。  

&emsp; **Analyzer分词过程简介**  
1. 字符过滤器  character filter  
&emsp; 首先，字符串按顺序通过每个字符过滤器 。它们的任务是在分词前整理字符串。一个字符过滤器可以用来去掉HTML，或者将 & 转化成and。  
2. 分词器 tokenizer  
&emsp; 其次，字符串被分词器分为单个的词条。一个whitespace的分词器遇到空格和标点的时候，可能会将文本拆分成词条。  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/ES/es-3.png)  
3. 令牌过滤器token filter  
&emsp; 最后，词条按顺序通过每个token过滤器。这个过程可能会改变词条，例如，lowercase token filter小写化(将ES转为es)、stop token filter删除词条(例如，像a，and，the等无用词)，或者synonym token filter增加词条(例如，像jump和leap这种同义词)。  

### 1.3.2. ik中文分词器  
<!--
中文分词器
https://mp.weixin.qq.com/s/wpLeWIgq6yQEolKcv_P8hA
-->
