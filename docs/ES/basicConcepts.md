
<!-- TOC -->

- [1. ES基本概念](#1-es基本概念)
    - [1.1. 什么是ES？](#11-什么是es)
    - [1.2. ~~ES数据架构~~](#12-es数据架构)
        - [1.2.1. 索引(Index)](#121-索引index)
        - [1.2.2. ~~类型(Type)~~](#122-类型type)
        - [1.2.3. 映射(mapping)](#123-映射mapping)
        - [1.2.4. 文档(document)](#124-文档document)
    - [1.3. ES集群基本概念](#13-es集群基本概念)
        - [1.3.1. 集群节点(Node)](#131-集群节点node)
        - [1.3.2. 分片(Shard)](#132-分片shard)
        - [1.3.3. 副本(Replica)](#133-副本replica)
        - [1.3.4. 路由(routing)](#134-路由routing)

<!-- /TOC -->

&emsp; **<font color = "red">总结：</font>**  
1. ES是一个`分布式`的`搜索`框架。  
2. **<font color = "blue">ES数据结构</font>**  
&emsp; 索引Index（数据库） ---> 映射Mapping（表结构） ---> 文档Fields（一行数据）  
&emsp; **<font color = "clime">★★★注：文档的元数据（有哪些字段）是由映射Mapping决定的。</font>**    
&emsp; **~~ES中索引的元数据包含Mapping信息和Setting信息。Mapping定义文档字段的类型；Setting定义不同的数据分布。~~**  
&emsp; **~~每个索引都有一个映射类型，它决定了文档的索引方式。~~**  
3. ES集群  


# 1. ES基本概念  
<!--
Elasticsearch 为什么能做到快速检索？— 倒排索引的秘密 
https://mp.weixin.qq.com/s/vwTrRSfgJ-7bWQUJWhfaHQ

核心概念介绍
https://mp.weixin.qq.com/s?__biz=MzI1NDY0MTkzNQ==&mid=2247490655&idx=3&sn=c988118763c13d263dfabe745e43cebe&scene=21#wechat_redirect
一文讲透Elasticsearch倒排索引与分词 
https://mp.weixin.qq.com/s/81wHAF9b96r08uBCH3TodA
ES倒排索引结构设计太牛逼
https://mp.weixin.qq.com/s/4ssGyiK_J2NXwZe4JqnKHQ

&emsp; 特点和优势：  

* 分布式实时文件存储，可将每一个字段存入索引，使其可以被检索到。  
* 近乎实时分析的分布式搜索引擎。   
* 分布式：索引分拆成多个分片，每个分片可有零个或多个副本。集群中的每个数据节点都可承载一个或多个分片，并且协调和处理各种操作。  
* 负载再平衡和路由在大多数情况下自动完成。   
* 可以扩展到上百台服务器，处理PB级别的结构化或非结构化数据(官网是这么说的)。也可以运行在单台PC上(已测试)。   
* 支持插件机制，分词插件、同步插件、Hadoop插件、可视化插件等。
--> 
ElasticSearch java API：https://www.elastic.co/guide/en/elasticsearch/client/java-api/current/index.html  
文档：https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html
官网：https://www.elastic.co/cn/
中文社区：https://elasticsearch.cn/

## 1.1. 什么是ES？  
&emsp; Elasticsearch（ES）是一个基于Lucene构建的开源、分布式、RESTful接口的全文搜索引擎。  
&emsp; Elasticsearch还是一个分布式文档数据库，其中每个字段均可被索引，而且每个字段的数据均可被搜索，ES能够横向扩展至数以百计的服务器存储以及处理PB级的数据。可以在极短的时间内存储、搜索和分析大量的数据。通常作为具有复杂搜索场景情况下的核心发动机。  

&emsp; 什么是全文检索？  

## 1.2. ~~ES数据架构~~  
&emsp; **与mysql的对比**  
![image](http://182.92.69.8:8081/img/ES/es-2.png)  
![image](http://182.92.69.8:8081/img/ES/es-82.png)  

|关系型数据库|ES|
|---|---|
|数据库|索引|
|表|类型|
|行|文档|
|列|字段|
|表结构|映射(Mapping)|



<!-- 
11.索引(index)  
索引是具有相同结构的文档集合。例如，可以有一个客户信息的索引，包括一个产品目录的索引，一个订单数据的索引。在系统上索引的名字全部小写，通过这个名字可以用来执 行索引、搜索、更新和删除操作等。在单个集群中，可以定义多个你想要的索引。索引结构 参见图1-2。  
12.类型(type)  
在索引中，可以定义一个或多个类型，类型是索引的逻辑分区。在一般情况下，一种类 型被定义为具有一组公共字段的文档。例如，让我们假设你运行一个博客平台，并把所有的 数据存储在一个索引中。在这个索引中，你可以定义一种类型为用户数据，一种类型为博客 数据，另一种类型为评论数据。  
13.文档(document)  
文档是存储在Elasticsearch中的一个JSON格式的字符串。它就像在关系数据库中表的一行。每个存储在索引中的一个文档都有一个类型和一个ID,每个文档都是一个JSON对象，存储了零个或者多个字段，或者键值对。原始的JSON文档被存储在一个叫作_source 的字段中。当搜索文档的时候默认返回的就是这个字段。   
14.映射(mapping)  
映射像关系数据库中的表结构，每一个索引都有一个映射，它定义了索引中的每一个字段类型，以及一个索引范围内的设置。一个映射可以事先被定义，或者在第一次存储文档的 时候自动识别。  
15.字段(field)
文档中包含零个或者多个字段，字段可以是一个简单的值(例如字符串、整数、日期), 也可以是一个数组或对象的嵌套结构。字段类似于关系数据库中表的列。每个字段都对应一 个字段类型，例如整数、字符串、对象等。字段还可以指定如何分析该字段的值。  
16.来源字段(source field )  
默认情况下，原文档将被存储在.source这个字段中，当査询的时候也是返回这个字段。这可以从搜索结果中访问原始的对象，这个对象返回一个精确的JSON字符串，这个对象不显示索引分析后的其他任何数据。  
17.主键(ID)  
ID是一个文件的唯一标识，如果在存库的时候没有提供ID,系统会自动生成一个ID, 文档的index/type/id必须是唯一的。  
-->

### 1.2.1. 索引(Index)  
&emsp; ES将数据存储于一个或多个索引中，索引是具有类似特性的文档的集合。  
&emsp; **<font color = "red">索引的元数据包含Mapping信息和Setting信息。Mapping定义文档字段的类型；Setting定义不同的数据分布。**</font>  

### 1.2.2. ~~类型(Type)~~  
&emsp; 类型是索引内部的逻辑分区(category/partition)，然而其意义完全取决于用户需求。因此，一个索引内部可定义一个或多个类型(type)。一般来说，类型就是为那些拥有相同的域的文档做的预定义。  
&emsp; 注：在Elasticsearch 6.0.0或更高版本中创建的索引只能包含一个映射类型。在5.x中创建的具有多种映射类型的索引将继续像在Elasticsearch 6.x中一样工作。类型在Elasticsearch 7.0.0中的API中弃用，并在8.0.0中完全删除。  

### 1.2.3. 映射(mapping)  
<!-- 
&emsp; 注意：在ES中创建一个mapping映射类似于在数据库中定义表结构，即表里面有哪些字段、字段是什么类型、字段的默认值等；也类似于solr里面的模式schema的定义。 --> 
&emsp; 映射是定义文档及其包含的字段如何存储和索引的过程。例如，使用映射来定义：  

* 哪些字符串字段应该被视为全文字段。
* 哪些字段包含数字、日期或地理位置。
* 文档中所有字段的值是否应该被索引到catch-all _all字段中。
* 日期值的格式。
* 用于控制动态添加字段的映射的自定义规则。

&emsp; **<font color = "red">每个索引都有一个映射类型，它决定了文档的索引方式。</font>**  
&emsp;ES中的数据类型：    
![image](http://182.92.69.8:8081/img/ES/es-1.png)  

### 1.2.4. 文档(document)  
&emsp; 文档是可搜索数据的最小单位。  
&emsp; 文档都是JSON格式的。  

&emsp; **<font color = "clime">★★★注：文档的元数据（有哪些字段）是由映射Mapping决定的。</font>**    
<!-- 
元数据（_index、_type、_id、_score、_source）
https://blog.csdn.net/qq_42513284/article/details/90678516
-->

  
## 1.3. ES集群基本概念


<!-- 
Elasticsearch技术解析与实战 第6章集群管理  

Elasticsearch集群发现机制
https://mp.weixin.qq.com/s/K3m205DSnNY7SWfAc_cQVw
https://mp.weixin.qq.com/s/4sZUOWyzYn9FFNXHBM06_Q

split-brain(脑分裂问题)
https://mp.weixin.qq.com/s?__biz=MzIxMTE0ODU5NQ==&mid=2650238166&idx=1&sn=f93737fbf547b4cbf5249ad6109d3496&chksm=8f5a068ab82d8f9ce9062aa43568c14cf2e167b04827cbfdfe3633862c0fc039a59d78911202&mpshare=1&scene=1&srcid=&sharer_sharetime=1564015764413&sharer_shareid=b256218ead787d58e0b58614a973d00d&key=36a99a852770fa03ee3e26339e0b86105bb323342e47179ae06d9230d7ed5cd50a82f3c7229bb3162b6fefed6d469a2e6544490f1917920f7693619669f1b5e89756d43ff3805fd4f6f925f32c02db10&ascene=1&uin=MTE1MTYxNzY2MQ%3D%3D&devicetype=Windows+10&version=62060834&lang=zh_CN&pass_ticket=xUB8YY6QWYfNya3IQwwJZSaYRbtlkwhr6XfEN2O%2BPEVoirvTO%2BwraC8Njjqe%2BVNW

-->

&emsp; `ES天然支持分布式。`

&emsp; 在数据库系统中，为了保证高可用性，可能会做主从复制、分库分表等操作。在ES中也有相同的基本操作。`ES天然支持分布式。`ES集群架构如下：  
![image](http://182.92.69.8:8081/img/ES/es-4.png)  
&emsp; 上述图中Node-1是主节点，主节点有权限控制整个集群，有权限控制整个集群。每个节点都有三个分片，其中P0 P1 P2代表Primary为主分片，R开头的则代表为每个主分片对应的副本分片，一共是3个主分片，每个主分片有两个对应的副本分片。  


### 1.3.1. 集群节点(Node)  
<!-- 
集群角色类型
https://www.cnblogs.com/sanduzxcvbnm/p/12850357.html
https://zhuanlan.zhihu.com/p/162700652
https://www.cnblogs.com/37yan/p/9928748.html
-->
&emsp; ES可以作为一个独立的单个搜索服务器。不过，一般为了处理大型数据集，实现容错和高可用性，ES可以运行在许多互相合作的服务器上。这些服务器的集合称为集群。  
&emsp; 运行了单个实例的ES主机称为节点，它是集群的一个成员，可以存储数据、参与集群索引及搜索操作。节点通过为其配置的ES集群名称确定其所要加入的集群。  
<!--
5.节点(node)
一个节点是一个逻辑上独立的服务，它是集群的一部分，可以存储数据，并参与集群 的索引和搜索功能。就像集群一样，节点也有唯一的名字，在启动的时候分配。如果你不 
想要默认名称，你可以定义任何你想要的节点名。这个名字在管理中很重要，在网络中 Elasticsearch集群通过节点名称进行管理和通信。一个节点可以被配置加入一个特定的集 群。默认情况下，每个节点会加入名为Elasticsearch的集群中，这意味着如果你在网络上启 动多个节点，如果网络畅通，他们能彼此发现并自动加入一个名为Elasticsearch的集群中 在一个集群中，你可以拥有多个你想要的节点。当网络没有集群运行的时候，只要启动任何 —个节点，这个节点会默认生成一个新的集群，这个集群会有一个节点。  
-->
&emsp; **ES集群中节点分类：**  
* Master：主节点，每个集群都有且只有一个。  
  * 尽量避免Master节点 node.data ＝ true。  
  * 主节点的主要职责是和集群操作相关的内容，如创建或删除索引，跟踪哪些节点是群集的一部分，并决定哪些分片分配给相关的节点。稳定的主节点对集群的健康是非常重要的，默认情况下任何一个集群中的节点都有可能被选为主节点，索引数据和搜索查询等操作会占用大量的cpu，内存，io资源，为了确保一个集群的稳定，分离主节点和数据节点是一个比较好的选择。  
* Data node(数据节点)：即Data节点。数据节点主要是存储索引数据的节点，主要对文档进行增删改查操作，聚合操作等。数据节点对CPU、内存、IO要求较高，在优化的时候需要监控数据节点的状态。  
* voting：投票节点  
  * Node.voting_only = true（仅投票节点，即使配置了data.master = true，也不会参选, 但是仍然可以作为数据节点）。  
* coordinating：协调节点  
  * 每一个节点都隐式的是一个协调节点，如果同时设置了data.master = false和data.data=false，那么此节点将成为仅协调节点。
* Master-eligible node：Master候选节点，只有Master候选节点会升级为Master节点。	  
 

&emsp; **关于集群节点类型的两个配置：node.master和node.data**   

* node.master = true	 node.data = true  
&emsp; 这是ES节点默认配置，既作为候选节点又作为数据节点，这样的节点一旦被选举为Master，压力是比较大的，通常来说Master节点应该只承担较为轻量级的任务，比如创建删除索引，分片均衡等。  
* node.master = true	 node.data = false  
&emsp; 只作为候选节点，不作为数据节点，可参选Master节点，当选后成为真正的Master节点。  
* node.master = false	 node.data = false  
&emsp; 既不当候选节点，也不作为数据节点，那就是仅协调节点，负责负载均衡。  
* node.master=false		node.data=true  
&emsp; 不作为候选节点，但是作为数据节点，这样的节点主要负责数据存储和查询服务。    

### 1.3.2. 分片(Shard)  
&emsp; **ES的“分片(shard)”机制可将一个索引内部的数据分布地存储于多个节点，** 它通过将一个索引切分为多个底层物理的Lucene索引完成索引数据的分割存储功能，每一个物理的Lucene索引称为一个分片(shard)。  
&emsp; **<font color = "red">这样的好处是可以把一个大的索引拆分成多个，分布到不同的节点上。降低单服务器的压力，构成分布式搜索，提高整体检索的效率（分片数的最优值与硬件参数和数据量大小有关）。</font>**  
&emsp; 分片的数量只能在索引创建前指定，并且索引创建后不能更改。  
<!-- 
7.分片(shard)
分片是单个Lucene实例，这是Elasticsearch管理的比较底层的功能。索引是指向主 分片和副本分片的逻辑空间。对于使用，只需要指定分片的数量，其他不需要做过多的 事情。在开发使用的过程中，我们对应的对象都是索引，Elasticsearch会自动管理集群中 所有的分片，当发生故障的时候，Elasticsearch会把分片移动到不同的节点或者添加新的 T＞点。
一个索引可以存储很大的数据，这些空间可以超过一个节点的物理存储的限制。例如， 十亿个文档占用磁盘空间为1TB。仅从单个节点搜索可能会很慢，还有一台物理机器也不 一定能存储这么多的数据。为了解决这一问题，Elasticsearch将索引分解成多个分片：当你 创建一个索引，你可以简单地定义你想要的分片数量。每个分片本身是一个全功能的、独立 的单元，可以托管在集群中的任何节点。
-->

### 1.3.3. 副本(Replica)  
<!--
10,复制(replica)
复制是一个非常有用的功能，不然会有单点问题。当网络中的某个节点出现问题的时 候，复制可以对故障进行转移，保证系统的高可用。因此，Elasticsearch允许你创建一个或 多个拷贝，你的索引分片就形成了所谓的副本或副本分片。  
复制是重要的，主要的原因有：  

* 它提供了高可用性，当节点失败的时候不受影响。需要注意的是，一个复制的分片 不会存储在同一个节点中。  
* 它允许你扩展搜索量，提高并发量，因为搜索可以在所有副本上并行执行。  

每个索引可以拆分成多个分片。索引可以复制零个或者多个分片。一旦复制，每个索引 就有了主分片和副本分片。分片的数量和副本的数量可以在创建索引时定义。当创建索引 后，你可以随时改变副本的数量，但你不能改变分片的数量。  
默认情况下，每个索引分配5个分片和一个副本，这意味着你的集群节点至少要有两个 节点，你将拥有5个主要的分片和5个副本分片共计10个分片。  


8,主分片(primary shard )
每个文档都存储在一个分片中，当你存储一个文档的时候，系统会首先存储在主分片 中，然后会复制到不同的副本中。默认情况下，一个索引有5个主分片。你可以事先制定分 片的数量，当分片一旦建立，则分片的数量不能修改。
9.副本分片(replica shard )
每一个分片有零个或多个副本。副本主要是主分片的复制，其中有两个目的： 口增加高可用性：当主分片失败的时候，可以从副本分片中选择一个作为主分片， 口提高性能：当查询的时候可以到主分片或者副本分片中进行查询。默认情况下，一 个主分片配有一个副本，但副本的数量可以在后面动态地配置增加。副本分片必须 部署在不同的节点上，不能部署在和主分片相同的节点上。
分片主要有两个很重要的原因是：  

	* 允许水平分割扩展数据。  
	* 允许分配和并行操作(可能在多个节点上)从而提高性能和吞吐量。  

这些很强大的功能对用户来说是透明的，你不需要做什么操作，系统会自动处理。  
-->
&emsp; 副本是一个分片的精确复制，每个分片可以有零个或多个副本。<font color = "red">副本的作用：一是提高系统的容错性，当某个节点某个分片损坏或丢失时可以从副本中恢复；</font><font color = "blue">二是提高es的查询效率，es会自动对搜索请求进行负载均衡。</font>  
![image](http://182.92.69.8:8081/img/ES/es-75.png)  

### 1.3.4. 路由(routing)  
&emsp; 当存储一个文档的时候，它会存储在唯一的主分片中，具体哪个分片是通过散列值进行选择：默认情况下，这个值是由文档的ID生成。如果文档有一个指定的父文档，则从父文档ID中生成，该值可以在存储文档的时候进行修改。   


