
<!-- TOC -->

- [1. ES集群基本概念](#1-es集群基本概念)
    - [1.1. 节点(Node)](#11-节点node)
    - [1.2. ~~集群(cluster)~~](#12-集群cluster)
    - [1.3. 分片(Shard)](#13-分片shard)
    - [1.4. 副本(Replica)](#14-副本replica)
    - [1.5. 路由(routing)](#15-路由routing)

<!-- /TOC -->
 
# 1. ES集群基本概念
&emsp; 在数据库系统中，为了保证高可用性，可能会做主从复制、分库分表等操作。在ES中也有相同的基本操作。ES集群架构如下：  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/ES/es-4.png)  
&emsp; 上述图中Node-1是主节点，主节点有权限控制整个集群，有权限控制整个集群。每个节点都有三个分片，其中P0 P1 P2代表Primary为主分片，R开头的则代表为每个主分片对应的副本分片，一共是3个主分片，每个主分片有两个对应的副本分片。  

## 1.1. 节点(Node)  
&emsp; 运行了单个实例的ES主机称为节点，它是集群的一个成员，可以存储数据、参与集群索引及搜索操作。节点通过为其配置的ES集群名称确定其所要加入的集群。  
<!--
5.节点(node)
一个节点是一个逻辑上独立的服务，它是集群的一部分，可以存储数据，并参与集群 的索引和搜索功能。就像集群一样，节点也有唯一的名字，在启动的时候分配。如果你不 
想要默认名称，你可以定义任何你想要的节点名。这个名字在管理中很重要，在网络中 Elasticsearch集群通过节点名称进行管理和通信。一个节点可以被配置加入一个特定的集 群。默认情况下，每个节点会加入名为Elasticsearch的集群中，这意味着如果你在网络上启 动多个节点，如果网络畅通，他们能彼此发现并自动加入一个名为Elasticsearch的集群中 在一个集群中，你可以拥有多个你想要的节点。当网络没有集群运行的时候，只要启动任何 —个节点，这个节点会默认生成一个新的集群，这个集群会有一个节点。  
-->

## 1.2. ~~集群(cluster)~~  
<!-- 
集群角色类型
https://www.cnblogs.com/sanduzxcvbnm/p/12850357.html
https://zhuanlan.zhihu.com/p/162700652
https://www.cnblogs.com/37yan/p/9928748.html
-->
&emsp; ES可以作为一个独立的单个搜索服务器。不过，一般为了处理大型数据集，实现容错和高可用性，ES可以运行在许多互相合作的服务器上。这些服务器的集合称为集群。  

&emsp; **ES集群中节点分类：**  
* Master：主节点，每个集群都有且只有一个  
  * 尽量避免Master节点 node.data ＝ true
  * 主节点的主要职责是和集群操作相关的内容，如创建或删除索引，跟踪哪些节点是群集的一部分，并决定哪些分片分配给相关的节点。稳定的主节点对集群的健康是非常重要的，默认情况下任何一个集群中的节点都有可能被选为主节点，索引数据和搜索查询等操作会占用大量的cpu，内存，io资源，为了确保一个集群的稳定，分离主节点和数据节点是一个比较好的选择。
* Data node(数据节点)： 即 Data 节点。数据节点主要是存储索引数据的节点，主要对文档进行增删改查操作，聚合操作等。数据节点对 CPU、内存、IO 要求较高，在优化的时候需要监控数据节点的状态。
* voting：投票节点  
  * Node.voting_only = true(仅投票节点，即使配置了data.master = true，也不会参选, 但是仍然可以作为数据节点)。  
* coordinating：协调节点  
  * 每一个节点都隐式的是一个协调节点，如果同时设置了data.master = false和data.data=false，那么此节点将成为仅协调节点。
* Master-eligible node(候选节点)：	  
 

&emsp; **关于集群节点类型的两个配置：node.master和node.data**   

* node.master = true	 node.data = true  
&emsp; 这是ES节点默认配置，既作为候选节点又作为数据节点，这样的节点一旦被选举为Master，压力是比较大的，通常来说Master节点应该只承担较为轻量级的任务，比如创建删除索引，分片均衡等。  
* node.master = true	 node.data = false  
&emsp; 只作为候选节点，不作为数据节点，可参选Master节点，当选后成为真正的Master节点。  
* node.master = false	 node.data = false  
&emsp; 既不当候选节点，也不作为数据节点，那就是仅协调节点，负责负载均衡  
* node.master=false		node.data=true  
&emsp; 不作为候选节点，但是作为数据节点，这样的节点主要负责数据存储和查询服务。    

## 1.3. 分片(Shard)  
&emsp; **ES的“分片(shard)”机制可将一个索引内部的数据分布地存储于多个节点，** 它通过将一个索引切分为多个底层物理的Lucene索引完成索引数据的分割存储功能，这每一个物理的Lucene索引称为一个分片(shard)。  
&emsp; 这样的好处是可以把一个大的索引拆分成多个，分布到不同的节点上。降低单服务器的压力，构成分布式搜索，提高整体检索的效率(分片数的最优值与硬件参数和数据量大小有关)。分片的数量只能在索引创建前指定，并且索引创建后不能更改。  
<!-- 
7.分片(shard)
分片是单个Lucene实例，这是Elasticsearch管理的比较底层的功能。索引是指向主 分片和副本分片的逻辑空间。对于使用，只需要指定分片的数量，其他不需要做过多的 事情。在开发使用的过程中，我们对应的对象都是索引，Elasticsearch会自动管理集群中 所有的分片，当发生故障的时候，Elasticsearch会把分片移动到不同的节点或者添加新的 T＞点。
一个索引可以存储很大的数据，这些空间可以超过一个节点的物理存储的限制。例如， 十亿个文档占用磁盘空间为1TB。仅从单个节点搜索可能会很慢，还有一台物理机器也不 一定能存储这么多的数据。为了解决这一问题，Elasticsearch将索引分解成多个分片：当你 创建一个索引，你可以简单地定义你想要的分片数量。每个分片本身是一个全功能的、独立 的单元，可以托管在集群中的任何节点。
-->

## 1.4. 副本(Replica)  
<!--
10,复制(replica)
复制是一个非常有用的功能，不然会有单点问题。当网络中的某个节点出现问题的时 候，复制可以对故障进行转移，保证系统的高可用。因此，Elasticsearch允许你创建一个或 多个拷贝，你的索引分片就形成了所谓的副本或副本分片。  
复制是重要的，主要的原因有：  

* 它提供了高可用性，当节点失败的时候不受影响。需要注意的是，一个复制的分片 不会存储在同一个节点中。  
* 它允许你扩展搜索量，提高并发量，因为搜索可以在所有副本上并行执行。  

每个索引可以拆分成多个分片。索引可以复制零个或者多个分片。一旦复制，每个索引 就有了主分片和副本分片。分片的数量和副本的数量可以在创建索引时定义。当创建索引 后，你可以随时改变副本的数量，但你不能改变分片的数量。  
默认情况下，每个索引分配5个分片和一个副本，这意味着你的集群节点至少要有两个 节点，你将拥有5个主要的分片和5个副本分片共计10个分片。  


8,主分片(primary shard )
每个文档都存储在一个分片中，当你存储一个文档的时候，系统会首先存储在主分片 中，然后会复制到不同的副本中。默认情况下，一个索引有5个主分片。你可以事先制定分 片的数量，当分片一旦建立，则分片的数量不能修改。
9.副本分片(replica shard )
每一个分片有零个或多个副本。副本主要是主分片的复制，其中有两个目的： 口增加高可用性：当主分片失败的时候，可以从副本分片中选择一个作为主分片， 口提高性能：当查询的时候可以到主分片或者副本分片中进行查询。默认情况下，一 个主分片配有一个副本，但副本的数量可以在后面动态地配置增加。副本分片必须 部署在不同的节点上，不能部署在和主分片相同的节点上。
分片主要有两个很重要的原因是：  

	* 允许水平分割扩展数据。  
	* 允许分配和并行操作(可能在多个节点上)从而提高性能和吞吐量。  

这些很强大的功能对用户来说是透明的，你不需要做什么操作，系统会自动处理。  
-->
&emsp; 副本是一个分片的精确复制，每个分片可以有零个或多个副本。<font color = "red">副本的作用：一是提高系统的容错性，当某个节点某个分片损坏或丢失时可以从副本中恢复；二是提高es的查询效率，es会自动对搜索请求进行负载均衡。</font>  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/ES/es-75.png)  

## 1.5. 路由(routing)  
&emsp; 当存储一个文档的时候，它会存储在唯一的主分片中，具体哪个分片是通过散列值进行选择：默认情况下，这个值是由文档的ID生成。如果文档有一个指定的父文档，则从父文档ID中生成，该值可以在存储文档的时候进行修改。   
