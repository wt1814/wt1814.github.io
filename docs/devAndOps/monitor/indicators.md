
<!-- TOC -->

- [1. 如何快速深入理解监控知识？](#1-如何快速深入理解监控知识)
    - [1.1. Linux监控指标](#11-linux监控指标)
        - [1.1.1. 监控方法](#111-监控方法)
        - [1.1.2. 监控核心](#112-监控核心)
        - [1.1.3. 监控工具](#113-监控工具)
            - [1.1.3.1. 王牌监控](#1131-王牌监控)
        - [1.1.4. 硬件监控](#114-硬件监控)
        - [1.1.5. 系统监控](#115-系统监控)
            - [1.1.5.1. CPU](#1151-cpu)
            - [1.1.5.2. 内存](#1152-内存)
            - [1.1.5.3. IO](#1153-io)
        - [1.1.6. 网络监控](#116-网络监控)
        - [1.1.7. 流量分析](#117-流量分析)
        - [1.1.8. 应用监控](#118-应用监控)
        - [1.1.9. 日志监控](#119-日志监控)
        - [1.1.10. 安全监控](#1110-安全监控)
        - [1.1.11. API监控](#1111-api监控)
        - [1.1.12. 性能监控](#1112-性能监控)
        - [1.1.13. 业务监控](#1113-业务监控)
        - [1.1.14. 监控报警及处理](#1114-监控报警及处理)

<!-- /TOC -->

# 1. 如何快速深入理解监控知识？ 
<!-- 

大型分布式网站架构设计与实践 第4.2章  

如何快速深入理解监控知识？
https://mp.weixin.qq.com/s/q4QxJi5KZKNNIvWMjfdM1A

Linux 常用监控指标总结 
https://forum.huawei.com/enterprise/zh/thread-663521.html
-->


## 1.1. Linux监控指标  
### 1.1.1. 监控方法  


### 1.1.2. 监控核心

### 1.1.3. 监控工具

#### 1.1.3.1. 王牌监控
&emsp; Zabbix是一个分布式监控系统，支持多种采集方式和采集客户端，有专用的Agent代理，也支持SNMP、IPMI、JMX、Telnet、SSH等多种协议，它将采集到的数据存放到数据库，然后对其进行分析整理，达到条件触发告警。其灵活的扩展性和丰富的功能是其他监控系统所不能比的。相对来说，它的总体功能做的非常优秀。从以上各种监控系统的对比来看，Zabbix都是具有优势的，其丰富的功能、可扩展的能力、二次开发的能力和简单易用的特点，读者只要稍加学习，即可构建自己的监控系统。  

&emsp; prometheus  
&emsp; Prometheus 是一套开源的系统监控报警框架。它启发于Google的borgmon 监控系统，由工作在 SoundCloud 的 google 前员工在 2012 年创建，作为社区开源项目进行开发，并于 2015 年正式发布。Prometheus是最近几年开始流行的一个新兴监控告警工具，特别是kubernetes的流行带动了prometheus的应用。  

&emsp; 小米的监控系统：open-falcon。open-falcon的目标是做最开放、最好用的互联网企业级监控产品。  

### 1.1.4. 硬件监控
&emsp; 早期我们通过机房巡检的方式，查看硬件设备灯光闪烁情况判断是否故障，这样非常浪费人力，并且是重复性无技术含量的工作，大家懂得。  

![image](http://182.92.69.8:8081/img/monitor/monitor-6.png)  


&emsp; 当然我们现在可以通过IPMI对硬件详细情况进行监控，并对CPU、内存、磁盘、温度、风扇、电压等设置报警设置报警阈值(自行对监控报警内容编写合理的报警范围)  


### 1.1.5. 系统监控
&emsp; 中小型企业基本全是Linux服务器，那么我们肯定是要监控起系统资源的使用情况，系统监控是监控体系的基础。

&emsp; 监控主要对象：  
![image](http://182.92.69.8:8081/img/monitor/monitor-7.png)  

#### 1.1.5.1. CPU
&emsp; CPU有几个重要的概念:上下文切换、运行队列和使用率。  
&emsp; 这也是我们CPU监控的几个重点指标。  
&emsp; 通常情况，每个处理器的运行队列不要高于3，CPU 利用率中用“户态/内核态”比例维持在70/30，空闲状态维持在50%，上下文切换要根据系统繁忙程度来综合考量。  
&emsp; 针对CPU常用的工具有:htop、top、vmstat、mpstat、dstat、glances  

#### 1.1.5.2. 内存
&emsp; 通常我们需要监控内存的使用率、SWAP使用率、同时可以通过zabbix描绘内存使用率的曲线图形发现某服务内存溢出等。  
&emsp; 针对内存常用的工具有: free、top、vmstat、glances  

#### 1.1.5.3. IO
&emsp; IO分为磁盘IO和网络IO。除了在做性能调优我们要监控更详细的数据外，那么日常监控，只关注磁盘使用率、磁盘吞吐量、磁盘写入繁忙程度，网络也是监控网卡流量即可。   
&emsp; 常用工具有：iostat、iotop、df、iftop、sar、glances  

### 1.1.6. 网络监控
&emsp; 网络监控是我们构建监控平台是必须要考虑的，尤其是针对有多个机房的场景，各个机房之间的网络状态，机房和全国各地的网络状态都是我们需要重点关注的对象，那么如何掌握这些状态信息呢？我们需要借助于网络监控工具Smokeping。  
&emsp; Smokeping 是rrdtool的作者Tobi Oetiker的作品，是用Perl写的，主要是监视网络性能，www 服务器性能，dns查询性能等，使用rrdtool绘图，而且支持分布式，直接从多个agent进行数据的汇总。  

&emsp; 同时，由于自己监控点比较少，还可以借助很多商业的监控工具，比如监控宝、听云、基调、博瑞等。同时这些服务提供商还可以帮助你监控CDN的状态。   

### 1.1.7. 流量分析
&emsp; 网站流量分析对于运维人员来说，更是一门必须掌握的知识了。比如对于一家电商公司来说：通过对订单来源的统计和分析，可以了解我们在某个网站上的广告投入有没有收到预期的效果。可以区分不同地区的访问人数、甚至商品交易额等。  


### 1.1.8. 应用监控
&emsp; 把硬件监控和系统监控研究明白后，我们进一步操作是需要登陆到服务器上查看服务器运行了哪些服务，都需要监控起来。  
&emsp; 应用服务监控也是监控体系中比较重要的内容，例如：LVS、Haproxy、Docker、Nginx、PHP、Memcached、Redis、MySQL、Rabbitmq等等，相关的服务都需要使用zabbix监控起来。  

&emsp; 百度统计、google分析、站长工具等等，只需要在页面嵌入一个js即可。  
&emsp; 但是，数据始终是在对方手中，个性化定制不方便，于是google出一个叫piwik的开源分析工具。  

### 1.1.9. 日志监控
&emsp; 通常情况下，随着系统的运行，操作系统会产生系统日志，应用程序会产生应用程序的访问日志、错误日志，运行日志，网络日志，我们可以使用ELK来进行日志监控。  

&emsp; 对于日志监控来说，最见的需求就是收集、存储、查询、展示，开源社区正好有相对应的开源项目：logstash（收集） + elasticsearch（存储+搜索） + kibana（展示）。我们将这三个组合起来的技术称之为ELK Stack，所以说ELK Stack指的是Elasticsearch、Logstash、Kibana技术栈的结合。  

&emsp; 如果收集了日志信息，那么如果部署更新有异常出现，可以立即在kibana上看到。  


### 1.1.10. 安全监控
&emsp; 虽然Linux开源的安全产品不少，比如四层iptables，七层WEB防护nginx+lua实现WAF，最后将相关的日志都收至Elkstack，通过图形化进行不同的攻击类型展示。但是始终是一件比较耗费时间，并且个人效果并不是很好。这个时候我们可以选择接入第三方服务厂商。  

&emsp; 三方厂商提供全面的漏洞库，涵盖服务、后门、数据库、配置检测、CGI、SMTP等多种类型全面检测主机、Web应用漏洞自主挖掘和行业共享相结合第一时间更新0day漏洞，杜绝最新安全隐患  

### 1.1.11. API监控
&emsp; 由于API变得越来越重要，很显然我们也需要这样的数据来分辨我们提供的 API是否能够正常运作。  
&emsp; 监控API接口GET、POST、PUT、DELETE、HEAD、OPTIONS的请求  
&emsp; 可用性、正确性、响应时间为三大重性能指标  


### 1.1.12. 性能监控
&emsp; 全面监控网页性能，DNS响应时间、HTTP建立连接时间、页面性能指数、响应时间、可用率、元素大小等  



### 1.1.13. 业务监控
&emsp; 没有业务指标监控的监控平台，不是一个完善的监控平台，通常在我们的监控系统中，必须将我们重要的业务指标进行监控，并设置阈值进行告警通知。比如电商行业：  
&emsp; 每分钟产生多少订单，每分钟注册多少用户，每天有多少活跃用户，每天有多少推广活动，推广活动引入多少用户，推广活动引入多少流量，推广活动引入多少利润等等 重要指标都可以加入zabbix上，然后通过screen展示。  


### 1.1.14. 监控报警及处理    
&emsp; 故障报警通知的方式有很多种，当然我们最常用的还是短信，邮件  
![image](http://182.92.69.8:8081/img/monitor/monitor-8.png)  

&emsp; **报警处理：**  
&emsp; 一般报警后我们故障如何处理，首先，我们可以通过告警升级机制先自动处理，比如nginx服务down了，可以设置告警升级自动启动nginx。  
&emsp; 但是如果一般业务出现了严重故障，我们通常根据故障的级别，故障的业务，来指派不同的运维人员进行处理。  
&emsp; 当然不同业务形态、不同架构、不同服务可能采用的方式都不同，这个没有一个固定的模式套用。  
![image](http://182.92.69.8:8081/img/monitor/monitor-9.png)  

