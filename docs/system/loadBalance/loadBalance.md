
<!-- TOC -->

- [1. 负载均衡](#1-负载均衡)
    - [1.1. ~~前言：一次网络请求~~](#11-前言一次网络请求)
    - [1.2. ~~均衡技术~~](#12-均衡技术)
    - [1.3. ★★★基于网络的负载均衡的分类](#13-★★★基于网络的负载均衡的分类)
    - [1.4. 负载均衡算法](#14-负载均衡算法)
    - [1.5. 常用负载均衡工具](#15-常用负载均衡工具)

<!-- /TOC -->

&emsp; **<font color = "red">总结：</font>**  
&emsp; **<font color = "clime">★★★负载均衡方案选择</font>**  
&emsp; 小于3000万pv的，DNS轮询+监控；  
&emsp; **3000万以上的，nginx+监控；**  
&emsp; 5000万PV的，HAProxy+Keepalived,nginx，HAPROXY负责TCP的负载均衡，nginx负责7层调度；  
&emsp; **1亿以上的，LVS-DR+keepalived,nginx，LVS-DR负责TCP的负载均衡，nginx负责7层调度。**  

# 1. 负载均衡
<!--
https://www.jianshu.com/p/e3ac7d42c408
一文概括6种负载均衡技术的实现方式！
https://developer.51cto.com/art/201905/596538.htm?pc

https://blog.csdn.net/xlgen157387/article/details/78678772
亿级Web系统负载均衡几种实现方式 
https://mp.weixin.qq.com/s/cD4_yc9Lp5q76xzeys6N_g
全网最详尽的负载均衡原理图解 
https://mp.weixin.qq.com/s/JUM2W6qtNuZuSGbpAmFXnQ
不可不知的负载均衡
https://mp.weixin.qq.com/s/HRfHQm1ihSEs6VFzxoC4rQ
几种负载均衡技术的实现
https://blog.csdn.net/mengdonghui123456/article/details/53981976

-->
&emsp; 负载均衡(Load Balance)是集群技术(Cluster)的一种应用技术。负载均衡建立在现有网络结构之上，它提供了一种廉价有效透明的方法扩展网络设备和服务器的带宽、增加吞吐量、加强网络数据处理能力、提高网络的灵活性和可用性。 目前最常见的负载均衡应用是Web负载均衡。  

## 1.1. ~~前言：一次网络请求~~
&emsp; 客户端 ---> 网络链路 ---> 服务端


## 1.2. ~~均衡技术~~   
![image](https://gitee.com/wt1814/pic-host/raw/master/images/system/loadBalance/load-3.png)  

&emsp;常见的软件负载均衡技术有以下几种：  
1. 基于DNS的负载均衡  
&emsp; 由于在DNS服务器中，可以为多个不同的地址配置相同的名字，最终查询这个名字的客户机将在解析这个名字时得到其中一个地址，所以这种代理方式是通过DNS服务中的随机名字解析域名和IP来实现负载均衡。  
2. 反向代理负载均衡（如Apache+JK2+Tomcat这种组合）  
&emsp; 该种代理方式与普通的代理方式不同，标准代理方式是客户使用代理访问多个外部Web服务器，之所以被称为反向代理模式是因为这种代理方式是多个客户使用它访问内部Web服务器，而非访问外部服务器。  
3. 基于NAT(Network Address Translation)的负载均衡技术(如Linux VirtualServer，简称LVS)  
&emsp; 该技术通过一个地址转换网关将每个外部连接均匀转换为不同的内部服务器地址，因此外部网络中的计算机就各自与自己转换得到的地址上的服务器进行通信，从而达到负载均衡的目的。其中网络地址转换网关位于外部地址和内部地址之间，不仅可以实现当外部客户机访问转换网关的某一外部地址时可以转发到某一映射的内部的地址上，还可使内部地址的计算机能访问外部网络。  

&emsp; 除了软件负载均衡技术，常见的还有CDN(Content Delivery Network，内容分发网络)。通过发布机制将内容同步到大量的缓存节点，并在DNS服务器上进行扩展，找到里用户最近的缓存节点作为服务提供节点。  

--------------------


&emsp;  ~~主要应用~~
1. DNS负载均衡   
&emsp; 最早的负载均衡技术是通过DNS来实现的，在DNS中为多个地址配置同一个名字，因而查询这个名字的客户机将得到其中一个地址，从而使得不同的客户访问不同的服务器，达到负载均衡的目的。DNS负载均衡是一种简单而有效的方法，但是它不能区分服务器的差异，也不能反映服务器的当前运行状态。  
2. 代理服务器负载均衡  
&emsp; 使用代理服务器，可以将请求转发给内部的服务器，使用这种加速模式显然可以提升静态网页的访问速度。然而，也可以考虑这样一种技术，使用代理服务器将请求均匀转发给多台服务器，从而达到负载均衡的目的。  
3. 地址转换网关负载均衡    
&emsp; 支持负载均衡的地址转换网关，可以将一个外部IP地址映射为多个内部IP地址，对每次TCP连接请求动态使用其中一个内部地址，达到负载均衡的目的。  
4. 协议内部支持负载均衡    
&emsp; 除了这三种负载均衡方式之外，有的协议内部支持与负载均衡相关的功能， **<font color = "clime">例如HTTP协议中的重定向能力等，</font>** HTTP运行于TCP连接的最高层。  
5. NAT负载均衡NAT(Network Address Translation网络地址转换)   
&emsp; 简单地说就是将一个IP地址转换为另一个IP地址，一般用于未经注册的内部地址与合法的、已获注册的Internet IP地址间进行转换。适用于解决Internet IP地址紧张、不想让网络外部知道内部网络结构等的场合下。  
6. 反向代理负载均衡    
&emsp; 普通代理方式是代理内部网络用户访问internet上服务器的连接请求，客户端必须指定代理服务器，并将本来要直接发送到internet上服务器的连接请求发送给代理服务器处理。反向代理(Reverse Proxy)方式是指以代理服务器来接受internet上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给internet上请求连接的客户端，此时代理服务器对外就表现为一个服务器。反向代理负载均衡技术是把将来自internet上的连接请求以反向代理的方式动态地转发给内部网络上的多台服务器进行处理，从而达到负载均衡的目的。  
7. 混合型负载均衡    
&emsp; 在有些大型网络，由于多个服务器群内硬件设备、各自的规模、提供的服务等的差异，可以考虑给每个服务器群采用最合适的负载均衡方式，然后又在这多个服务器群间再一次负载均衡或群集起来以一个整体向外界提供服务(即把这多个服务器群当做一个新的服务器群)，从而达到最佳的性能。将这种方式称之为混合型负载均衡。此种方式有时也用于单台均衡设备的性能不能满足大量连接请求的情况下。  

## 1.3. ★★★基于网络的负载均衡的分类  
&emsp; OSI模型有7层结构，每层都可以有几个子层。OSI的7层从上到下分别是物理层、数据链路层、网络层、传输层、会话层、表示层、应用层：  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/system/loadBalance/load-1.png)  
&emsp; 根据负载均衡技术实现在OSI七层模型的不同层次，是可以给负载均衡分类的。大致可以分为以下几种，其中最常用的是四层和七层负载均衡：  
&emsp; **二层负载均衡：**负载均衡服务器对外依然提供一个VIP(虚IP)，集群中不同的机器采用相同IP地址，但机器的MAC地址不一样。当负载均衡服务器接受到请求之后，通过改写报文的目标MAC地址的方式将请求转发到目标机器实现负载均衡。  
&emsp; **三层负载均衡：**和二层负载均衡类似，负载均衡服务器对外依然提供一个VIP(虚IP)，但集群中不同的机器采用不同的IP地址。当负载均衡服务器接受到请求之后，根据不同的负载均衡算法，通过IP将请求转发至不同的真实服务器。  
&emsp; **四层负载均衡：**四层负载均衡工作在OSI模型的传输层，由于在传输层，只有TCP/UDP协议，这两种协议中除了包含源IP、目标IP以外，还包含源端口号及目的端口号。四层负载均衡服务器在接受到客户端请求后，以后通过修改数据包的地址信息(IP+端口号)将流量转发到应用服务器。  
&emsp; **七层负载均衡：**七层负载均衡工作在OSI模型的应用层，应用层协议较多，常用http、radius、DNS等。七层负载就可以基于这些协议来负载。这些应用层协议中会包含很多有意义的内容。比如同一个Web服务器的负载均衡，除了根据IP加端口进行负载外，还可根据七层的URL、浏览器类别、语言来决定是否要进行负载均衡。  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/system/loadBalance/load-2.png)  
&emsp; 对于一般的应用来说，有了Nginx就够了。Nginx可以用于七层负载均衡。但是对于一些大的网站，一般会采用DNS+四层负载+七层负载的方式进行多层次负载均衡。  

<!-- 
七层负载均衡

七层负载均衡工作在 OSI 模型的应用层，应用层协议较多，常用 http、dns、ftp 等。七层负载就可以基于这些协议来负载。这些应用层协议中会包含很多有意义的内容。比如同一个 Web 服务器的负载均衡，除了根据 IP 加 port 进行负载外，还可根据 URL 来决定是否要进行负载均衡。
四层负载均衡

四层负载均衡工作在 OSI 模型的传输层，由于在传输层，只有 TCP/UDP 协议，这两种协议中除了包含源 IP、目标 IP 以外，还包含源端口及目的端口。四层负载均衡服务器在接受到客户端请求后，以后通过修改数据包的地址信息(IP+端口号)将流量转发到应用服务器。
-->

## 1.4. 负载均衡算法  
&emsp; **介绍**  
&emsp; 现有的负载均衡算法主要分为静态和动态两类。静态负载均衡算法以固定的概率分配任务，不考虑服务器的状态信息，如轮转算法、加权轮转算法等；动态负载均衡算法以服务器的实时负载状态信息来决定任务的分配，如最小连接法、加权最小连接法等。  
&emsp; **分类**
1. 轮询法：是将用户的请求轮流分配给服务器，就像是挨个数数，轮流分配。这种算法比较简单，他具有绝对均衡的优点，但是也正是因为绝对均衡它必须付出很大的代价，例如它无法保证分配任务的合理性，无法根据服务器承受能力来分配任务。  
2. 随机法：随机选择一台服务器来分配任务。它保证了请求的分散性达到了均衡的目的。同时它是没有状态的不需要维持上次的选择状态和均衡因子。但是随着任务量的增大，它的效果趋向轮询后也会具有轮询算法的部分缺点。  
3. 最小连接法：将任务分配给此时具有最小连接数的节点，因此它是动态负载均衡算法。一个节点收到一个任务后连接数就会加1，当节点故障时就将节点权值设置为0，不再给节点分配任务。  
&emsp; 最小连接法适用于各个节点处理的性能相似时。任务分发单元会将任务平滑分配给服务器。但当服务器性能差距较大时，就无法达到预期的效果。因为此时连接数并不能准确表明处理能力，连接数小而自身性能很差的服务器可能不及连接数大而自身性能极好的服务器。所以在这个时候就会导致任务无法准确的分配到剩余处理能力强的机器上。  

## 1.5. 常用负载均衡工具
&emsp; 常用的软件负载均衡软件有[Nginx](/docs/system/loadBalance/Nginx/nginx.md)、[LVS](/docs/system/loadBalance/LVS.md)、HaProxy等。  

&emsp; **<font color = "clime">★★★负载均衡方案选择</font>**  
&emsp; 小于3000万pv的，DNS轮询+监控；  
&emsp; **3000万以上的，nginx+监控；**  
&emsp; 5000万PV的，HAProxy+Keepalived,nginx，HAPROXY负责TCP的负载均衡，nginx负责7层调度；  
&emsp; **1亿以上的，LVS-DR+keepalived,nginx，LVS-DR负责TCP的负载均衡，nginx负责7层调度。**  
