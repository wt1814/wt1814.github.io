<!-- TOC -->

- [1. CDN](#1-cdn)
    - [1.1. CDN介绍](#11-cdn介绍)
    - [1.2. 关键技术](#12-关键技术)
    - [1.3. CDN 如何更新数据](#13-cdn-如何更新数据)
    - [1.4. CDN 带来的问题](#14-cdn-带来的问题)
    - [1.5. 使用CDN的工作流程](#15-使用cdn的工作流程)
    - [1.6. 使用CDN](#16-使用cdn)

<!-- /TOC -->

# 1. CDN  
<!-- 
 网友问：帅丙如何给女朋友解释什么是CDN？ 
https://mp.weixin.qq.com/s/f_yMAWw-ymhRldvBcpRH8Q

5分钟了解CDN 加速原理
https://mp.weixin.qq.com/s/Keway7ExLfTNunZTACoxnA
-->

<!-- 
~~
使用 CDN 的好处和注意事项
https://www.imydl.com/work/4073.html
WordPress 站点如何用好 CDN 加速？
https://www.imydl.com/wp/5863.html
-->

## 1.1. CDN介绍  
&emsp; CDN的全称是Content Delivery Network，即内容分发网络。其基本思路是尽可能避开互联网上有可能影响数据传输速度和稳定性的瓶颈和环节，使内容传输的更快、更稳定。通过在网络各处放置节点服务器所构成的在现有的互联网基础之上的一层智能虚拟网络，CDN系统能够实时地根据网络流量和各节点的连接、负载状况以及到用户的距离和响应时间等综合信息将用户的请求重新导向离用户最近的服务节点上。其目的是使用户可就近取得所需内容，解决 Internet网络拥挤的状况，提高用户访问网站的响应速度。  

&emsp; **主要特点：**  
1. 本地Cache加速提高了企业站点（尤其含有大量图片和静态页面站点）的访问速度，并大大提高以上性质站点的稳定性。
2. 镜像服务消除了不同运营商之间互联的瓶颈造成的影响，实现了跨运营商的网络加速，保证不同网络中的用户都能得到良好的访问质量。
3. 远程加速远程访问用户根据DNS负载均衡技术智能自动选择Cache服务器，选择最快的Cache服务器，加快远程访问的速度。  
4. 带宽优化自动生成服务器的远程Mirror(镜像)cache 服务器，远程用户访问时从cache服务器上读取数据，减少远程访问的带宽、分担网络流量、减轻原站点WEB服务器负载等功能。
5. 集群抗攻击广泛分布的CDN节点加上节点之间的智能冗余机制，可以有效地预防黑客入侵以及降低各种D.D.o.S攻击对网站的影响，同时保证较好的服务质量。

## 1.2. 关键技术  
<!-- 
CDN 加速静态资源访问
https://mp.weixin.qq.com/s/VIjHRl5GogichFnf66Wi3g

内容发布 

它借助于建立索引、缓存、流分裂、组播（Multicast）等技术，将内容发布或投递到距离用户最近的远程服务点（POP）处。

内容存储 

对于CDN系统而言，需要考虑两个方面的内容存储问题。一个是内容源的存储，一个是内容在 Cache节点中的存储。


内容路由 

它是整体性的网络负载均衡技术，通过内容路由器中的重定向（DNS）机制，在多个远程POP上均衡用户的请求，以使用户请求得到最近内容源的响应。

内容管理 

它通过内部和外部监控系统，获取网络部件的状况信息，测量内容发布的端到端性能（如包丢失、延时、平均带宽、启动时间、帧速率等），保证网络处于最佳的运行状态。


CDN的关键技术主要有内容存储和分发技术
内存存储

比如说我们有个图片网站应用部署在成都，一开始应用只在成都当地推广本地人使用。后面业务发展出去了，全国各地的人都在访问了，处于新疆乌鲁木齐的用户发现图片加载的速度变得很慢（因为图片这些数据需要从成都通过网线传输到乌鲁木齐太远了，而且中途可能存在网络拥挤等等原因）那么想个办法，我们在乌鲁木齐部署一个缓存服务器，后续乌鲁木齐的用户只要访问过某张图片就将其缓存到乌鲁木齐的服务器上，后续的访问就可以变得更快
分发技术

比如说访问乌鲁木齐缓存服务器没有对应的图片缓存的时候，这个时候可以去访问西北数据中心获取数据，西北数据中心没有再去源数据中心获取，这样可以尽可能的减少对源数据中心的访问减少源数据中心压力的同时，加速用户的访问体验

CDN 可以缓存什么
网页、图片、文件等一些不经常改变的数据，可以缓存到 CDN 中
-->
1. 内容发布：它借助于建立索引、缓存、流分裂、组播(Multicast)等技术，将内容发布或投递到距离用户最近的远程服务点(POP)处；
2. 内容路由：它是整体性的网络负载均衡技术，通过内容路由器中的重定向(DNS)机制，在多个远程POP上均衡用户的请求，以使用户请求得到最近内容源的响应；
3. 内容交换：它根据内容的可用性、服务器的可用性以及用户的背景，在POP的缓存服务器上，利用应用层交换、流分裂、重定向(ICP、WCCP)等技术，智能地平衡负载流量；
4. 性能管理：它通过内部和外部监控系统，获取网络部件的状况信息，测量内容发布的端到端性能(如包丢失、延时、平均带宽、启动时间、帧速率等)，保证网络处于最佳的运行状态。

## 1.3. CDN 如何更新数据
&emsp; 查找的数据有可能不存在，也有可能过期了，如何更新CDN缓存呢？拉取模式或推送模式。  

* 如果是某份热点数据，一开始就近CDN缓存中没有就向上拉取，如果出现回源，可能导致源数据中心压力会过大。
* 这个时候可以采取主动推送模式，将热点数据主动推送到边缘结点。

## 1.4. CDN 带来的问题

* 防盗链问题
    * 请求附带 refer 标示来源
    * 时间戳防盗链
* 数据过期问题
    * 当服务器数据更新后，CDN数据还未更新时，静态资源访问可能存在不一致的问题。
    * 资源都是有设置过期时间的，等到过期时间到了就会回源拉取最新内容。
    * 主动刷新CDN缓存，强制性的让缓存失效全部回源拉取最新数据。


## 1.5. 使用CDN的工作流程  
<!-- 
https://blog.csdn.net/hetoto/article/details/90509328
https://mp.weixin.qq.com/s/VIjHRl5GogichFnf66Wi3g


CDN 基本工作过程
https://blog.csdn.net/u014209205/article/details/89892359
-->
&emsp; 考虑没有CDN的情况，发布了一些静态资源服务，然后来自世界各地的用户开始请求资源。  
&emsp; 假设静态资源服务接入的是浙江移动的ISP，而世界各地的用户接入的ISP是各种各样的。同样假设北京到杭州之间的通信延时是3ms，对于一次web请求就至少是6ms的延时(请求+响应)，因此ISP之间的通信互联成为影响静态资源加载速度的一个重要瓶颈！
![image](https://gitee.com/wt1814/pic-host/raw/master/images/system/loadBalance/cdn/cdn-1.png)  
&emsp; 具体看一下没有CDN的web请求过程，主要分为两步：1. 域名服务器解析IP地址 ；2. 和目标机器建立连接请求资源。  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/system/loadBalance/cdn/cdn-2.png)  
&emsp; 在域名解析的过程中，由于域名和IP映射存储在server-isp-DNS服务器(A记录解析)，发起请求之后，需要通过根域名服务器依次迭代查询。最后返回源站的IP地址给客户端，开始建立连接请求资源。而对于使用CDN服务的架构，通常是下面这样的：  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/system/loadBalance/cdn/cdn-3.png)  
&emsp; server-isp-DNS服务器不是直接把域名做A记录映射到源站，而是CNAME记录到调度中心，调度中心根据用户请求的来源，选择一个最近的CDN节点的IP地址(通常是虚拟IP地址)。用户和CDN节点IP地址建立连接开始请求资源，CDN节点内部进行负载均衡后，负责响应的机器查询是否有该资源(第一次请求的延时和没有使用CDN服务是一样的)，如果没有则回源站进行请求(同时进行缓存)，然后响应请求。  
<!-- 
看完原理和架构之后，再来看你的问题，当然就是看看web请求是否存在跨ISP通信的情况了。 
--> 
&emsp; 当然，CDN服务除了可以加速之外，还带了高效的负载均衡调度机制，可以大大减少源站服务器的负载。  

## 1.6. 使用CDN  
<!--
~~ 
https://www.imydl.com/work/4073.html
-->
&emsp; 阿里云CDN加速怎么操作使用？https://jingyan.baidu.com/article/fc07f989b320cb12ffe5190e.html  

&emsp; “如何用好 CDN 加速”？  
&emsp; 所谓的“用好”其实就是指真正的起到加速的作用，无论是前端的用户访问还是服务器端的稳定运行。 CDN 的核心思想就是“动静分离”。  

    何为动态、静态
    简单点儿来说，这里的动态和静态是只针对服务器和客户端浏览器来说，动态是指需要服务器端经过运算调取数据库后返回的数据，静态是指以文件形式存储在服务器上的数据。从过程上来看动态的效率要低一些，静态的要高一些，其实就是中间运算和数据库查询调用这个环节的差异而已。具体表现到文件一般就是动态的是指 php、asp、jsp 这类需要服务器端运算的代码文件，静态的一般是指 html、jpg、png、jpeg 等等这类文件，虽然 html 也是代码，但这些代码都是浏览器来运算的，所以对服务器来说也是静态的。

&emsp; CDN 加速其实就是把服务器上的静态文件都放到 CDN 各个节点上面，然后用户访问的时候， CDN 会分配一个离用户最近节点给用户访问，这样就达到了提速的效果。  
&emsp; 那么在部署 CDN 的时候只需要做到下面几点就可以了：

1. 只让CDN获取站点的静态文件资源，也就是缓存规则里要指明只缓存静态文件，因为这类静态文件一般都不会频繁的修改，所以建议缓存时间可以设定长一些，一般 7 天为宜。  
2.  xxx站点一定要开启“伪静态化”，也就是呈现的网页最好是.html 文件。  
3. 服务器端要保证对 CDN 节点是开放的，也就是要将 CDN 节点 IP 加入到服务器防火墙“白名单”里，否则 CDN 会频繁的回源服务器(造成这个主要原因就是服务器防火墙有时候会把 CDN 节点给拦截掉，所以加到“白名单”就可以规避这个问题了)，造成服务器负载增加甚至宕机被关停。  

&emsp; 很多站长们在部署 CDN 的时候都是做到了前两条，忽略了最后一条，虽然有的时候也是可以正常使用的，但是一旦 CDN 某个节点出现运算错误频繁回源就会出现服务器负载瞬间加大，如果是虚拟主机的话就会被运营商关停(比如万网的虚拟主机等)，同时还会在 CDN 后台的统计里出现回源率高的现象也就是 CDN 缓存命中率奇低的问题。只要做到上述三点基本上CDN部署已经是成功的了。剩下的就是让CDN慢慢的来根据用户访问情况自动缓存即可， CDN 用的越久其加速表现越好就在这里，只有用户访问请求的CDN才会让节点去调用服务器上的资源。这些资源在节点上保存的越多，CDN 缓存命中率就越高，加速效果也就越明显。  

    如果是个喜欢折腾的站长，比如经常会改动站点主题的 CSS、JS 文件的可以 CDN 控制后台里取消 CSS、JS 文件的缓存即可，毕竟频繁的让 CDN 更新缓存会对服务器造成一定的负载压力的。

![image](https://gitee.com/wt1814/pic-host/raw/master/images/system/loadBalance/cdn/cdn-4.png)  
&emsp; 关于最后一条里提到的[将 CDN 节点 IP 加入到服务器防火墙“白名单”里]，这点对于使用“虚拟主机”的站点是需要服务器管理员来操作的，一般为了安全考虑都不愿给添加的，这个目前明月也没有很好的办法。至于说使用 ECS 类云主机的必须自己手动的来添加了，但是，添加之前一定要搞清楚自己的 ECS 主机使用的默认防火墙是什么以及如何使用等等问题，明月建议是使用 Linux 默认的 iptables 作为服务器的默认防火墙，因为 iptables 实在是太强大了，好处很多。但这些需要具备一定的 Linux 命令行操作的基本知识的，当然大家也可以借助“百度、谷歌”来搜索到众多的相关教程，虽然这些看似很复杂，但是要记得“一次折腾、受用终生”哦。  
