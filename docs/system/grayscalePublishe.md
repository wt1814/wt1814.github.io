
<!-- TOC -->

- [1. 灰度发布](#1-灰度发布)
    - [1.1. 灰度发布简介](#11-灰度发布简介)
    - [1.2. 灰度发布设计的思考](#12-灰度发布设计的思考)
    - [1.3. 微服务网关实现灰度发布](#13-微服务网关实现灰度发布)
        - [zuul实现灰度发布](#zuul实现灰度发布)
    - [1.4. Spring cloud ribbon实现灰度发布](#14-spring-cloud-ribbon实现灰度发布)
    - [1.5. dubbo实现灰度发布](#15-dubbo实现灰度发布)

<!-- /TOC -->



# 1. 灰度发布  
<!-- 
网关实现灰度发布
https://segmentfault.com/a/1190000017894943
-->

## 1.1. 灰度发布简介 
1. 背景
&emsp; 互联网产品开发有个非常特别的地方，就是不停的升级，升级，再升级。采用敏捷开发的方式，基本上保持每周或者每两周一次的发布频率，系统升级总是伴随着各种风险，新旧版本兼容的风险，用户使用习惯突然改变而造成用户流失的风险，系统宕机的风险，500错误服务不可用的风险等等。为了避免这些风险，很多产品都采用了灰度发布的策略，其主要思想就是把影响集中到一个点，然后再发散到一个面，出现意外情况后很容易就回退，即使影响也是可控的。  
&emsp; 任何脱离实际业务的技术工作都是耍流氓，技术需要服务于业务。因此，本文尽量淡化了业务方面的因素，聚焦于技术层面，建议在实际运用中还是要根据各自的业务场景去变化和调整。  

2. 什么是灰度
&emsp; 灰度发布是指在黑与白之间，能够平滑过渡的一种发布方式。AB test就是一种灰度发布方式，让一部分用户继续用A，一部分用户开始用B，如果用户对B没有什么反对意见，那么逐步扩大范围，把所有用户都迁移到B上面来。灰度发布可以保证整体系统的稳定，在初始灰度的时候就可以发现、调整问题，以保证其影响度。  
&emsp; 互联网系统，灰度其实就是根据设定的规则将请求路由到我们的灰度版本（灰度机器）上来。比如对于API来说，一般有如下几个需求：特定用户（比如测试帐号）、 特定的App（比如测试app或者合作App）、特定的模块、接口（只有某些接口需要灰度，这种一般是API Container的修改，拿一些不是很重要的API做灰度测试）、特定的机器（某些请求IP转发到灰度机）等。  

3. 灰度的优势
    1. 在发布过程中降低上线风险  
    2. 降低影响范围，并且范围可控  
    3. 降低对测试的依赖，减少线下自测的数据构造成本  
    4. 特定的请求能够指向特定的服务器，方便集中监控日志，方便跟踪完整的调用链路  
    5. 方便系统流量切入  
    6. 便于随时回滚  
    7. 指定特定人群，方便系统回访，方便产品需求收集，完善产品功能，提升产品质量  
    8. 在无状态的情况下保障用户使用到的版本一致  
    9. 避免宕机给用户带来不好的体验和使用  

## 1.2. 灰度发布设计的思考
1. 目标
    1. 做到对现有业务系统无侵入性  
    2. 能够发挥以上提到的灰度的优势  
    3. 发布系统的灵活配置  
    4. 发布系统和业务系统的松耦合  
    5. 和网关系统结合，让操作平滑  

2. 功能  
    1. 路由策略管理/配置
    2. 灰度规则管理
    3. 开启/关闭开关

3. 系统设计  
&emsp; 需要设计的系统分为两种场景，一种是http方式接入，需要借助网关(gate-way)去实现流量的切换，和系统路由；另一种是rpc接入(目前为dubbo)，需要借助dubbo提供的负载均衡策略来实现，结合自带的qos(dubbo的在线运维命令)实现服务启动/关闭。  
&emsp; 【说明】：服务内部执行线程监控待定，sentinel、 pinpoint or other。  

## 1.3. 微服务网关实现灰度发布  

![image](https://gitee.com/wt1814/pic-host/raw/master/images/stability/stab-1.png)  
&emsp; 其中分为几个重要的部分：  
&emsp; 接入层网关，接入客户端请求，根据下发的配置将符合条件的请求转发到新旧系统上。  
&emsp; 配置管理后台，这个后台可以配置不同的转发策略给接入层网关。  
&emsp; 稳定和灰度两种处理客户端请求的业务服务器。  

&emsp; http请求的入口都落在网关上，网关会根据管控平台(admin dashboard)的配置进行uri的选择。此时请求数据会判断当前应用是否已经开启灰度，再次判断是应用级别的灰度还是服务级别的灰度，然后根据管控平台配置的灰度策略进行灰度，可以支持白名单、权重、ip段、业务域等。  
&emsp; 管控平台会调用引擎管理执行相应的指令，进行关闭、开启、更新策略和白名单数据等，每次网关重新reload和重启时会从灰度管理系统调用接口读取配置应用的信息，加入缓存。  
&emsp; 为了提升性能，应用的基本信息、灰度策略、白名单等数据缓存在内存或者类redis这样的缓冲中，灵活的进行缓存数据的更新。  
&emsp; 实现功能：  
1. 动态路由
2. 服务动态编排，实现流量的自由切换
3. 启服/停服
4. 服务自检

### zuul实现灰度发布  
&emsp; [zuul实现灰度发布](/docs/system/gatewayGrayscale.md)  

## 1.4. Spring cloud ribbon实现灰度发布  


## 1.5. dubbo实现灰度发布  

<!-- 
https://segmentfault.com/a/1190000017894943
-->



