


# 资源限制  
<!-- 
高并发架构系列：什么是流量削峰？如何解决秒杀业务的削峰场景
https://blog.csdn.net/m0_37125796/article/details/88833419
-->
&emsp; 并发高，但是服务器资源有限，可以采取哪些方案？具体案例可以参考[秒杀系统设计](/docs/system/seckill.md)。    
1. 高并发3大利器：[缓存](/docs/cache/Cache.md)、[限流](/docs/microService/thinking/CurrentLimiting.md)、[降级](/docs/microService/thinking/Demotion.md)；
2. 削峰：[mq消峰](/docs/microService/mq/mq.md)、流量削峰；
3. 将请求放入队列中（包括但不限于阻塞队列、高效队列、redis队列）；  
4. 使用服务器请求队列。例如tomcat的server.xml中增大acceptCount值。  
&emsp; acceptCount：当tomcat请求处理线程池中的所有线程都处于忙碌状态时，此时新建的链接将会被放入到pending队列，acceptCount即是此队列的容量，如果队列已满，此后所有的建立链接的请求(accept)，都将被拒绝。默认为100。在高并发/短链接较多的环境中，可以适当增大此值；当长链接较多的场景中，可以将此值设置为0。  
5. 池化技术。各种池化技术的使用和池大小的设置，包括HTTP请求池、线程池（考虑CPU密集型还是IO密集型设置核心参数）、数据库和Redis连接池等。    



--------------


&emsp; 流量削峰漏斗：层层削峰   

&emsp; 针对秒杀场景还有一种方法，就是对请求进行分层过滤，从而过滤掉一些无效的请求。  
&emsp; 分层过滤其实就是采用“漏斗”式设计来处理请求的，如下图所示：  
&emsp; 高并发架构系列：什么是流量削峰？如何解决秒杀业务的削峰场景  
&emsp; 这样就像漏斗一样，尽量把数据量和请求量一层一层地过滤和减少了。  

&emsp; 1）分层过滤的核心思想  
 
* 通过在不同的层次尽可能地过滤掉无效请求。
* 通过CDN过滤掉大量的图片，静态资源的请求。
* 再通过类似Redis这样的分布式缓存，过滤请求等就是典型的在上游拦截读请求。

&emsp; 2）分层过滤的基本原则  

* 对写数据进行基于时间的合理分片，过滤掉过期的失效请求。
* 对写请求做限流保护，将超出系统承载能力的请求过滤掉。
* 涉及到的读数据不做强一致性校验，减少因为一致性校验产生瓶颈的问题。
* 对写数据进行强一致性校验，只保留最后有效的数据。

&emsp; 最终，让“漏斗”最末端(数据库)的才是有效请求。例如：当用户真实达到订单和支付的流程，这个是需要数据强一致性的。  


&emsp; **流量削峰总结：**  

1. 对于秒杀这样的高并发场景业务，最基本的原则就是将请求拦截在系统上游，降低下游压力。如果不在前端拦截很可能造成数据库(mysql、oracle等)读写锁冲突，甚至导致死锁，最终还有可能出现雪崩等场景。  
2. 划分好动静资源，静态资源使用CDN进行服务分发。  
3. 充分利用缓存(redis等)：增加QPS，从而加大整个集群的吞吐量。  
4. 高峰值流量是压垮系统很重要的原因，所以需要Kafka等消息队列在一端承接瞬时的流量洪峰，在另一端平滑地将消息推送出去。  