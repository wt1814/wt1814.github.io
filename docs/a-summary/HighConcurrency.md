
<!-- TOC -->

- [1. 高并发](#1-高并发)
    - [1.1. 系统性能指标](#11-系统性能指标)
    - [服务器数量计算](#服务器数量计算)
    - [1.2. 并发系统三高](#12-并发系统三高)
        - [1.2.1. 高可用建设](#121-高可用建设)
    - [1.3. 秒杀系统设计](#13-秒杀系统设计)
    - [1.4. 资源限制](#14-资源限制)

<!-- /TOC -->


# 1. 高并发  

## 1.1. 系统性能指标
1. 吞吐量  
&emsp; 一般来说， **<font color = "clime">系统吞吐量指的是系统的抗压、负载能力，代表一个系统每秒钟能承受的最大用户访问量。</font>**   
&emsp; **<font color = "clime">`一个系统的吞吐量通常由qps(tps)、并发数来决定，`每个系统对这两个值都有一个相对极限值，只要某一项达到最大值，系统的吞吐量就上不去了。</font>**  
2. QPS  
&emsp; Queries Per Second，每秒查询数，即是每秒能够响应的查询次数，注意这里的查询是指用户发出请求到服务器做出响应成功的次数，简单理解可以认为查询=请求request。`qps=每秒钟request数量`  
3. TPS  
&emsp; Transactions Per Second 的缩写，每秒处理的事务数。一个事务是指一个客户机向服务器发送请求然后服务器做出反应的过程。客户机在发送请求时开始计时，收到服务器响应后结束计时，以此来计算使用的时间和完成的事务个数。  
&emsp; 针对单接口而言，TPS可以认为是等价于QPS的，比如访问一个页面/index.html，是一个TPS，而访问/index.html页面可能请求了3次服务器比如css、js、index接口，产生了3个QPS。  
4. 并发数  
&emsp; 简而言之，系统能同时处理的请求/事务数量。  
&emsp; 计算方式：QPS = 并发数 / RT 或者 并发数= QPS * RT  

## 服务器数量计算

## 1.2. 并发系统三高
&emsp; 高并发绝不意味着只追求高性能，这是很多人片面的理解。从宏观角度看，高并发系统设计的目标有三个：高性能、高可用，以及高可扩展。  
1. **<font color = "clime">`高扩展`：表示系统的扩展能力，流量高峰时能否在短时间内完成扩容，更平稳地承接峰值流量，比如双11活动、明星离婚等热点事件。</font>**  
2. **<font color = "clime">`高可用`：表示系统可以正常服务的时间。</font>** 一个全年不停机、无故障；另一个隔三差五出线上事故、宕机，用户肯定选择前者。另外，如果系统只能做到90%可用，也会大大拖累业务。  
3. **<font color = "red">`高性能`：性能体现了系统的并行处理能力，在有限的硬件投入下，提高性能意味着节省成本。**</font> 同时，性能也反映了用户体验，响应时间分别是100毫秒和1秒，给用户的感受是完全不同的。  

![image](http://182.92.69.8:8081/img/system/availab/system-11.png)  

### 1.2.1. 高可用建设


## 1.3. 秒杀系统设计
1. <font color = "red">小结：</font>1. `（what）什么是`；2.`（why）问题`？；3.`（how）设计`；4.`流程`；5.`解决超卖、少卖问题`。     
1. `什么是`秒杀系统？定时开始、库存有限...  
2. 秒杀应该考虑哪些`问题`？  
&emsp; 链接暴露、恶意请求（接口防刷）、突然增加的网络及服务器带宽、超卖问题、数据库设计...  
3. ★★★秒杀系统`设计`：  
    &emsp; 从架构视角来看，<font color = "red">`秒杀系统本质是一个（架构）高可用、（系统）高性能、（数据）高一致的三高系统。`</font>  
    * （架构）高可用。流量削峰(答题、mq)、高可用建设。  
	* （系统）高性能。动静分离、热点优化以及服务端性能优化。  
        * **<font color = "clime">热点数据的处理三步走，一是热点识别，二是热点隔离，三是热点优化。</font>**   
            1. 热点隔离：1. 业务隔离；2. 部署隔离；3. 数据隔离。  
            2. 热点优化：缓存和限流。  
	* （数据）高一致。从业界通用的几种减库存方案切入。减库存一般有以下几个方式：下单减库存、付款减库存、<font color = "clime">`预扣库存（买家下单后，库存为其保留一定的时间（如15 分钟），超过这段时间，库存自动释放，释放后其他买家可以购买）。业界最为常见的是预扣库存。`</font>    
4. `秒杀的基本流程（redis扣减库存 ---> mq通知业务系统）`：在发布一个秒杀活动前，要将商品还有库存写入Redis缓存。当用户在前端页面进行抢购时，就通过操作Redis会对商品的库存进行扣减。在扣减完Redis中的库存数量后，再把扣减成功的消息发送到消息队列，之后就交给具体的业务系统进行处理，比如订单服务、支付服务等。在处理之后，再和MySql数据库进行交互，这样就完成了库存扣减的数据同步。    
5. 如何解决超卖、少卖问题？  
&emsp; `为了避免超额扣减导致超卖`，就需要使用Lua脚本保证两个操作（判断是否充足，扣减库存）步骤的原子性。  
&emsp; `少卖`：需要给消息队列配置一个重试策略。    


4. ~~秒杀业务完整`流程`：~~  
    * 后端service服务层。  
        * **<font color = "clime">使用缓存(Redis、Memchched)：将读多写少的业务数据放入缓存，如秒杀业务中可以将更新频繁的商品库存信息放入Redis缓存处理。</font>**  
            &emsp; 注：`库存信息放入Redis缓存的时候最好分为多份放入不同key的缓存中`，如库存为10万可以分为10份分别放入不同key的缓存中，这样将数据分散操作可以达到更高的读写性能。
        * 使用队列处理：将请求放入队列排队处理，以可控的速度来访问底层DB。
        * **<font color = "clime">异步处理：如将秒杀成功的订单通知信息通过消息队列(RabbitMQ、Kafka)来异步处理。</font>**    


## 1.4. 资源限制
&emsp; 并发高，但是服务器资源有限，可以采取哪些方案？具体案例可以参考[秒杀系统设计](/docs/system/seckill.md)。    
1. 高并发3大利器：[缓存](/docs/cache/Cache.md)、[限流](/docs/microService/thinking/CurrentLimiting.md)、[降级](/docs/microService/thinking/Demotion.md)；
2. 削峰：[mq消峰](/docs/microService/mq/mq.md)、流量削峰；
3. 将请求放入队列中（包括但不限于阻塞队列、高效队列、redis队列）；  
4. 使用服务器请求队列。例如tomcat的server.xml中增大acceptCount值。  
&emsp; acceptCount：当tomcat请求处理线程池中的所有线程都处于忙碌状态时，此时新建的链接将会被放入到pending队列，acceptCount即是此队列的容量，如果队列已满，此后所有的建立链接的请求(accept)，都将被拒绝。默认为100。在高并发/短链接较多的环境中，可以适当增大此值；当长链接较多的场景中，可以将此值设置为0。  
5. 池化技术。各种池化技术的使用和池大小的设置，包括HTTP请求池、线程池（考虑CPU密集型还是IO密集型设置核心参数）、数据库和Redis连接池等。    
