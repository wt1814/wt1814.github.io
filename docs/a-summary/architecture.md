
<!-- TOC -->

- [1. 系统架构](#1-系统架构)
    - [1.1. 项目构建](#11-项目构建)
        - [1.1.1. 接口幂等](#111-接口幂等)
        - [1.1.2. 接口响应时间](#112-接口响应时间)
        - [1.1.3. 接口预警](#113-接口预警)
    - [1.2. 架构设计](#12-架构设计)
        - [1.2.1. 系统架构图](#121-系统架构图)
        - [1.2.2. 架构质量属性](#122-架构质量属性)
        - [1.2.3. 系统瓶颈](#123-系统瓶颈)

<!-- /TOC -->

# 1. 系统架构  
## 1.1. 项目构建
### 1.1.1. 接口幂等
&emsp; 接口幂等常用解决方案：  
* 分布式锁
* DB锁
    * 1).select+insert，insert前先select，该方案可能不适用于并发场景，在并发场景中，要配合其他方案一起使用，否则同样会产生重复数据 
    * 2). 状态机
    * 3). 乐观锁（新增version字段）  

&emsp; **<font color = "blue">小结：</font>**  
&emsp; 一般场景直接使用redis分布式锁解决。可是redis分布式锁可能因编码、部署等，出现一些问题。    
&emsp; 对数据要求高的场景，使用分布式锁 + db锁，db锁一般采用状态机幂等。  
&emsp; 对于将商品数量放在redis中，扣减库存采用lua脚本，支付时反查订单系统，防止超卖问题。    

### 1.1.2. 接口响应时间
1. `链路追踪，`查询耗时情况。  
2. 接口的响应时间过长，你会怎么办？（此处只针对最简单的场景，抛开STW那些复杂的问题。）以下是我目前想到的：  
    1. 异步化（Runnable、Future）  
    2. 缓存  
    3. 并行（ForkJoinPool、CyclicBarrier）  
    4. 干掉锁（空间换时间）  

### 1.1.3. 接口预警
1. 应用主动发送：
    1. 钉钉应用开放平台
    2. logback添加error预警
2. 中间件：  
    1. Filebeat+Logstash发送Email告警日志

## 1.2. 架构设计
&emsp; ~~架构的方方面面： 1).架构模式、2).性能/系统瓶颈。~~   

&emsp; 功能、流程、性能。   
&emsp; 分布式（数据一致）、高并发（高性能、高可用、高扩展）  

1. 功能、流程
2. 性能/系统瓶颈：CPU、磁盘IO、内存、网络IO


&emsp; 应用型框架，Spring、Mybatis  
&emsp; 功能型框架，redis、mq，一般都是分布式、高并发系统。  

* 分布式带来的问题：  
* 高并发系统的三高：  

### 1.2.1. 系统架构图  
![image](http://182.92.69.8:8081/img/system/architecture-1.jpg)  
&emsp; pc请求包含：内部系统，外部系统（右下角，sass平台，AI平台）  


### 1.2.2. 架构质量属性
&emsp; 高性能、可靠性、可定制性、可扩展性...  
&emsp; 架构属性一般包括如下方面：性能，伸缩性，可用性，安全性，容错性，灾难恢复，可访问性，可运维，管理，灵活性，可扩展性，可维护性，国际化，本地化。还有法律法规，成本，人员等对上面架构属性的影响。 

--------

1. 架构自身：
2. 架构延伸：
3. 架构对外：


### 1.2.3. 系统瓶颈
1. 网络I/O
2. 磁盘I/O
3. 内存
4. CPU


