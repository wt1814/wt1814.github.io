---
title: 主从复制
date: 2020-02-27 00:00:00
tags:
    - SQL
---
<!-- TOC -->

- [1. 主从复制、读写分离](#1-主从复制读写分离)
    - [1.1. 主从复制拓扑结构](#11-主从复制拓扑结构)
    - [1.2. MySql主从复制原理](#12-mysql主从复制原理)
        - [1.2.1. 复制流程](#121-复制流程)
        - [1.2.2. 复制方式](#122-复制方式)
            - [1.2.2.1. 基于语句的复制](#1221-基于语句的复制)
            - [1.2.2.2. 基于行的复制](#1222-基于行的复制)
            - [1.2.2.3. 混合模式复制](#1223-混合模式复制)
- [2. 读写分离](#2-读写分离)
    - [2.1. 主从复制、读写分离带来的问题](#21-主从复制读写分离带来的问题)

<!-- /TOC -->


# 1. 主从复制、读写分离  
## 1.1. 主从复制拓扑结构  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/SQL/sql-11.png)  

* 一主一从：  
&emsp; 主备架构。只有主库提供读写服务；备库冗余作故障转移，即主库挂了，keepalive（一种工具）会自动切换到备库。  
* 一主多从：  
&emsp; 一台Slave承受不住读请求压力时，可以添加多台，进行负载均衡，分散读压力。还可以对多台Slave进行分工，服务于不同的系统，例如一部分Slave负责网站前台的读请求，另一部分Slave负责后台统计系统的请求。因为不同系统的查询需求不同，对Slave分工后，可以创建不同的索引，使其更好的服务于目标系统。  
&emsp; 主库单点，从库高可用。一旦主库挂了，写服务也就无法提供。  
&emsp; 存在问题：存在数据一致性问题。请看，一致性解决方案。  
* 双主复制：  
&emsp; 一主多从，Master存在下线的可能，例如故障或者维护，需要把Slave切换为Master。在原来的Master恢复可用后，由于其数据已经不是最新的了，不能再做主，需要作为Slave添加进来。那么就需要对其重新搭建复制环境，需要耗费一定的工作量。  
&emsp; 双主架构，两个主库同时提供服务，负载均衡。高可用，一个主库挂了，不影响另一台主库提供服务。这个过程对业务层是透明的，无需修改代码或配置。  

&emsp; 存在问题：第一，数据一致性问题，一致性解决方案可解决问题。第二，主键冲突问题，ID统一地由分布式ID生成服务来生成可解决问题。  

* 从库级联复制  
&emsp; 当直接从属于Master的Slave过多时，连到Master的Slave IO线程就比较多，对Master的压力是很大的。  
&emsp; 级联结构就是通过减少直接从属于Master的Slave数量，减轻Master的压力，分散复制请求，从而提高整体的复制效率。  
* 双主+主从架构  
&emsp; 存在问题：数据一致性问题、主键冲突问题。数据同步又多了一层，数据延迟更严重。  
* 双主+级联  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/SQL/sql-12.png)  

## 1.2. MySql主从复制原理  
<!-- https://mp.weixin.qq.com/s?__biz=MzU4NzYwNDAwMg==&mid=2247486953&idx=3&sn=8ce915a119d7a1d2bf32d82a1ece24ba&chksm=fde8c4a4ca9f4db2e9c40e65efcaefb9318dedb36411865b269b7b8026a80d250f45652f49a1&mpshare=1&scene=1&srcid=&sharer_sharetime=1587486135950&sharer_shareid=b256218ead787d58e0b58614a973d00d&key=79150dbf571fbc4896e24bfaa10bc51f375d54f7b7955b16d5d149611cc4488bc9bb38846d3564a0c365d73f8ebb056576cdee8f51847f3cd52bf867f4313410b386328262394bab8dd1a1d65bf80df6&ascene=1&uin=MTE1MTYxNzY2MQ%3D%3D&devicetype=Windows+10&version=62080079&lang=zh_CN&exportkey=ASnTeJ9F3S7ijOQUsEABecA%3D&pass_ticket=t7WrYQgRWkv7fomJ9tKSvYV9vbBBrtBhylesb1eYH1AGZ3bs%2FIfhN20euL1DBMbi -->
### 1.2.1. 复制流程  
&emsp; 复制是MySQL数据库提供的一种高可用性能的解决方案，一般用来建立大型的应用。总体来说，replication的工作原理分为以下3个步骤：  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/SQL/sql-27.png)  
1. 主服务器（master）把数据更改记录到二进制日志（binlog）中。  
2. 从服务器（slave）把主服务器的二进制日志复制到自己的中继日志（relay log）中。  
3. 从服务器重做日志中的日志，把更改应用到自己的数据库上，以达到数据的最终一致性。  
  
        同步方式可以划分为：异步、半同步和同步。  
        * 同步复制：指当主库执行完一个事务，所有的从库都执行了该事务才返回给客户端。因为需要等待所有从库执行完该事务才能返回，所以全同步复制的性能必然会收到严重的影响。需要有超时时间。  
        * 异步复制：MySQL默认的复制即是异步的，主库在执行完客户端提交的事务后会立即将结果返给给客户端，并不关心从库是否已经接收并处理，这样就会有一个问题，主如果crash掉了，此时主上已经提交的事务可能并没有传到从上，如果此时，强行将从提升为主，可能导致新主上的数据不完整。  
        * 半同步复制：介于异步复制和全同步复制之间，主库在执行完客户端提交的事务后不是立刻返回给客户端，而是等待至少一个从库接收到并写到relay log中才返回给客户端。相对于异步复制，半同步复制提高了数据的安全性，同时它也造成了一定程度的延迟，这个延迟最少是一个TCP/IP往返的时间。所以，半同步复制最好在低延时的网络中使用。  

### 1.2.2. 复制方式  
&emsp; 复制方式有三种：基于行的复制、基于语句的复制、混合模式复制。  

#### 1.2.2.1. 基于语句的复制  
&emsp; 基于SQL语句的复制(statement-based replication, SBR)，每一条会修改数据的sql语句会记录到binlog中。  
&emsp; ***优点：*** 不需要记录每一条SQL语句与每行的数据变化（不记录select操作），这样子binlog的日志也会比较少，减少了磁盘IO，提高性能。  
&emsp; ***缺点：*** 并非所有修改数据的语句都可以使用基于语句的复制进行复制。使用基于语句的复制时，任何非确定性行为都难以复制。此类数据修改语言（DML）语句的示例包括以下内容：  
        
        依赖于UDF或不确定的存储程序的语句，因为这样的UDF或存储程序返回的值取决于提供给它的参数以外的因素。  
        不带ORDER BY的LIMIT子句的DELETE和UPDATE语句是不确定的。 
 
#### 1.2.2.2. 基于行的复制  
&emsp; 不记录每一条SQL语句的上下文信息，仅需记录哪条数据被修改了，修改成了什么样子了。  
&emsp; ***优点：*** 没有基于行的复制模式无法处理的场景。  
&emsp; ***缺点：*** 会产生大量的日志。  

#### 1.2.2.3. 混合模式复制  
&emsp; 混合模式复制(mixed-based replication, MBR)：以上两种模式的混合使用，一般的复制使用STATEMENT模式保存binlog，对于STATEMENT模式无法复制的操作使用ROW模式保存binlog，MySQL会根据执行的SQL语句选择日志保存方式。  

# 2. 读写分离  
&emsp; 读写分离在数据库主从复制技术基础上实现（主从复制针对写入数据，读写分离主要针对读取数据）。  

## 2.1. 主从复制、读写分离带来的问题  
* 数据不一致问题（主从数据同步延迟问题）：当主库的TPS并发较高时，由于主库上面是多线程写入的，而从库的SQL线程是单线程的，导致从库SQL可能会跟不上主库的处理速度。因此有可能出现在master节点中已经插入了数据，但是从slave节点却读取不到的问题。对于一些强一致性的业务场景，要求插入后必须能读取到，对于这种情况，需要提供一种方式，让读请求也可以走主库，而主库上的数据必然是最新的。  
&emsp; 延迟的解决：    
1). 网络方面：将从库分布在相同局域网内或网络延迟较小的环境中。  
2). 硬件方面：从库配置更好的硬件，提升随机写的性能。  
3). 配置方面：从库配置sync_binlog=0，innodb_flush_log_at_trx_commit=2，logs-slave-updates=0，增大innodb_buffer_pool_size，让更多操作在Mysql内存中完成，减少磁盘操作。或者升级Mysql5.7版本使用并行复制。  
4). 架构方面：比如在事务当中尽量对主库读写，其他非事务中的读在从库。消除一部分延迟带来的数据库不一致。增加缓存降低一些从库的负载。  
* 事务问题：读写分离属于分布式事务的范畴。但是对于读写分离，目前主流的做法是，事务中的所有sql统一都走主库，由于只涉及到一个库，本地事务就可以搞定。  
* 感知集群信息变更：如果访问的数据库集群信息变更了，例如主从切换了，写流量就要到新的主库上；又例如增加了从库数量，流量需要可以打到新的从库上；又或者某个从库延迟或者失败率比较高，应该将这个从库进行隔离，读流量尽量打到正常的从库上。  
* 运维：例如集群搭建、主从切换、从库扩容、缩容等。例如master配置了多个slave节点，如果其中某个slave节点挂了，那么之后的读请求，应用将其转发到正常工作的slave节点上。另外，如果新增了slave节点，应用也应该感知到，可以将读请求转发到新的slave节点上。  




