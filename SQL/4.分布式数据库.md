---
title: 分布式数据库
date: 2020-02-27 00:00:00
tags:
    - SQL
---
<!-- TOC -->

- [1. 数据库瓶颈](#1-数据库瓶颈)
- [2. 主从复制、读写分离](#2-主从复制读写分离)
    - [2.1. 主从复制拓扑结构](#21-主从复制拓扑结构)
    - [2.2. MySql主从复制原理](#22-mysql主从复制原理)
        - [2.2.1. 复制流程](#221-复制流程)
        - [2.2.2. 复制方式](#222-复制方式)
            - [2.2.2.1. 基于语句的复制](#2221-基于语句的复制)
            - [2.2.2.2. 基于行的复制](#2222-基于行的复制)
            - [2.2.2.3. 混合模式复制](#2223-混合模式复制)
- [3. 读写分离](#3-读写分离)
    - [3.1. 主从复制、读写分离带来的问题](#31-主从复制读写分离带来的问题)
- [4. 分区](#4-分区)
    - [4.1. 什么是分区](#41-什么是分区)
    - [4.2. 怎么分区](#42-怎么分区)
        - [4.2.1. 分区键：](#421-分区键)
        - [4.2.2. 分区路由（MySql分区类型）](#422-分区路由mysql分区类型)
    - [4.3. 管理分区（增、删分区）](#43-管理分区增删分区)
    - [4.4. 分区表使用](#44-分区表使用)
- [5. 分库/分片、分表](#5-分库分片分表)
    - [5.1. 数据切分方式](#51-数据切分方式)
        - [5.1.1. 垂直（纵向）切分](#511-垂直纵向切分)
        - [5.1.2. 水平（横向）切分](#512-水平横向切分)
    - [5.2. 分库分表方案（路由算法）](#52-分库分表方案路由算法)
    - [5.3. ~~分库分表带来的分布式困境与解决方案~~](#53-分库分表带来的分布式困境与解决方案)
        - [5.3.1. 分库数量](#531-分库数量)
        - [5.3.2. ID问题](#532-id问题)
        - [5.3.3. 基本的数据库增删改功能](#533-基本的数据库增删改功能)
        - [5.3.4. 查询功能](#534-查询功能)
            - [5.3.4.1. 跨节点的order by、group by以及count等聚合函数问题](#5341-跨节点的order-bygroup-by以及count等聚合函数问题)
            - [5.3.4.2. 跨分片的排序分页](#5342-跨分片的排序分页)
            - [5.3.4.3. 非partition key的查询问题](#5343-非partition-key的查询问题)
            - [5.3.4.4. 跨节点Join的问题](#5344-跨节点join的问题)
            - [5.3.4.5. 跨分片事务](#5345-跨分片事务)
            - [5.3.4.6. 数据迁移，容量规划，扩容等问题](#5346-数据迁移容量规划扩容等问题)
    - [5.4. 分表和分区的区别与联系](#54-分表和分区的区别与联系)
    - [5.5. 分库分表与读写分离](#55-分库分表与读写分离)
- [6. 数据库中间件](#6-数据库中间件)
    - [6.1. 设计方案](#61-设计方案)
        - [6.1.1. proxy模式](#611-proxy模式)
        - [6.1.2. smart-client模式](#612-smart-client模式)
    - [6.2. 业界产品](#62-业界产品)

<!-- /TOC -->

&emsp; 本文基于MySQL讲解。  

# 1. 数据库瓶颈  

&emsp; 不管是IO瓶颈，还是CPU瓶颈，最终都会导致数据库的活跃连接数增加，进而逼近甚至达到数据库可承载活跃连接数的阈值。在业务Service来看就是，可用数据库连接少甚至无连接可用。  
1. IO瓶颈：  
&emsp; 第一种：磁盘读IO瓶颈，热点数据太多，数据库缓存放不下，每次查询时会产生大量的IO，降低查询速度 -> 分库和垂直分表。  
&emsp; 第二种：网络IO瓶颈，请求的数据太多，网络带宽不够 -> 分库。  
2. CPU瓶颈：  
&emsp; 第一种：SQL问题，如SQL中包含join，group by，order by，非索引字段条件查询等，增加CPU运算的操作 -> SQL优化，建立合适的索引，在业务Service层进行业务计算。  
&emsp; 第二种：单表数据量太大，查询时扫描的行太多，SQL效率低，CPU率先出现瓶颈 -> 水平分表。  
&emsp; 根据业务特点，单表 > 分区 > 单库分表 > 分库分表，在满足业务前提下，优先级从左到右。  

&emsp; MySql一般并发数200～500。  
&emsp; 单表的数据量达到1000W或100G以后，性能下降严重。此时考虑对数据库切分。数据库拆分过程基本遵循的顺序是：1).垂直拆分（业务拆分）、2).读写分离、3).分库分表(水平拆分)。每个拆分过程都能解决业务上的一些问题，但同时也面临了一些挑战。  
&emsp; 数据库分布式核心内容是数据切分（Sharding），以及切分后对数据的定位、整合。数据切分就是将数据分散存储到多个数据库中，使得单一数据库中的数据量变小，通过扩充主机的数量缓解单一数据库的性能问题，从而达到提升数据库操作性能的目的。  




