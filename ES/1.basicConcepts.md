---
title: ES基本概念
date: 2020-06-08 00:00:00
tags:
    - Elasticsearch
---
<!-- TOC -->

- [1. ES基本概念](#1-es基本概念)
    - [1.1. ES数据架构](#11-es数据架构)
    - [1.2. ES数据类型](#12-es数据类型)
    - [1.3. 索引与检索](#13-索引与检索)
        - [1.3.1. Analyzer进行分词](#131-analyzer进行分词)
        - [1.3.2. 倒排索引](#132-倒排索引)
            - [1.3.2.1. 倒排索引是什么？](#1321-倒排索引是什么)
                - [1.3.2.1.1. 示例](#13211-示例)
                - [1.3.2.1.2. 核心组成](#13212-核心组成)
            - [1.3.2.2. 倒排索引是怎么工作的？](#1322-倒排索引是怎么工作的)
                - [1.3.2.2.1. 创建倒排索引](#13221-创建倒排索引)
                - [1.3.2.2.2. 倒排索引搜索](#13222-倒排索引搜索)

<!-- /TOC -->

# 1. ES基本概念  
&emsp; ES是elaticsearch简写， Elasticsearch是一个开源的高扩展的分布式全文检索引擎，它可以近乎实时的存储、检索数据；本身扩展性很好，可以扩展到上百台服务器，处理PB级别的数据。   

&emsp; 特点和优势：  

* 分布式实时文件存储，可将每一个字段存入索引，使其可以被检索到。  
* 近乎实时分析的分布式搜索引擎。   
* 分布式：索引分拆成多个分片，每个分片可有零个或多个副本。集群中的每个数据节点都可承载一个或多个分片，并且协调和处理各种操作；  
* 负载再平衡和路由在大多数情况下自动完成。   
* 可以扩展到上百台服务器，处理PB级别的结构化或非结构化数据（官网是这么说的）。也可以运行在单台PC上（已测试）。   
* 支持插件机制，分词插件、同步插件、Hadoop插件、可视化插件等。   

## 1.1. ES数据架构  


* 索引  
&emsp; ES将数据存储于一个或多个索引中，索引是具有类似特性的文档的集合。  
&emsp; 索引的元数据包含Mapping信息和Setting信息。Mapping 定义文档字段的类型；Setting 定义不同的数据分布。  

* 类型  
&emsp; 类型是索引内部的逻辑分区(category/partition)，然而其意义完全取决于用户需求。因此，一个索引内部可定义一个或多个类型(type)。一般来说，类型就是为那些拥有相同的域的文档做的预定义。  
&emsp; 注：在Elasticsearch 6.0.0或更高版本中创建的索引只能包含一个映射类型。在5.x中创建的具有多种映射类型的索引将继续像在Elasticsearch 6.x中一样工作。类型将在Elasticsearch 7.0.0中的API中弃用，并在8.0.0中完全删除。  

* 文档  
&emsp; 文档是可以建立索引的基本信息单元，是所有可搜索数据的最小单位。  
&emsp; 文档的元数据：  

  ```
  {
    "_index": "movies",   #文档所属的索引名称
    "_type": "_doc",      #文档所属的类型名称
    "_id": "288",         #文档唯一 ID
    "_version": 1,        #文档版本信息
    "_score": 0,          #相关性打分
    "_source": {          #文档的原始 Json 数据
    "year": 1994,         #字段year：字段值1994
    "id": "288",
    "title": "Natural",
    "@version": "1",
    "genre": [
      "Action",
      "Crime",
      "Thriller"
    ]
  }
  ```

* 映射  
&emsp; 映射是定义文档及其包含的字段如何存储和索引的过程。例如，使用映射来定义：  
  * 哪些字符串字段应该被视为全文字段。
  * 哪些字段包含数字、日期或地理位置。
  * 文档中所有字段的值是否应该被索引到catch-all _all字段中。
  * 日期值的格式。
  * 用于控制动态添加字段的映射的自定义规则。

&emsp; <font color = "red">每个索引都有一个映射类型，它决定了文档的索引方式。</font>  

&emsp; ***与mysql的对比***  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/ES/es-2.png)  

## 1.2. ES数据类型  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/ES/es-1.png)  

## 1.3. 索引与检索  
&emsp; 在全文检索中，分为索引(录入)与检索(查询)两部分，索引部分包含 分词器、过滤器、字符映射器等，检索部分包含 查询解析器 等。  

### 1.3.1. Analyzer进行分词
&emsp; Analysis：即文本分析，是把全文本转化为一系列单词（term/token）的过程，也叫分词；在Elasticsearch 中可通过内置分词器实现分词，也可以按需定制分词器。Elasticsearch中的内置分词器：  

* Standard Analyzer：默认分词器，按词切分，小写处理  
* Simple Analyzer：按照非字母切分(符号被过滤)，小写处理  
* Stop Analyzer：小写处理，停用词过滤(the, a, is)  
* Whitespace Analyzer：按照空格切分，不转小写  
* Keyword Analyzer：不分词，直接将输入当做输出  
* Patter Analyzer：正则表达式，默认 \W+ (非字符分割)  
* Language：提供了30多种常见语言的分词器  
* Customer Analyzer：自定义分词器  

&emsp; ***Analyzer由三部分组成：***  

* Character Filters：原始文本处理，如去除 html  
* Tokenizer：按照规则切分为单词  
* Token Filters：对切分单词加工、小写、删除 stopwords，增加同义词  

&emsp; ***Analyzer分词过程简介***  
1. 字符过滤器  character filter  
&emsp; 首先，字符串按顺序通过每个字符过滤器 。它们的任务是在分词前整理字符串。一个字符过滤器可以用来去掉HTML，或者将 & 转化成 and。  
2. 分词器 tokenizer  
&emsp; 其次，字符串被 分词器 分为单个的词条。一个 whitespace的分词器遇到空格和标点的时候，可能会将文本拆分成词条。  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/ES/es-3.png)  
3. 令牌过滤器token filter  
&emsp; 最后，词条按顺序通过每个 token 过滤器 。这个过程可能会改变词条，例如，lowercase token filter  小写化（将ES转为es）、stop token filter 删除词条（例如， 像 a， and， the 等无用词），或者synonym token filter 增加词条（例如，像 jump 和 leap 这种同义词）。  

### 1.3.2. 倒排索引  
&emsp; <font color = "red">倒排索引是 Elasticsearch 中非常重要的索引结构，是从文档单词到文档 ID 的映射过程。</font>  

#### 1.3.2.1. 倒排索引是什么？  
##### 1.3.2.1.1. 示例  
&emsp; 例如，针对专栏文章，平时在各大平台根据关键词检索时，使用到的技术就有“倒排序索引”。  

|ID	|作者	|文章题目	|内容|
|---|---|---|---|
|1	|wt	|系统学习es|	系统学习es，倒排序索引|
|2	|wt	|学习mysql	|学习mysql，正向索引|

&emsp; 假设文章的储存结果如上，对于关系型数据库mysql来说，普通的索引结构就是“id->题目->内容”，在搜索的时候，如果知道id或者题目，那么检索效率是很高效的，因为“id”、“题目”是很方便创建索引的。  

&emsp; ***正向索引***  

|索引	|内容|
|---|---|
|1	|系统学习es，倒排序索引|
|系统学习es	|系统学习es，倒排序索引|
|2	|学习mysql，正向索引|
|学习mysql	|学习mysql，正向索引|

&emsp; 但是当只有一个检索关键词，比如需求是搜索到与“倒排序索引”相关的文章时，在索引结构是“id->题目->内容”时，就只能对“题目”和“内容”进行全文扫描了，当数量级上去后，效率是没办法接受的！对于这类的搜索，关系型数据库的索引就很难应付了，适合使用全文搜索的倒排索引。  
&emsp; 那么倒排序索引的结构是怎样的呢？简单来讲就是<font color="red">“以内容的关键词”建立索引，映射关系为“内容的关键词->ID”。这样只需要在“关键词”中进行检索，效率肯定更快。</font>  

&emsp; ***倒排序索引***  

|Token	|文档id=1	|文档id=2|
|---|---|---|
|系统	|true|	|
|学习	|true	|true|
|es	|true|	|
|mysql	|	|true|
|倒排序	|true|	|
|正向	|	|true|
|索引|	true|	true|

##### 1.3.2.1.2. 核心组成  
&emsp; ***<font color = "red">倒排序索引包含两个部分：</font>***  

* 单词词典：记录所有文档单词，记录单词到倒排列表的关联关系。
* 倒排列表：记录单词与对应文档结合，由倒排索引项组成。  
&emsp; 倒排索引项：  
  * 文档   
  * 词频 TF - 单词在文档中出现的次数，用于相关性评分  
  * 位置（Position）- 单词在文档中分词的位置，用于phrase query  
  * 偏移（Offset）- 记录单词开始结束的位置，实现高亮显示  

&emsp; 举个简单例子，理解下“倒排索引项”：以 Token“学习”为例：  

  |单词	|doc Id 	|TF	|Position	|Offset|
  |---|---|---|---|---|
  |学习|	1|	1|	1|	<2,4>|
  |学习|	2|	1|	0|	<0,2>|

#### 1.3.2.2. 倒排索引是怎么工作的？  
&emsp; ***<font color = "red">倒排索引的工作流程主要包括2个过程：</font>***  
1. 创建倒排索引；  
2. 倒排索引搜索；  

##### 1.3.2.2.1. 创建倒排索引  
&emsp; 还是使用上面的例子。先对文档的内容进行分词，形成一个个的 token，也就是 单词，然后保存这些 token 与文档的对应关系。结果如下：  
&emsp; ***倒排序索引***  

|Token	|文档id=1	|文档id=2|
|---|---|---|
|系统	|true|	|
|学习|	true|	true|
|es	|true|	|
|mysql|		|true|
|倒排序	|true|	|
|正向|		|true|
|索引	|true	|true|


##### 1.3.2.2.2. 倒排索引搜索   

&emsp; 搜索示例1：“学习索引”  
&emsp; 先分词，得到两个Token：“学习”、“索引”  
&emsp; 然后去倒排索引中进行匹配  
&emsp; 这2个Token在2个文档中都匹配，所以2个文档都会返回，而且分数相同。  

&emsp; 搜索示例2：“学习es”  
&emsp; 同样，2个文档都匹配，都会返回。但是文档1的相关性评分会高于文档2，因为文档1匹配了两个Token，而文档2只匹配了一个Token【学习】。  


