# DNS  
&emsp; 访问网站的时候会输入域名，而在真实网络中主机通信是通过IP地址进行通信的。  
&emsp; DNS，英文全写为Domain Name System，中文意思为域名系统，是互联网中提供域名与IP地址互相映射的分布式数据库。DNS 运行在 UDP 上，使用 53 端口。  
## DNS域名的层次结构  
&emsp; 由于因特网的用户数量较多，所以因特网在命名时采用的是层次树状结构的命名方法。任何一个连接在因特网上的主机或路由器，都有一个唯一的层次结构的名字，即域名(domain name)。这里，“域”(domain)是名字空间中一个可被管理的划分。  
&emsp; DNS的域名树由根域，顶级域，二级域及其子域构成，其结构图与示例如下：  
![avatar](https://raw.githubusercontent.com/wt1814/wt1814.github.io/master/images/network/DNS-1.png)  
&emsp; 根域，由互联网网络信息中心(InterNIC)负责管理，用点“.”表示，无名称，是域名系统中的最高级别域，标准域名结尾应包含根域“.”，但实际使用中该根域都是省略的，所以大家常见的网址末尾并没有“.”。  
&emsp; 顶级域(Top-Level Domains = TLD)，隶属于根域，是仅次于根域的下一级域，顶级域名TLD分为三大类：  
&emsp; &emsp; (1)国家顶级域名nTLD：采用ISO3166的规定。如：cn代表中国，us代表美国，uk代表英国，等等。国家域名又常记为ccTLD(cc表示国家代码contry-code)。  
&emsp; &emsp; (2)通用顶级域名gTLD：最常见的通用顶级域名有7个，即：com(公司企业)，net(网络服务机构)，org(非营利组织)，int(国际组织)，gov(美国的政府部门)，mil(美国的军事部门)。  
&emsp; &emsp; (3)基础结构域名(infrastructure domain)：这种顶级域名只有一个，即arpa，用于反向域名解析，因此称为反向域名。  
&emsp; 二级域，正式给组织和个人注册使用的唯一名称，如亚马逊、IBM，微软的官方网址(头条不能带网址)中的字眼“amazon”“ibm”“microsoft”就是这些企业注册的二级域名。  
&emsp; 二级域以下子域，在二级域中的组织机构可以根据需要来进一步划分子域，如销售部门用sale子域名，业务部门用business子域名等。  
## 域名服务器
&emsp; 域名服务器的层次结构主要是以上域名层次树状结构。  
&emsp; 1). 除此之外，还有另一类重要的 DNS 服务器，它是 本地 DNS 服务器(local DNS server)。严格来说，本地 DNS 服务器并不属于上述层次结构，但是本地 DNS 服务器又是至关重要的。每个 ISP(Internet Service Provider) 比如居民区的 ISP 或者一个机构的 ISP 都有一台本地 DNS 服务器。当主机和 ISP 进行连接时，该 ISP 会提供一台主机的 IP 地址，该主机会具有一台或多台其本地 DNS 服务器的 IP地址。通过访问网络连接，用户能够容易的确定 DNS 服务器的 IP地址。当主机发出 DNS 请求后，该请求被发往本地 DNS 服务器，它起着代理的作用，并将该请求转发到 DNS 服务器层次系统中。  
&emsp; 2). 除了域名服务器之外，DNS也有本地缓存：电脑会将解析到的域名和 IP 地址等缓存到本地上，windows 可以通过 ipconfig /displaydns 查看。  
## DNS解析流程   
&emsp; 当用户在地址栏键入www.baidu.com并敲下回车键之后，域名解析就开始了。  
&emsp; 1. 检查浏览器缓存中是否缓存过该域名对应的IP地址。  
&emsp; &emsp; 用户通过浏览器浏览过某网站之后，浏览器就会自动缓存该网站域名对应的IP地址，当用户再次访问的时候，浏览器就会从缓存中查找该域名对应的IP地址，因为缓存不仅是有大小限制，而且还有时间限制（域名被缓存的时间通过TTL属性来设置），所以存在域名对应的IP找不到的情况。当浏览器从缓存中找到了该网站域名对应的IP地址，那么整个DNS解析过程结束，如果没有找到，将进行下一步骤。  
&emsp; 2. 如果在浏览器缓存中没有找到IP，那么将继续查找本机系统是否缓存过IP。  
&emsp; 如果第一个步骤没有完成对域名的解析过程，那么浏览器会去系统缓存中查找系统是否缓存过这个域名对应的IP地址，也可以理解为系统自己也具备域名解析的基本能力。在Windows系统中，可以通过设置hosts文件来将域名手动绑定到某IP上，hosts文件位置在C:\Windows\System32\drivers\etc\hosts。对于普通用户，并不推荐自己手动绑定域名和IP，对于开发者来说，通过绑定域名和IP，可以轻松切换环境，可以从测试环境切换到开发环境，方便开发和测试。  
&emsp; ***前两步都是在本机上完成的，从第三步开始，才向远程DNS服务器发起解析域名的请求。***  
&emsp; 3. 向本地域名解析服务系统发起域名解析的请求  
&emsp; 如果在本机上无法完成域名的解析，那么系统只能请求本地域名解析服务系统进行解析，本地域名系统LDNS一般都是本地区的域名服务器，比如连接的校园网，那么域名解析系统就在校园机房里，如果连接的是电信、移动或者联通的网络，那么本地域名解析服务器就在本地区，由各自的运营商来提供服务。对于本地DNS服务器地址，Windows系统使用命令ipconfig就可以查看，在Linux和Mac系统下，直接使用命令cat /etc/resolv.conf来查看LDNS服务地址。LDNS一般都缓存了大部分的域名解析的结果，当然缓存时间也受域名失效时间控制，大部分的解析工作到这里就差不多已经结束了，LDNS负责了大部分的解析工作。  
&emsp; 4. 本地域名解析服务器向根域名解析服务器发起域名解析请求  
&emsp; 如果主机所询问的本地域名服务器不知道被查询的域名的IP地址，那么本地域名服务器就以DNS客户的身份，向其它根域名服务器继续发出查询请求报文(即替主机继续查询)，而不是让主机自己进行下一步查询。  
&emsp; 此时，DNS 涉及两种查询方式：一种是递归查询(Recursive query) ，一种是迭代查询(Iteration query)。递归查询和迭代查询的区别：  
* 如果根域名服务器无法告知本地 DNS 服务器下一步需要访问哪个顶级域名服务器，就会使用递归查询；  
* 如果根域名服务器能够告知 DNS 服务器下一步需要访问的顶级域名服务器，就会使用迭代查询。  

&emsp; 递归查询：  
![avatar](../images/network/DNS-2.png)  
&emsp; 迭代查询：  
![avatar](../images/network/DNS-3.png)  
&emsp; 当根域名服务器收到本地域名服务器发出的迭代查询请求报文时，要么给出所要查询的IP地址，要么告诉本地服务器：“下一步应当向哪一个域名服务器进行查询”。然后让本地域名服务器进行后续的查询。根域名服务器通常是把自己知道的顶级域名服务器的IP地址告诉本地域名服务器，让本地域名服务器再向顶级域名服务器查询。顶级域名服务器在收到本地域名服务器的查询请求后，要么给出所要查询的IP地址，要么告诉本地服务器下一步应当向哪一个权限域名服务器进行查询。最后，知道了所要解析的IP地址或报错，然后把这个结果返回给发起查询的本地域名服务器，返回给主机。  
&emsp; 5. 返回解析结果给用户  
&emsp; 解析结果将直接返回给用户，用户系统将缓存该IP地址，缓存时间由TTL来控制，至此，解析过程结束。  
&emsp; 注意：DNS 服务器解析后可以返回多个对应的主机 IP 地址，那么客户端访问的时候可以通过随机或者轮询等访问做简单的负载均衡处理。  
