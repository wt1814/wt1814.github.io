---
title: HTTPS
date: 2020-04-21 00:00:00
tags:
    - 计算机网络
---

<!-- TOC -->

- [1. HTTPS](#1-https)
    - [1.1. SSL/TLS](#11-ssltls)
        - [1.1.1. SSL的体系结构](#111-ssl的体系结构)
        - [1.1.2. SSL证书](#112-ssl证书)
            - [1.1.2.1. 为什么需要 CA 认证机构颁发证书？](#1121-为什么需要-ca-认证机构颁发证书)
            - [1.1.2.2. SSL证书类型：](#1122-ssl证书类型)
            - [1.1.2.3. SSL证书存放位置：](#1123-ssl证书存放位置)
    - [1.2. ※※※HTTPS工作原理](#12-※※※https工作原理)
    - [1.3. 用了 HTTPS 会被抓包吗？](#13-用了-https-会被抓包吗)
    - [1.4. HTTP和HTTPS的区别：](#14-http和https的区别)

<!-- /TOC -->

# 1. HTTPS  
&emsp; HTTPS (Secure Hypertext Transfer Protocol)安全超文本传输协议，是一个安全通信通道，它基于HTTP开发用于在客户计算机和服务器之间交换信息。它使用安全套接字层(SSL)进行信息交换，简单来说它是HTTP的安全版，是使用TLS/SSL加密的HTTP协议。HTTP协议采用明文传输信息，存在信息窃听、信息篡改和信息劫持的风险，而协议TLS/SSL具有身份验证、信息加密和完整性校验的功能，可以避免此类问题发生。  

---
## 1.1. SSL/TLS  
&emsp; SSL(Secure Sockets Layer 安全套接层)，及其继任者传输层安全(Transport Layer Security，TLS)是为网络通信提供安全及数据完整性的一种安全协议。TLS/SSL在传输层与应用层之间对网络连接进行加密。  
&emsp; TLS/SSL是介于TCP和HTTP之间的一层安全协议，不影响原有的TCP协议和HTTP协议，所以使用HTTPS基本上不需要对HTTP页面进行太多的改造。  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/network/https-1.png)  
&emsp; SSL协议提供的服务主要有  
1. 认证用户和服务器，确保数据发送到正确的客户机和服务器  
2. 加密数据以防止数据中途被窃取  
3. 维护数据的完整性，确保数据在传输过程中不被改变。  

### 1.1.1. SSL的体系结构  
&emsp; SSL的体系结构中包含两个协议子层，其中底层是SSL记录协议层（SSL Record Protocol Layer）；高层是SSL握手协议层（SSL HandShake Protocol Layer）。SSL的协议栈如图所示，其中阴影部分即SSL协议。  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/network/https-2.png)  
&emsp; SSL记录协议层的作用是为高层协议提供基本的安全服务。SSL记录协议针对HTTP协议进行了特别的设计，使得超文本的传输协议HTTP能够在SSL运行。纪录封装各种高层协议，具体实施压缩解压缩、加密解密、计算和校验MAC等与安全有关的操作。  
&emsp; SSL握手协议层包括SSL握手协议（SSL HandShake Protocol）、SSL密码参数修改协议（SSL Change Cipher Spec Protocol）、应用数据协议（Application Data Protocol）和SSL告警协议（SSL Alert Protocol）。握手层的这些协议用于SSL管理信息的交换，允许应用协议传送数据之间相互验证，协商加密算法和生成密钥等。SSL握手协议的作用是协调客户和服务器的状态，使双方能够达到状态的同步。  

### 1.1.2. SSL证书  
#### 1.1.2.1. 为什么需要 CA 认证机构颁发证书？  
&emsp; 为了防止中间人攻击  
&emsp; .......

#### 1.1.2.2. SSL证书类型：  
&emsp; SSL证书根据可信强度，大概可以分为：域名型证书(DV SSL)、企业型证书(OV SSL)、增强型证书(EV SSL)三种。现在所说的免费SSL证书都是最低级别的DV SSL证书。  

#### 1.1.2.3. SSL证书存放位置：  
&emsp; 服务端通常会将SSL证书存储在Nginx、Apache这些反向代理服务器中，进行https加密。  
&emsp; 客户端会将SSL证书直接内置在各大操作系统(或者浏览器)的出厂设置里。  

------------------------------------------
## 1.2. ※※※HTTPS工作原理  
&emsp; HTTPS的整体过程分为证书验证和数据传输阶段。证书验证使用公开私有密钥进行非对称加密；数据传输使用共享密钥进行对称加密。具体的交互过程如下：  
![image](https://gitee.com/wt1814/pic-host/raw/master/images/network/https-3.png)  

&emsp; ***证书验证阶段：***  
1. 客户端发起HTTPS请求：浏览器将支持的加密算法信息发送给服务器；  
2. 服务端返回HTTPS证书：服务器选择一套浏览器支持的加密算法，以证书的形式回发浏览器；  
&emsp; &emsp; 注：采用HTTPS协议的服务器必须要有一套数字证书，可以自己制作，也可以向组织申请。区别就是自己颁发的证书需要客户端验证通过，才可以继续访问，而使用受信任的公司申请的证书则不会弹出提示页面。这套证书其实就是一对公钥和私钥。传送证书时，只传送证书的公钥。  
3. 客户端解析证书：客户端对证书的有效期、合法性、域名是否与请求的域名一致、证书的公钥等进行校验。首先会验证公钥是否有效，比如颁发机构，过期时间等等，如果发现异常，则会弹出一个警告框，提示证书存在问题。  
&emsp; ***数据传输阶段：***  
4. 如果证书没有问题，客户端生成一个随即值（对称密钥）。然后用证书的公共密钥对该随机值（对称密钥）进行加密。  
5. 客户端传送加密信息，这部分传送的是用证书加密后的随机值，目的就是让服务端得到这个随机值，以后客户端和服务端的通信就可以通过这个随机值来进行加密解密。  
&emsp; 注：权威机构的证书的公钥等信息直接内置在各大操作系统(或者浏览器)的出厂设置里；非权威机构的证书需要手动安装。  
6. 服务端解密信息、传输加密后的信息：服务器使用私钥解密信息，验证哈希，加密响应消息回发浏览器；  
7. 客户端解密信息：浏览器解密响应消息，并对消息进行验真，之后进行加密交互数据；  

------------------------------------------
## 1.3. 用了 HTTPS 会被抓包吗？
&emsp; HTTPS 的数据是加密的，常规下抓包工具代理请求后抓到的包内容是加密状态，无法直接查看。  
&emsp; 但是，正如前文所说，浏览器只会提示安全风险，如果用户授权仍然可以继续访问网站，完成请求。因此，只要客户端是自己的终端，授权的情况下，便可以组建中间人网络，而抓包工具便是作为中间人的代理。通常HTTPS抓包工具的使用方法是会生成一个证书，用户需要手动把证书安装到客户端中，然后终端发起的所有请求通过该证书完成与抓包工具的交互，然后抓包工具再转发请求到服务器，最后把服务器返回的结果在控制台输出后再返回给终端，从而完成整个请求的闭环。  
&emsp; 既然HTTPS不能防抓包，那 HTTPS 有什么意义？HTTPS 可以防止用户在不知情的情况下通信链路被监听，对于主动授信的抓包操作是不提供防护的，因为这个场景用户是已经对风险知情。要防止被抓包，需要采用应用级的安全防护，例如采用私有的对称加密，同时做好移动端的防反编译加固，防止本地算法被破解。  

------------------------------------------
## 1.4. HTTP和HTTPS的区别：  
1. http是超文本传输协议，信息是明文传输，https则是具有安全性的ssl加密传输协议。  
2. https协议需要CA证书。  
3. http和https使用的是完全不同的连接方式，用的端口也不一样，前者是80，后者是443。  

